<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<title>ãƒŸãƒ©ã¾ã‚‹ï¼†ãƒãƒ£ãƒ¼ã™ã‘ã®EVã‚¨ãƒŠã‚¸ãƒ¼ãƒ©ãƒ³</title>
<style>
html,body{
margin:0;
background:#fff;
overflow:hidden;
height:100dvh;

/* â­ä¸­å¤®å›ºå®šï¼ˆã“ã“ã«å…¥ã‚Œã‚‹ï¼‰ */
display:flex;
align-items:center;
justify-content:center;

font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;
}

canvas{
display:block;
margin:0;
background:#fff;
touch-action:manipulation;

/* â­ç¸¦æ¨ªã©ã£ã¡ã§ã‚‚åã¾ã‚‹ã‚µã‚¤ã‚º */
width:min(100vw, calc(100dvh * (960/540)));
height:auto;
}



  /* ===== æ¼”å‡º ===== */
  .flash{
    position:fixed; inset:0;
    background:rgba(255,0,0,.28);
    opacity:0; pointer-events:none;
    transition:opacity .15s;
    z-index:20;
  }
  .flash.show{ opacity:1; }

  .fever{
    position:fixed; inset:0;
    opacity:0; pointer-events:none;
    z-index:15;
    background: linear-gradient(
      120deg,
      rgba(255,0,0,.24),
      rgba(255,255,0,.22),
      rgba(0,255,0,.20),
      rgba(0,255,255,.20),
      rgba(0,0,255,.20),
      rgba(255,0,255,.22)
    );
    background-size: 300% 300%;
    animation: rainbowMove 3.6s ease-in-out infinite;
    transition: opacity .25s ease;
  }
  .fever.show{ opacity:1; }
  @keyframes rainbowMove{
    0%{ background-position:0% 50%; }
    50%{ background-position:100% 50%; }
    100%{ background-position:0% 50%; }
  }

  /* ===== HUD ===== */
  .hud{
    position:fixed; left:12px; top:12px;
    display:none; gap:8px; flex-wrap:wrap;
    z-index:25;
    user-select:none;
  }
  .hud.show{ display:flex; }

  .pill{
    background:rgba(255,255,255,.86);
    backdrop-filter: blur(4px);
    border:1px solid rgba(0,0,0,.08);
    border-radius:999px;
    padding:8px 10px;
    font-size:13px;
    font-weight:900;
    color:#111;
    display:flex; align-items:center; gap:8px;
  }
  .tiny{ font-size:12px; color:#333; font-weight:900; }

  .feverBadge{
    display:none;
    animation: pulse .8s ease-in-out infinite;
  }
  .feverBadge.on{ display:flex; }
  @keyframes pulse{ 0%,100%{transform:scale(1);} 50%{transform:scale(1.06);} }

  .hp-pop{ animation: hpPop .28s ease; }
  @keyframes hpPop{ 0%{transform:scale(1);} 50%{transform:scale(1.35);} 100%{transform:scale(1);} }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
  .loading{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:#fff;
    z-index:50;
    color:#111;
    font-weight:900;
  }
</style>
</head>

<body>
<canvas id="game" width="960" height="540"></canvas>

<div class="flash" id="damageFlash"></div>
<div class="fever" id="feverLayer"></div>

<div class="hud" id="hud">
  <div class="pill">æ®‹ã‚Š <span id="timeTxt">30.0</span>s</div>
  <div class="pill">âš¡ <span id="scoreTxt">0</span></div>
  <div class="pill" id="hpPill">ğŸ”‹ <span id="hpTxt">ğŸ”‹ğŸ”‹ğŸ”‹</span></div>
  <div class="pill tiny" id="statusTxt">çŠ¶æ…‹ï¼šé€šå¸¸</div>
  <div class="pill feverBadge" id="feverBadge">ğŸŒˆ FEVER</div>
</div>

<div class="loading" id="loading">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<script>
/* =========================================================
  0) çŠ¶æ…‹ï¼ˆç”»é¢é·ç§»ï¼‰
  éŸ³ã‚ã‚Š/ãªã— â†’ ã‚³ãƒ¼ã‚¹é¸æŠ â†’ ã‚¹ã‚¿ãƒ¼ãƒˆ â†’ ã‚²ãƒ¼ãƒ  â†’ çµæœ
========================================================= */
const STATE = {
  SOUND: "sound",
  COURSE: "course",
  START: "start",
  GAME: "game",
  END: "end"
};

// â­â†“â†“â†“â†“ ã“ã“ã«è¿½åŠ  â†“â†“â†“â†“
const BTN = {

  // ã‚¹ãƒãƒ›ç¸¦ ENDç”»é¢
  end_retry_sp : { x1:0.2, x2:0.8, y1:0.55, y2:0.7 },
  end_exit_sp  : { x1:0.2, x2:0.8, y1:0.72, y2:0.9 },

  // PCæ¨ª ENDç”»é¢
  end_retry_pc : { x1:140/960, x2:460/960, y1:340/540, y2:460/540 },
  end_exit_pc  : { x1:500/960, x2:820/960, y1:340/540, y2:460/540 },

};

let state = STATE.SOUND;
let soundOn = true;
let mode = null; // "ch" | "mm"

/* =========================================================
  1) UIç”»åƒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åï¼‰
========================================================= */
const UI_SRC = {
  sound:  "ui_sound_select.png",
  sound_sp: "ui_sound_select_sp.png",

  course: "ui_course_select.png",
  course_sp: "ui_course_select_sp.png",

  start:  "ui_start.png",
  start_sp: "ui_start_sp.png",

  clear:  "ui_game_clear.png",
  clear_sp: "ui_game_clear_sp.png",

  over:   "ui_game_over.png",
  over_sp: "ui_game_over_sp.png"
};

const UI = {};

/* =========================================================
  2) ã‚²ãƒ¼ãƒ ç”¨ã‚¢ã‚»ãƒƒãƒˆï¼ˆç”»åƒï¼‰
========================================================= */
const ASSET = {
  bg: "background.jpg",
  bg_sp: "background_sp.jpg",

  ui_jump: "ui_jump.png",

  event_fever: "ch_event_fever.png",

  // ã‚­ãƒ£ãƒ©
  ch_player: "ch_character.png",
  mm_player: "mm_character.png",

  // å…±é€šï¼ˆâš¡ï¼‰
  lightning: "ch_item_lightning.png",
  lightningBig: "ch_item_lightning_big.png",

  // ch ã‚¢ã‚¤ãƒ†ãƒ 
  ch_repair: "ch_item_repair.png",
  ch_map: "ch_item_map.png",
  ch_compass: "ch_item_compass.png",
  ch_station: "ch_item_station.png",
  ch_curry: "ch_item_curry.png",

  // mm ã‚¢ã‚¤ãƒ†ãƒ 
  mm_onigiri: "mm_item_onigiri.png",
  mm_dango: "mm_item_dango.png",
  mm_senbei: "mm_item_senbei.png",
  mm_tea: "mm_item_tea.png",

  // æ•µ
  pitfall: "ch_enemy_pitfall.png",
  construction: "ch_enemy_construction.png",
  traffic: "ch_enemy_traffic.png",
  trouble: "ch_enemy_trouble.png"
};

const MODE = {
  ch: {
    name: "ğŸ¶ ãƒãƒ£ãƒ¼ã™ã‘ã‚³ãƒ¼ã‚¹",
    desc: "ğŸ› /â›½ã§å›å¾©ã€ğŸ›ã§åŠ é€Ÿã€ğŸ—ºã§å…ˆèª­ã¿ã€ğŸ§­ã§æ•µDOWNã€‚30ç§’ã§âš¡ã‚’é›†ã‚ã‚ˆã†ï¼",
    playerKey: "ch_player",
    itemEvery: ["ch_repair","ch_map","ch_compass"],
    itemRare5: ["ch_station","ch_curry"],
    bgm: "bgm_ch_game.mp3"
  },
  mm: {
    name: "ğŸ± ãƒŸãƒ©ã¾ã‚‹ã‚³ãƒ¼ã‚¹",
    desc: "ğŸ™ã§å›å¾©ã€ğŸ¡ã§åŠ é€Ÿã€ğŸµã§æ•µDOWNã€ğŸ˜ã§ãƒ€ãƒ¡ãƒ¼ã‚¸ç„¡åŠ¹1å›ã€‚30ç§’ã§âš¡ã‚’é›†ã‚ã‚ˆã†ï¼",
    playerKey: "mm_player",
    itemEvery: ["mm_onigiri","mm_dango"],
    itemRare5: ["mm_senbei","mm_tea"],
    bgm: "bgm_mm_game.mp3"
  }
};
const RESULT_BGM = {
  ch: {
    clear: "bgm_ch_clear.mp3",
    over:  "bgm_ch_over.mp3"
  },
  mm: {
    clear: "bgm_mm_clear.mp3",
    over:  "bgm_mm_over.mp3"
  }
};


/* =========================================================
  3) éŸ³æºï¼ˆSEï¼‰
  â€»ã‚ãªãŸã®æŒ‡å®šã‚’ãã®ã¾ã¾åæ˜ 
========================================================= */
const SE_SRC = {
  // æ“ä½œ
  jump: "se_jump.mp3",

  // å–å¾—
  lightning: "se_get_lightning.mp3",                 // âš¡
  itemCommon: "GB-Action01-09(Item).mp3",            // ğŸ™ğŸ˜ğŸ—ºğŸ§­ ãªã©
  itemRare: "NES-Action01-12(Item).mp3",             // ğŸ›ğŸµ
  
  // è¢«å¼¾
  hitConstruction: "SNES-Action01-13(Defeat).mp3",   // å·¥äº‹ä¸­
  hitPitfall: "GB-Action01-06(Miss).mp3",            // ç©´
  hitTraffic: "Car_Horn-Fake03-1.mp3",               // ğŸš—
  hitTrouble: "SNES-Action01-13(Defeat).mp3",        // ğŸ’¥ï¼ˆæŒ‡å®šãªã—ãªã®ã§å·¥äº‹ã¨åŒç³»çµ±ã§ï¼‰
  
  // çµæœï¼ˆæŒ‡å®šãŒãªã„ã®ã§ã€å¿…è¦ãªã‚‰å·®ã—æ›¿ãˆã¦OKï¼‰
  clear: "NES-Action01-12(Item).mp3",
  gameover: "SNES-Action01-13(Defeat).mp3"
};

/* =========================================================
  4) Canvas / DOM
========================================================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.style.touchAction = "none"; // â†1å›ã ã‘ã§OK


// â­ã‚¹ãƒãƒ›ç¸¦æ¨ªãƒ•ã‚£ãƒƒãƒˆï¼ˆè¦‹åˆ‡ã‚Œé˜²æ­¢ï¼‰
function isMobile(){
  return window.innerWidth < 768;
}

function fitCanvas(){

  let baseW;
  let baseH;

  // â­ã‚¹ãƒãƒ›ã¯ç¸¦ç”»é¢
  if(isMobile()){
    baseW = 540;
    baseH = 960;
  }else{
    // â­PCã¯æ¨ªç”»é¢
    baseW = 960;
    baseH = 540;
  }

  // Canvaså†…éƒ¨ã‚µã‚¤ã‚º
  canvas.width  = baseW;
  canvas.height = baseH;

  // åœ°é¢ä½ç½®
  groundY = canvas.height - (isMobile()?300:200);

  const vw = window.innerWidth;
  const vh = window.innerHeight;

  const scale = Math.min(vw/baseW, vh/baseH);

  if(isMobile()){
  canvas.style.width  = window.innerWidth + "px";
ã€€canvas.style.height = window.innerHeight + "px";

}else{
  canvas.style.width  = (baseW * scale) + "px";
  canvas.style.height = (baseH * scale) + "px";
}
}






window.addEventListener("resize", fitCanvas);
window.addEventListener("orientationchange", fitCanvas);
window.addEventListener("load", fitCanvas); // â†è¿½åŠ 

fitCanvas();


const loadingEl = document.getElementById("loading");

const hud         = document.getElementById("hud");
const damageFlash = document.getElementById("damageFlash");
const feverLayer  = document.getElementById("feverLayer");
const feverBadge  = document.getElementById("feverBadge");

const timeTxt   = document.getElementById("timeTxt");
const scoreTxt  = document.getElementById("scoreTxt");
const hpTxt     = document.getElementById("hpTxt");
const hpPill    = document.getElementById("hpPill");
const statusTxt = document.getElementById("statusTxt");

/* =========================================================
  5) ç”»åƒãƒ­ãƒ¼ãƒ‰
========================================================= */
function loadOneImage(src){
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>resolve({ok:true, img});
    img.onerror = ()=>resolve({ok:false, img:null});
    img.src = src;
  });
}

let I = {}; // game images

/* =========================================================
  6) éŸ³ï¼ˆBGM/SEï¼‰
========================================================= */
let bgm = null;
let feverBgm = null;
let normalBgmSrc = null;
let audioUnlocked = false;
let audioCtx = null;


function stopBgm(){

  // â­é€šå¸¸BGMåœæ­¢
  if(bgm){
    try{
      bgm.pause();
      bgm.currentTime = 0;
      bgm.src = "";
      bgm.removeAttribute("src");
      bgm.load();
    }catch(e){}
  }

  // â­ãƒ•ã‚£ãƒ¼ãƒãƒ¼BGMã‚‚åœæ­¢ï¼ˆâ†ã“ã‚Œè¶…é‡è¦ï¼‰
  if(feverBgm){
    try{
      feverBgm.pause();
      feverBgm.currentTime = 0;
      feverBgm.src = "";
      feverBgm.removeAttribute("src");
      feverBgm.load();
    }catch(e){}
  }

  bgm = null;
  feverBgm = null;
  normalBgmSrc = null;
}





function playBgm(src, loop=true){

  if(!soundOn) return;

  // â­ PCã§ã‚‚éŸ³å‡ºã‚‹ã‚ˆã†ã«
  if(audioCtx){
    try{ audioCtx.resume(); }catch(e){}
  }

  stopBgm();

  normalBgmSrc = src;

  bgm = new Audio();

  bgm.src = src;
  bgm.loop = loop;
  bgm.volume = 0.6;
  bgm.preload = "auto";

  bgm.playsInline = true;
  bgm.setAttribute("playsinline","");
  bgm.setAttribute("webkit-playsinline","");

  const p = bgm.play();
  if(p && p.catch) p.catch(()=>{});
}


// iOS/Safariå¯¾ç­–ï¼šæœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
function unlockAudioOnce(){

  if(audioUnlocked) return;
  audioUnlocked = true;

  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    audioCtx.resume();
  }catch(e){}

  // â­â­â­ iPhoneéŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
  try{
    const unlock = new Audio("se_jump.mp3"); // â†å¿…ãšå­˜åœ¨ã™ã‚‹éŸ³
    unlock.volume = 0;
    unlock.playsInline = true;
    unlock.setAttribute("playsinline","");
    unlock.setAttribute("webkit-playsinline","");

    const p = unlock.play();
    if(p && p.catch) p.catch(()=>{});

    setTimeout(()=>{
      unlock.pause();
    },60);

  }catch(e){}
}







// SEã¯å¤šé‡å†ç”Ÿã§ãã‚‹ã‚ˆã†ã«cloneã—ã¦é³´ã‚‰ã™
function inFeverNow(){
  return performance.now() < feverUntil;
}

const sePool = {};

function playSE(key){
  if(!soundOn) return;

  const src = SE_SRC[key];
  if(!src) return;

  // åˆå›ã ã‘ç”Ÿæˆï¼ˆè¶…é‡è¦ï¼‰
  if(!sePool[key]){
    sePool[key] = new Audio(src);
  }

  // cloneNode ã¯è¶…è»½ã„
  const a = sePool[key].cloneNode();

a.playsInline = true;   // â† â­è¿½åŠ ï¼ˆè¶…é‡è¦ï¼‰
a.volume = 0.85;


  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ãƒ”ãƒƒãƒUP
  if(inFeverNow()){
    a.playbackRate = 1.25;
  }

  const p = a.play();
  if(p && p.catch) p.catch(()=>{});
}


document.addEventListener("pointerdown", unlockAudioOnce, { once:true });

/* =========================================================
  7) å…¥åŠ›ï¼ˆUIã‚¯ãƒªãƒƒã‚¯åº§æ¨™ / ã‚²ãƒ¼ãƒ æ“ä½œï¼‰
========================================================= */

function getPointerXY(e){

  const rect = canvas.getBoundingClientRect();

  // â­ iOSå®Œå…¨å¯¾å¿œ
  const scaleX = canvas.width  / rect.width;
  const scaleY = canvas.height / rect.height;

  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;

  const x = (clientX - rect.left) * scaleX;
  const y = (clientY - rect.top)  * scaleY;

  return {x,y};
}



function hitBtn(btn, x, y){
  const nx = x / canvas.width;
  const ny = y / canvas.height;

  return (
    nx > btn.x1 &&
    nx < btn.x2 &&
    ny > btn.y1 &&
    ny < btn.y2
  );
}


canvas.addEventListener("pointerdown",(e)=>{

  unlockAudioOnce();

  const { x, y } = getPointerXY(e);

  // ==========================
  // ğŸ”Š éŸ³ã‚ã‚Š / éŸ³ãªã—é¸æŠ
  // ==========================
  if(state === STATE.SOUND){

    const nx = x / canvas.width;
    const ny = y / canvas.height;

    console.log("SOUND click", { nx, ny });

    // ğŸ“± ã‚¹ãƒãƒ›ï¼ˆç¸¦ï¼‰
    if(isMobile()){

      // éŸ³ã‚ã‚Š
      if(nx > 0.2 && nx < 0.8 && ny > 0.58 && ny < 0.66){
        soundOn = true;
        playBgm("bgm_common_intro.mp3");
        state = STATE.COURSE;
        return;
      }

      // éŸ³ãªã—
      if(nx > 0.2 && nx < 0.8 && ny > 0.68 && ny < 0.76){
        soundOn = false;
        stopBgm();
        state = STATE.COURSE;
        return;
      }

    }else{

      // ğŸ’» PCï¼ˆæ¨ªï¼‰
      if(ny > 0.63 && ny < 0.83){

        // å·¦ï¼šéŸ³ã‚ã‚Š
        if(nx > 0.10 && nx < 0.48){
          soundOn = true;
          playBgm("bgm_common_intro.mp3");
          state = STATE.COURSE;
          return;
        }

        // å³ï¼šéŸ³ãªã—
        if(nx > 0.52 && nx < 0.90){
          soundOn = false;
          stopBgm();
          state = STATE.COURSE;
          return;
        }
      }
    }

    // â­ SOUNDç”»é¢ã¯ã“ã“ã§çµ‚äº†
    return;
  }

  // â‘¡ ã‚³ãƒ¼ã‚¹é¸æŠï¼ˆå·¦=ãƒŸãƒ©ã¾ã‚‹ã€å³=ãƒãƒ£ãƒ¼ã™ã‘ï¼‰
  if(state===STATE.COURSE){

  if(x < canvas.width/2){
     mode = "mm";
  }else{
     mode = "ch";
  }

  state = STATE.START;
  return;
}




  // â‘¢ ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆç”»åƒUIï¼šä¸­å¤®ã®ãƒœã‚¿ãƒ³ç¯„å›²ï¼‰
  if(state===STATE.START){

  // â˜…ä¸­å¤®ãƒœã‚¿ãƒ³æŠ¼ã—ãŸã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹
  startGame();
  return;
}



  // â‘£ ã‚²ãƒ¼ãƒ ä¸­ï¼šã‚¸ãƒ£ãƒ³ãƒ—
  if(state===STATE.GAME){

  // â­ JUMPãƒœã‚¿ãƒ³æŠ¼ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
  if(jumpBtnRect){
    if(
      x > jumpBtnRect.x &&
      x < jumpBtnRect.x + jumpBtnRect.w &&
      y > jumpBtnRect.y &&
      y < jumpBtnRect.y + jumpBtnRect.h
    ){
      jumpBtnPressed = true;
      jump();
      return;
    }
  }

  // PCã¯ç”»é¢ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚ã‚¸ãƒ£ãƒ³ãƒ—
  if(!isMobile()){
    jump();
  }

  return;
}


  // â‘¤ çµ‚äº†ç”»é¢ï¼šã‚‚ã†ä¸€åº¦ / ã‚„ã‚ã‚‹
if(state===STATE.END){

  if(isMobile()){

    if(hitBtn(BTN.end_retry_sp,x,y)){
      startGame();
      return;
    }

    if(hitBtn(BTN.end_exit_sp,x,y)){
      state = STATE.COURSE;
      stopBgm();
      return;
    }

  }else{

    if(hitBtn(BTN.end_retry_pc,x,y)){
      startGame();
      return;
    }

    if(hitBtn(BTN.end_exit_pc,x,y)){
      state = STATE.COURSE;
      stopBgm();
      return;
    }

  }
}




});

document.addEventListener("keydown",(e)=>{
  if(e.code==="Space"){
    e.preventDefault();
    unlockAudioOnce();
    if(state===STATE.GAME) jump();
    if(state===STATE.START) startGame();
    if(state===STATE.END) startGame();
  }
});

/* =========================================================
  8) ã‚²ãƒ¼ãƒ æœ¬ä½“ï¼ˆã‚ãªãŸã®æ—¢å­˜ä»•æ§˜ã‚’ç¶­æŒï¼‰
========================================================= */
const GAME_MS = 30_000;


const gravity   = 1.35;
const jumpPower = -22;
const BASE_SPEED = 8;

let running = false;
let startAt = 0;
let lastCleared = false;

let playCount = 0;        // ãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼šlocalStorage
let gameEvent = null;     // ã“ã®ã‚²ãƒ¼ãƒ ã®ãƒ¬ã‚¢æ 
let used = null;

let player = {};
let score = 0;
let hp = 3;

let lightnings = [];
let items = [];
let enemies = [];
let bgScrollX = 0;


let lastSpawn = 0;
let spawnCount = 0;

let feverCount = 0;
let feverUntil = 0;

let speedUntil = 0;
let slowUntil  = 0;
let enemyRateDownUntil = 0;
let mapRevealUntil = 0;

let shakeUntil = 0;
let sinkUntil  = 0;
let starsUntil = 0;
let starsAngle = 0;

let popups = [];
let comment = { text:"", until:0 };
let jumpBtnRect = null; 
let jumpBtnPressed = false; 



let shieldUntilHit = false; // mmå°‚ç”¨ğŸ˜

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

/* å½“ãŸã‚Šåˆ¤å®šï¼ˆå®‰å®šç‰ˆï¼‰ */
function hit(a, b){
  const marginA = 14;
  const marginB = 10;
  return (
    a.x + marginA < b.x + b.w - marginB &&
    a.x + a.w - marginA > b.x + marginB &&
    a.y + marginA < b.y + b.h - marginB &&
    a.y + a.h - marginA > b.y + marginB
  );
}

/* HUD */
function updateHUD(remainMs){
  timeTxt.textContent = (remainMs/1000).toFixed(1);
  scoreTxt.textContent = score;
  hpTxt.textContent = "ğŸ”‹".repeat(hp) + "â–«ï¸".repeat(3-hp);
}

function flashDamage(){
  damageFlash.classList.add("show");
  setTimeout(()=>damageFlash.classList.remove("show"), 120);
}

function popHP(){
  hpPill.classList.add("hp-pop");
  setTimeout(()=>hpPill.classList.remove("hp-pop"), 280);
}

function say(text, duration=1200){
  comment.text = text;
  comment.until = performance.now() + duration;
}

function setStatus(){
  const t = performance.now();
  const parts = [];
  if(t < feverUntil) parts.push("ãƒ•ã‚£ãƒ¼ãƒãƒ¼");
  if(t < mapRevealUntil) parts.push("å…ˆèª­ã¿");
  if(t < enemyRateDownUntil) parts.push("æ•µDOWN");
  if(t < speedUntil) parts.push("SPEED+");
  if(t < slowUntil)  parts.push("SPEED-");
  if(mode==="mm" && shieldUntilHit) parts.push("ğŸ˜ã‚¬ãƒ¼ãƒ‰");
  statusTxt.textContent = "çŠ¶æ…‹ï¼š" + (parts.length ? parts.join(" / ") : "é€šå¸¸");
  feverBadge.classList.toggle("on", t < feverUntil);
}

/* ã‚²ãƒ¼ãƒ å›æ•°ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰ */
function storageKeyForCount(){
  return mode === "ch" ? "evrun_playCount_ch" : "evrun_playCount_mm";
}
function loadPlayCount(){
  const raw = localStorage.getItem(storageKeyForCount());
  const n = raw ? parseInt(raw,10) : 0;
  return Number.isFinite(n) ? n : 0;
}
function savePlayCount(n){
  localStorage.setItem(storageKeyForCount(), String(n));
}
function decideGameEvent(){
  const fever = (playCount % 15 === 0);              // 15ã‚²ãƒ¼ãƒ ã«1å›
  const bigLightning = (!fever && playCount % 10 === 0); // 10ã‚²ãƒ¼ãƒ ã«1å›
  const rare5 = (!fever && playCount % 5 === 0);     // 5ã‚²ãƒ¼ãƒ ã«1å›ï¼ˆãƒ¢ãƒ¼ãƒ‰ã®ãƒ¬ã‚¢æ ï¼‰
  return { fever, bigLightning, rare5 };
}

/* ãƒ•ã‚£ãƒ¼ãƒãƒ¼ */
function startFever(){

  const t = performance.now();

  feverUntil = t + 5200;
  feverLayer.classList.add("show");

  // â­ã“ã“ã§ stopBgm ã—ãªã„
  // ï¼ˆplayBgm ãŒå®Œå…¨åœæ­¢ç®¡ç†ã™ã‚‹ã‹ã‚‰ï¼‰

  if(soundOn){

  // â­é€šå¸¸BGMã‚’ä¸€æ™‚åœæ­¢ï¼ˆæ­¢ã‚ãªã„ï¼‰
  if(bgm){
    try{ bgm.pause(); }catch(e){}
  }

  feverBgm = new Audio("bgm_fever.mp3");
  feverBgm.loop = true;
  feverBgm.volume = 0.7;

  feverBgm.playsInline = true;
  feverBgm.setAttribute("playsinline","");
  feverBgm.setAttribute("webkit-playsinline","");

  feverBgm.play().catch(()=>{});
}

  say("ğŸŒˆ ãƒ•ã‚£ãƒ¼ãƒãƒ¼çªå…¥ï¼",1100);
}




function endFeverIfNeeded(){

  if(!feverBgm) return;

  const t = performance.now();

  if(t >= feverUntil){

    feverLayer.classList.remove("show");

    if(feverBgm){
      feverBgm.pause();
      feverBgm.currentTime = 0;
      feverBgm = null;
    }

    // â­é€šå¸¸BGMã‚’å†é–‹
if(bgm){
  try{ bgm.play(); }catch(e){}
}
  }
}



/* ã‚¹ãƒãƒ¼ãƒ³ */
function makeLightning(){
  return { kind:"lightning", x: canvas.width, y: groundY - 60 - Math.random()*120, w:50, h:50 };
}
function makeItem(key){

  let y = groundY - 60 - Math.random()*120;

  if(key === "ch_station") y = groundY + 10;
  if(key === "lightningBig") y = groundY - 110;
  if(key === "ch_repair" || key === "mm_onigiri") y = groundY - 40;

  return {
    type:"item",
    key:key,
    x: canvas.width,
    y: y,
    w:(key==="lightningBig") ? 64 : 56,
    h:(key==="lightningBig") ? 64 : 56
  };
}

function makeEnemyByRule(){

  const yJitter = Math.random()*12;
  let kind;

  if(spawnCount % 5 === 0) kind = "trouble";
  else if(spawnCount % 2 === 0 && Math.random() < 0.45) kind = "traffic";
  else kind = (Math.random() < 0.52) ? "pitfall" : "construction";

  return {
    type:"enemy",
    kind,
    x: canvas.width,
    y: groundY + 25, // â†ã‚ã¨ã§ä¸‹ã’ã‚‹èª¿æ•´ã™ã‚‹
    w:70,
    h:70,
    rot:0
  };
}

/* ã“ã®ã‚²ãƒ¼ãƒ ã®ãƒ¬ã‚¢æ ã‚’ã€Œ1å›ãšã¤ã€æ¶ˆåŒ– */
function trySpawnPlannedEvent(){
  if(spawnCount < 6) return false;

  const t = performance.now();

  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆã“ã®ã‚²ãƒ¼ãƒ 1å›ï¼‰
  if(gameEvent.fever && !used.fever){
    items.push({
      type:"item",
      key:"event_fever",
      x: canvas.width,
      y: groundY - 120,
      w: 64,
      h: 64
    });
    used.fever = true;
    say("ğŸŒˆ ä½•ã‹ç‰¹åˆ¥ãªã‚‚ã®ãŒâ€¦ï¼Ÿ",1000);
    return true;
  }

  if(t < feverUntil) return false;

  // å¤§âš¡ï¼ˆ10å›ã«1å›ï¼šã“ã®ã‚²ãƒ¼ãƒ ã§1å›ï¼‰
  if(gameEvent.bigLightning && !used.bigLightning){
    items.push(makeItem("lightningBig"));
    used.bigLightning = true;
    say("ãŸã¾ã«å¤§âš¡ããŸï¼ğŸ‰", 1000);
    return true;
  }

  // 5å›ã«1å›æ ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
  if(gameEvent.rare5 && !used.rare5){
    const rareKeys = MODE[mode].itemRare5;
    const pick = rareKeys[(playCount/5|0) % rareKeys.length];
    items.push(makeItem(pick));
    used.rare5 = true;

    if(mode==="ch"){
      if(pick==="ch_curry") say("ä»Šå›ã¯ğŸ›æ¥ãŸï¼", 1000);
      else if(pick==="ch_station") say("ä»Šå›ã¯â›½æ¥ãŸï¼", 1000);
      else say("ä»Šæ—¥ã¯ãƒ¬ã‚¢ï¼", 900);
    }else{
      if(pick==="mm_senbei") say("ä»Šå›ã¯ğŸ˜æ¥ãŸï¼", 1000);
      else if(pick==="mm_tea") say("ä»Šå›ã¯ğŸµæ¥ãŸï¼", 1000);
      else say("ä»Šæ—¥ã¯ãƒ¬ã‚¢ï¼", 900);
    }
    return true;
  }

  return false;
}

function spawn(){
  const now = Date.now();
  const t = performance.now();
  const inFever = (t < feverUntil);

  const interval = inFever ? 420 : 1200;
  if(now - lastSpawn < interval) return;
  lastSpawn = now;

  spawnCount++;

  // ã¾ãšã€Œã“ã®ã‚²ãƒ¼ãƒ ã®äºˆå®šã€ã‚’å‡ºã™
  if(trySpawnPlannedEvent()) return;

  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ï¼šæ•µãªã—ï¼†âš¡å¤§é‡
  if(inFever){
    lightnings.push(makeLightning());
    if(Math.random() < 0.35) lightnings.push(makeLightning());
    return;
  }

  // é€šå¸¸ï¼šæ•µ or ã‚¢ã‚¤ãƒ†ãƒ  or âš¡
  const enemyChanceBase = 0.52;
  const enemyChance = (t < enemyRateDownUntil) ? 0.30 : enemyChanceBase;

  if(Math.random() < enemyChance){
    enemies.push(makeEnemyByRule());
  }else{
    const r = Math.random();
    const every = MODE[mode].itemEvery;

    if(mode==="ch"){
      // chï¼šæ¯å›æ ã‚‚ã¡ã‚ƒã‚“ã¨å‡ºã‚‹ï¼ˆç¨²å¦»ã ã‘ã«ãªã‚‰ãªã„ï¼‰
      if(r < 0.16) items.push(makeItem(every[0]));         // ğŸ› 
      else if(r < 0.28) items.push(makeItem(every[1]));    // ğŸ—º
      else if(r < 0.40) items.push(makeItem(every[2]));    // ğŸ§­
      else if(r < 0.88) lightnings.push(makeLightning());  // âš¡
      else lightnings.push(makeLightning());
    }else{
      // mmï¼šğŸ™/ğŸ¡ã‚’æ‹¾ã£ã¦æ¥½ã—ã‚€æ¯”ç‡é«˜ã‚
      if(r < 0.22) items.push(makeItem(every[0]));         // ğŸ™
      else if(r < 0.44) items.push(makeItem(every[1]));    // ğŸ¡
      else if(r < 0.92) lightnings.push(makeLightning());  // âš¡
      else lightnings.push(makeLightning());
    }
  }
}

/* æ“ä½œ */
function jump(){
  if(!running) return;
  // åœ°é¢ãƒ”ãƒƒã‚¿ãƒªã§ã®ã¿ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆã‚ºãƒ¬é˜²æ­¢ï¼šåœ°é¢ã«å¸ç€ã—ã¦ã‚‹ã®ã§ == ã§OKï¼‰
  if(player.y === groundY){
    player.vy = jumpPower;
    playSE("jump");
  }
}

/* åˆæœŸåŒ– */
function resetGameCore(){
  running = false;
  startAt = 0;

  const size = isMobile() ? 110 : 80; // â­ã‚¹ãƒãƒ›ã ã‘å¤§ãã

player = {
  x:150,
  y:groundY,
  w:size,
  h:size,
  vy:0
};

  score = 0;
  hp = 3;

  lightnings = [];
  items = [];
  enemies = [];

  lastSpawn = 0;
  spawnCount = 0;

  feverCount = 0;
  feverUntil = 0;

  speedUntil = 0;
  slowUntil  = 0;
  enemyRateDownUntil = 0;
  mapRevealUntil = 0;

  shakeUntil = 0;
  sinkUntil  = 0;
  starsUntil = 0;
  starsAngle = 0;

  popups = [];
  comment = { text:"", until:0 };

  shieldUntilHit = false;

  used = { fever:false, bigLightning:false, rare5:false };
  feverLayer.classList.remove("show");
  feverBadge.classList.remove("on");
  statusTxt.textContent = "çŠ¶æ…‹ï¼šé€šå¸¸";
  updateHUD(GAME_MS);
}

/* é–‹å§‹ */
function startGame(){
  if(!mode) mode = "ch";



  state = STATE.GAME;
  hud.classList.add("show");

  playCount = loadPlayCount() + 1;
  savePlayCount(playCount);

  gameEvent = decideGameEvent();
  resetGameCore();

  stopBgm();
  playBgm(MODE[mode].bgm);

  if(gameEvent.fever) say("ä»Šæ—¥ã¯â€¦ç‰¹åˆ¥ãªäºˆæ„Ÿï¼", 1000);
  else if(gameEvent.bigLightning) say("ãŸã¾ã«å¤§âš¡ãã‚‹ã‹ã‚‚ï¼", 1000);
  else if(gameEvent.rare5){
    if(mode==="ch") say("æ¬¡ã¯â›½ã‹ğŸ›ã‹ã‚‚ï¼Ÿ", 1000);
    else say("æ¬¡ã¯ğŸ˜ã‹ğŸµã‹ã‚‚ï¼Ÿ", 1000);
  }else{
    say("ã„ãã‚ˆãƒ¼ï¼", 900);
  }

  running = true;
  startAt = Date.now();
}

/* çµ‚äº† */
function finish(cleared){

  if(!running) return;

  running = false;

  normalBgmSrc = null;

  lastCleared = !!cleared;

  stopBgm();
  hud.classList.remove("show");
  state = STATE.END;

  if(soundOn){
    const bgmSrc = cleared
      ? RESULT_BGM[mode].clear
      : RESULT_BGM[mode].over;

    playBgm(bgmSrc, false); // â­ã“ã“é‡è¦
  }
}





/* æ›´æ–° */
function update(){
  const t = performance.now();
  const nowMs = Date.now();

  bgScrollX -= 2;
  if(bgScrollX <= -canvas.width){
    bgScrollX = 0;
  }


  // ç‰©ç†
  player.vy += gravity;
  player.y += player.vy;

  // åœ°é¢ã«å¸ç€
  if(player.y > groundY){
    player.y = groundY;
    player.vy = 0;
  }

  // ã‚¹ãƒãƒ¼ãƒ³
  spawn();

  // é€Ÿåº¦
  let curSpeed = BASE_SPEED;
  if(t < speedUntil) curSpeed *= 1.25;
  if(t < slowUntil)  curSpeed *= 0.72;
// ç§»å‹•ï¼ˆå·¦ã¸æµã™ï¼‰
lightnings.forEach(l => { l.x -= curSpeed; });

items.forEach(it => { it.x -= curSpeed; });

enemies.forEach(en => {
  en.x -= curSpeed;

  // å·¥äº‹ä¸­ã ã‘å›è»¢ï¼ˆè¦‹ãŸç›®ç”¨ï¼‰
  if(en.kind === "construction"){
    en.rot += 0.06;
  }
});


  // +1ãƒãƒƒãƒ—
  popups.forEach(p => { p.y -= 0.6; p.life--; });
  popups = popups.filter(p => p.life > 0);

  // âš¡å–å¾—ï¼ˆå½“ãŸã£ãŸæ™‚ã ã‘åŠ ç®—ï¼‰
  lightnings = lightnings.filter(l => {
    if(hit(player, l)){
      score += 10;
      playSE("lightning");
      if(Math.random() < 0.10) talk("lightning");
      return false;
    }
    return l.x > -60;
  });


function say(text, duration=1200){
  comment.text = text;
  comment.until = performance.now() + duration;
}

  // ã‚¢ã‚¤ãƒ†ãƒ å–å¾—ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
  items = items.filter(it=>{
  if(hit(player, it)){

    // å…±é€š
    if(it.key === "lightningBig"){
      score += 50;
      playSE("lightning");
      talk("lightning");
      return false;
    }

    if(it.key === "event_fever"){
      playSE("itemRare");
      startFever();
      talk("fever");
      return false;
    }

    // ===== ch =====
    if(mode==="ch"){

      if(it.key === "ch_repair" || it.key === "ch_station"){
        playSE("itemCommon");
        const before = hp;
        hp = clamp(hp + 1, 0, 3);

        if(hp !== before){
          popHP();
          popups.push({
            x: player.x + player.w/2 + 10,
            y: player.y - 10,
            text: "+1",
            life: 40
          });
        }

        talk("heal");
        return false;
      }

      if(it.key === "ch_curry"){
        speedUntil = t + 4200;
        playSE("itemRare");
        talk("speed");
        return false;
      }

      if(it.key === "ch_compass"){
        enemyRateDownUntil = t + 5200;
        playSE("itemCommon");
        talk("enemyDown");
        return false;
      }

      if(it.key === "ch_map"){
        mapRevealUntil = t + 4800;
        playSE("itemCommon");
        talk("map");
        return false;
      }
    }

    // ===== mm =====
    if(mode==="mm"){

      if(it.key === "mm_onigiri"){
        playSE("itemCommon");

        const before = hp;
        hp = clamp(hp + 1, 0, 3);

        if(hp !== before){
          popHP();
          popups.push({
            x: player.x + player.w/2 + 10,
            y: player.y - 10,
            text: "+1",
            life: 40
          });
        }

        talk("heal");
        return false;
      }

      if(it.key === "mm_dango"){
        speedUntil = t + 4200;
        playSE("itemCommon");
        talk("speed");
        return false;
      }

      if(it.key === "mm_tea"){
        enemyRateDownUntil = t + 5200;
        playSE("itemRare");
        talk("enemyDown");
        return false;
      }

      if(it.key === "mm_senbei"){
        shieldUntilHit = true;
        playSE("itemCommon");
        talk("guard");
        return false;
      }
    }

    return false;
  }

  return it.x > -90;
});


  // æ•µè¡çª
  enemies = enemies.filter(en=>{
    if(hit(player, en)){
      // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯æ•µãŒå‡ºãªã„è¨­è¨ˆã ãŒå¿µã®ãŸã‚
      if(t < feverUntil) return false;

      // mmã®ğŸ˜ã‚¬ãƒ¼ãƒ‰
      if(mode==="mm" && shieldUntilHit){
        shieldUntilHit = false;
        playSE("itemCommon"); // ã‚¬ãƒ¼ãƒ‰éŸ³ï¼ˆå¥½ã¿ã§å·®ã—æ›¿ãˆOKï¼‰
        talk("guard");
        return false;
      }

      flashDamage();
      shakeUntil = t + 220;
      popHP();

      if(en.kind === "traffic"){
        slowUntil = t + 3000;
        playSE("hitTraffic");
        talk("damage");
        return false;
      }

      // ãƒ€ãƒ¡ãƒ¼ã‚¸
      hp = clamp(hp - 1, 0, 3);
      talk("damage");

      if(en.kind === "pitfall"){
        playSE("hitPitfall");
        sinkUntil = t + 650;
      }else if(en.kind === "construction"){
        playSE("hitConstruction");
        starsUntil = t + 900;
        starsAngle = 0;
      }else if(en.kind === "trouble"){
        playSE("hitTrouble");
        shakeUntil = t + 320;
      }else{
        // å¿µã®ãŸã‚
        playSE("hitTrouble");
      }
      return false;
    }
    return en.x > -120;
  });

  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼çµ‚ã‚ã‚Š
  endFeverIfNeeded();

  // çŠ¶æ…‹è¡¨ç¤º
  setStatus();


if(lightnings.length > 25) lightnings.splice(0,5);
if(items.length > 20) items.splice(0,5);
if(enemies.length > 20) enemies.splice(0,5);

  // çµ‚äº†åˆ¤å®šï¼ˆæ™‚é–“ï¼‰
  const remain = GAME_MS - (nowMs - startAt);
  updateHUD(Math.max(0, remain));

  if(hp <= 0) finish(false);
  else if(remain <= 0) finish(true);
}


// ================================
// â­ ä¸Šéƒ¨ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤º
// ================================
function say(text, duration=1200){
  comment.text = text;
  comment.until = performance.now() + duration;
}


// ================================
// â­ ã‚­ãƒ£ãƒ©å£èª¿ãƒˆãƒ¼ã‚¯ï¼ˆé…åˆ—å¯¾å¿œç‰ˆï¼‰
// ================================
function talk(type){

  const MM = {
    lightning: [
      "ã„ã„æ„Ÿã˜ã‹ã‚‚â€¦",
      "ã¾ã ã„ã‘ã‚‹ã­",
      "é †èª¿ãã†â€¦"
    ],

    fever: [
      "ãªã‚“ã ã‹ã™ã”ãã†â€¦",
      "ã‚­ãƒ©ã‚­ãƒ©ã—ã¦ã‚‹â€¦"
    ],

    heal: [
      "ã¡ã‚‡ã£ã¨å…ƒæ°—ã«ãªã£ãŸã­",
      "å›å¾©ã§ããŸã¿ãŸã„"
    ],

    speed: [
      "å°‘ã—æ€¥ã”ã†ã‹",
      "ã„ã„ãƒšãƒ¼ã‚¹ã ã­"
    ],

    map: [
      "ãªã‚“ã¨ãªãåˆ†ã‹ã‚‹ã‹ã‚‚â€¦",
      "æ•µãŒè¦‹ã‚„ã™ããªã£ãŸã¿ãŸã„"
    ],

    enemyDown: [
      "å±ãªããªã•ãã†â€¦",
      "è½ã¡ç€ã„ã¦ã„ã“ã†"
    ],

    guard: [
      "å®ˆã‚‰ã‚Œã¦ã‚‹ã­",
      "å®‰å¿ƒã§ãã‚‹ã‹ã‚‚"
    ],

    damage: [
      "ã ã„ã˜ã‚‡ã†ã¶â€¦ï¼Ÿ",
      "ã„ãŸã„ã£â€¦",
      "æ°—ã‚’ã¤ã‘ã¦â€¦",
      "ã†ã‚ã£â€¦"
    ],
  };

  const CH = {
    lightning: [
      "ã„ã„ã­ï¼",
      "ãƒŠã‚¤ã‚¹ï¼",
      "ãã®èª¿å­ï¼"
    ],

    fever: [
      "ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã ï¼",
      "ã„ã£ãããƒ¼ï¼"
    ],

    heal: [
      "å›å¾©ã—ãŸã‚ˆï¼",
      "ã¾ã ã¾ã ã„ã‘ã‚‹ï¼"
    ],

    speed: [
      "ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼",
      "åŠ é€Ÿã ãƒ¼ï¼"
    ],

    map: [
      "æ•µãŒè¦‹ã‚„ã™ããªã£ãŸã‚ˆï¼",
      "æ•µã«æ°—ã‚’ã¤ã‘ã¦ï¼"
    ],

    enemyDown: [
      "æ•µãŒæ¸›ã£ãŸï¼",
      "ä»ŠãŒãƒãƒ£ãƒ³ã‚¹ï¼"
    ],

    guard: [
      "ã‚¬ãƒ¼ãƒ‰ï¼",
      "å®ˆã‚‰ã‚Œã¦ã‚‹ï¼"
    ],

    damage: [
      "ã‚ã£ï¼",
      "ã¶ã¤ã‹ã£ãŸï¼",
      "ã„ã¦ã£ï¼",
      "å¤§ä¸ˆå¤«ï¼ï¼Ÿ",
      "ã†ã‚ã£ï¼"
    ],
  };

  const dict = (mode==="mm") ? MM : CH;
  const list = dict[type];

  if(!list) return;

  // â­ é…åˆ—ãªã‚‰ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º
  if(Array.isArray(list)){
    const txt = list[Math.floor(Math.random()*list.length)];
    say(txt,900);
  }else{
    say(list,900);
  }
}


/* =========================================================
  9) æç”»ï¼ˆçŠ¶æ…‹åˆ¥ï¼‰
========================================================= */
function drawUI(){

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(state===STATE.SOUND){

    const img = isMobile()?UI.sound_sp:UI.sound;

    if(img?.ok){
  ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
}else{
  drawFallbackText("ui_sound_select.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
}


    return;
  }

  if(state===STATE.COURSE){

    const img = isMobile()?UI.course_sp:UI.course;

    if(img?.ok){
      ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
    }else{
      drawFallbackText("ui_course_select.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
    }
    return;
  }

  if(state===STATE.START){

    const img = isMobile()?UI.start_sp:UI.start;

    if(img?.ok){
      ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
    }else{
      drawFallbackText("ui_start.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
    }
    return;
  }

  if(state===STATE.END){
    const img = lastCleared
      ? (isMobile()?UI.clear_sp:UI.clear)
      : (isMobile()?UI.over_sp:UI.over);

    if(img?.ok){
      ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
    }
    return;
  }
}

function drawGame(){
  // èƒŒæ™¯
const bg = (isMobile() && I.bg_sp?.ok) ? I.bg_sp : I.bg;



if(bg && bg.ok){

  ctx.drawImage(bg.img, bgScrollX, 0, canvas.width, canvas.height);
  ctx.drawImage(bg.img, bgScrollX + canvas.width, 0, canvas.width, canvas.height);

} else {

  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

}


  const t = performance.now();

  // å…ˆèª­ã¿ï¼ˆchã®ã¿ï¼‰
  // å…ˆèª­ã¿ï¼ˆchã®ã¿ï¼‰
if(mode==="ch" && t < mapRevealUntil){
  ctx.save();

  enemies.forEach(en=>{

    // â­ æ•µã®ä¸‹ã«å½±ï¼ˆå…ˆèª­ã¿ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‰
    ctx.globalAlpha = 0.35;
    ctx.fillStyle = "#000";

    ctx.beginPath();
    ctx.ellipse(
      en.x + en.w/2,     // ä¸­å¤®
      en.y + en.h - 6,   // è¶³å…ƒ
      en.w/2.2,          // æ¨ªå¹…
      8,                 // ç¸¦å¹…
      0, 0, Math.PI*2
    );
    ctx.fill();

  });

  ctx.restore();
}


  // âš¡
  lightnings.forEach(l=>{
    if(I.lightning?.ok) ctx.drawImage(I.lightning.img, l.x, l.y, l.w, l.h);
    else { ctx.fillStyle="#ff0"; ctx.fillRect(l.x,l.y,l.w,l.h); }
  });

  // ã‚¢ã‚¤ãƒ†ãƒ 
items.forEach(it=>{
  const imgObj = I[it.key];
  if(imgObj?.ok){
    ctx.drawImage(imgObj.img, it.x, it.y, it.w, it.h);
  }
});


  // æ•µ
  enemies.forEach(en=>{
    ctx.save();
    const imgObj = I[en.kind];
    if(en.kind === "construction" && imgObj?.ok){
      ctx.translate(en.x + en.w/2, en.y + en.h/2);
      ctx.rotate(en.rot);
      ctx.drawImage(imgObj.img, -en.w/2, -en.h/2, en.w, en.h);
    }else{
      if(imgObj?.ok) ctx.drawImage(imgObj.img, en.x, en.y, en.w, en.h);
      else { ctx.fillStyle="#f00"; ctx.fillRect(en.x,en.y,en.w,en.h); }
    }
    ctx.restore();
  });

  // ã‚­ãƒ£ãƒ©ï¼ˆæºã‚Œ/æ²ˆã‚€ï¼‰
ã€€ã€€let px = player.x;
ã€€ã€€let py = player.y;

// æºã‚Œ
ã€€if(t < shakeUntil) px += (Math.random()*8 - 4);

// æ²ˆã‚€
ã€€if(t < sinkUntil){
  ã€€const p = 1 - (sinkUntil - t) / 650;
  ã€€py += p * 220;
}

ã€€ã€€const playerKey = MODE[mode].playerKey;

// è„ˆå‹•ï¼ˆâ€»ã‚„ã‚‹ãªã‚‰ã“ã®1å›ã ã‘ï¼‰
ã€€ã€€const scale = 1 + Math.sin(t * 0.015) * 0.05;
ã€€ã€€const cx = px + player.w/2;
ã€€ã€€const cy = py + player.h/2;

ã€€ã€€ctx.save();
ã€€ã€€ctx.translate(cx, cy);
ã€€ã€€ctx.scale(scale, scale);
ã€€ã€€ctx.translate(-cx, -cy);

ã€€if(I[playerKey]?.ok){
  ã€€ctx.drawImage(I[playerKey].img, px, py, player.w, player.h);
}

ã€€ã€€ctx.restore();





  // ğŸ˜ã‚¬ãƒ¼ãƒ‰ãƒªãƒ³ã‚°
  if(mode==="mm" && shieldUntilHit){
    ctx.save();
    ctx.globalAlpha = 0.8;
    ctx.strokeStyle = "rgba(255,165,0,.95)";
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.arc(px + player.w/2, py + player.h/2, 44, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();
  }

  // ğŸš§æ˜Ÿãã‚‹ãã‚‹
  if(t < starsUntil){
    const centerX = px + player.w/2;
    const centerY = py + player.h/2;
    starsAngle += 0.22;
    const r = 44;
    for(let k=0; k<5; k++){
      const a = starsAngle + k*(Math.PI*2/5);
      const sx = centerX + Math.cos(a)*r;
      const sy = centerY + Math.sin(a)*r;
      ctx.save();
      ctx.translate(sx, sy);
      ctx.rotate(a);
      ctx.globalAlpha = 0.9;
      drawStar(ctx, 0, 0, 5, 10, 5);
      ctx.restore();
    }
  }

  // +1ãƒãƒƒãƒ—
  popups.forEach(p=>{
    ctx.save();
    ctx.globalAlpha = p.life / 40;
    ctx.font = "18px sans-serif";
    ctx.fillStyle = "#27ae60";
    ctx.fillText(p.text, p.x, p.y);
    ctx.restore();
  });

  // â­ ä¸Šéƒ¨ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤ºï¼ˆå¹ãå‡ºã—ä»£æ›¿ï¼‰
if(t < comment.until && comment.text){

  ctx.save();

  // åŠé€æ˜é»’ãƒãƒ¼
  ctx.globalAlpha = 0.85;
  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fillRect(0,120,canvas.width,40);

  // ãƒ†ã‚­ã‚¹ãƒˆ
  ctx.fillStyle = "#fff";
  ctx.font = "bold 16px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText(comment.text, canvas.width/2,145);

  ctx.restore();
}

  // â­â­â­ JUMPãƒœã‚¿ãƒ³ï¼ˆPCï¼‹ã‚¹ãƒãƒ›ï¼‰
if(I.ui_jump && I.ui_jump.ok){

  // â­ æ¨ªå¹…ã ã‘æŒ‡å®šï¼ˆé«˜ã•ã¯ç”»åƒæ¯”ç‡ã§è‡ªå‹•ï¼‰
  // ===== JUMPãƒœã‚¿ãƒ³ï¼ˆåœ°é¢ä¸‹ã„ã£ã±ã„ã«æ¨ªé•·ï¼‰ =====

const groundSpace = canvas.height - groundY;

const btnH = groundSpace * 0.55;
const btnW = canvas.width * (isMobile() ? 0.75 : 0.35);
const btnX = (canvas.width - btnW) / 2;

// â­ ä¸‹ã«ãšã‚‰ã™é‡
const offsetY = isMobile() ? 70 : 40;

// â­ Yåº§æ¨™ã‚’ã¡ã‚ƒã‚“ã¨è¨ˆç®—
const btnY = groundY + (groundSpace - btnH) / 2 + offsetY;

ctx.globalAlpha = 0.95;
ctx.drawImage(I.ui_jump.img, btnX, btnY, btnW, btnH);
ctx.globalAlpha = 1;

jumpBtnRect = { x: btnX, y: btnY, w: btnW, h: btnH };

}
}


function drawFallbackText(msg){
  ctx.save();
  ctx.fillStyle="#111";
  ctx.font="bold 18px sans-serif";
  ctx.fillText(msg, 40, 80);
  ctx.font="14px sans-serif";
  ctx.fillText("ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å†ç¢ºèªã—ã¦ã€index.htmlã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ã„ã¦ã­", 40, 110);
  ctx.restore();
}

function drawStar(ctx, x, y, spikes, outerRadius, innerRadius){
  let rot = Math.PI / 2 * 3;
  let step = Math.PI / spikes;
  ctx.beginPath();
  ctx.moveTo(x, y - outerRadius);
  for(let i=0; i<spikes; i++){
    ctx.lineTo(x + Math.cos(rot) * outerRadius, y + Math.sin(rot) * outerRadius);
    rot += step;
    ctx.lineTo(x + Math.cos(rot) * innerRadius, y + Math.sin(rot) * innerRadius);
    rot += step;
  }
  ctx.lineTo(x, y - outerRadius);
  ctx.closePath();
  ctx.fillStyle = "rgba(255, 200, 0, .95)";
  ctx.strokeStyle = "rgba(255, 140, 0, .95)";
  ctx.lineWidth = 2;
  ctx.fill(); ctx.stroke();
}

function roundRect(ctx, x, y, w, h, r){
  r = Math.min(r, w/2, h/2);
  if(ctx.roundRect){
    ctx.beginPath();
    ctx.roundRect(x, y, w, h, r);
    return;
  }
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}

/* =========================================================
  10) æç”»ãƒ«ãƒ¼ãƒ—ï¼ˆå¸¸æ™‚ï¼‰
========================================================= */
function drawFrame(){
  if(state===STATE.SOUND || state===STATE.COURSE || state===STATE.START || state===STATE.END){
    drawUI();
    requestAnimationFrame(drawFrame);
    return;
  }

  if(state===STATE.GAME){
    if(running) update();
    drawGame();
    requestAnimationFrame(drawFrame);
    return;
  }

  requestAnimationFrame(drawFrame);
}

/* =========================================================
  11) èµ·å‹•ï¼šç”»åƒãƒ­ãƒ¼ãƒ‰
========================================================= */
async function boot(){
  const uiKeys = Object.keys(UI_SRC);
  const uiLoaded = await Promise.all(uiKeys.map(k=>loadOneImage(UI_SRC[k])));
  uiKeys.forEach((k,idx)=>UI[k]=uiLoaded[idx]);

  const keys = Object.keys(ASSET);
  const loaded = await Promise.all(keys.map(k => loadOneImage(ASSET[k])));
  keys.forEach((k, idx)=>{ I[k] = loaded[idx]; });

  loadingEl.style.display = "none";
requestAnimationFrame(drawFrame);
}

document.addEventListener("pointerdown", () => {
  if(!audioUnlocked){
    unlockAudioOnce();
  }
},{ once:true });

boot();


// â­â­â­ iOSéŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼ˆã“ã“ã«å…¥ã‚Œã‚‹ï¼‰
document.addEventListener("pointerdown", () => {

  if(!audioUnlocked){
    unlockAudioOnce();

    // â­ soundOn true ã®æ™‚ã ã‘
    if(soundOn){
      const a = new Audio("se_jump.mp3");
      a.volume = 0;
      a.playsInline = true;
      a.play().catch(()=>{});
    }
  }

},{ once:true });


</script>
</body>
</html>
