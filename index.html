<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<title>ãƒŸãƒ©ã¾ã‚‹ï¼†ãƒãƒ£ãƒ¼ã™ã‘ã®EVã‚¨ãƒŠã‚¸ãƒ¼ãƒ©ãƒ³</title>
<style>
  *{
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  user-select: none;
}

html,body{
margin:0;
background:#fff;
overflow:visible;
min-height:100vh;
position:relative;

/* â­ä¸­å¤®å›ºå®š */
display:flex;
align-items:center;
justify-content:center;

font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;
}

canvas,
button,
img,
a{
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;
}

button,
a{
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}

button:focus,
button:focus-visible,
a:focus,
a:focus-visible{
  outline: none;
}

img{
  -webkit-user-drag: none;
}

canvas{
display:block;
margin:0;
background:#fff;
touch-action:manipulation;
position:relative;
z-index:95;

/* â­ç¸¦æ¨ªã©ã£ã¡ã§ã‚‚åã¾ã‚‹ã‚µã‚¤ã‚º */
width:min(100vw, calc(100dvh * (960/540)));
height:auto;
}

#titleBg{
  display:none;
}

@media (max-width:900px){
  html,body{
    background:transparent;
    width:100vw;
    min-height:100dvh;
    height:100dvh;
    overflow:hidden;
    overscroll-behavior:none;
  }
  canvas{
    background:transparent;
  }
  #titleBg{
    position:absolute;
    top:80px;
    left:0;
    width:100%;
    height:auto;
    display:none;
    pointer-events:none;
    z-index:99999;
  }
}

  /* ===== æ¼”å‡º ===== */
  .flash{
    position:fixed; inset:0;
    background:rgba(255,0,0,.28);
    opacity:0; pointer-events:none;
    transition:opacity .15s;
    z-index:120;
  }
  .flash.show{ opacity:1; }

  .fever{
    position:fixed; inset:0;
    opacity:0; pointer-events:none;
    z-index:115;
    background: linear-gradient(
      120deg,
      rgba(255,0,0,.24),
      rgba(255,255,0,.22),
      rgba(0,255,0,.20),
      rgba(0,255,255,.20),
      rgba(0,0,255,.20),
      rgba(255,0,255,.22)
    );
    background-size: 300% 300%;
    animation: rainbowMove 3.6s ease-in-out infinite;
    transition: opacity .25s ease;
  }
  .fever.show{ opacity:1; }
  @keyframes rainbowMove{
    0%{ background-position:0% 50%; }
    50%{ background-position:100% 50%; }
    100%{ background-position:0% 50%; }
  }

  /* ===== HUD ===== */
  .hud{
    position:fixed; left:12px; top:12px;
    display:none; gap:8px; flex-wrap:wrap;
    z-index:25;
    user-select:none;
  }
  .hud.show{ display:flex; }

  .pill{
    background:rgba(255,255,255,.86);
    backdrop-filter: blur(4px);
    border:1px solid rgba(0,0,0,.08);
    border-radius:999px;
    padding:8px 10px;
    font-size:13px;
    font-weight:900;
    color:#111;
    display:flex; align-items:center; gap:8px;
  }
  .tiny{ font-size:12px; color:#333; font-weight:900; }

  .feverBadge{
    display:none;
    animation: pulse .8s ease-in-out infinite;
  }
  .feverBadge.on{ display:flex; }
  @keyframes pulse{ 0%,100%{transform:scale(1);} 50%{transform:scale(1.06);} }

  .hp-pop{ animation: hpPop .28s ease; }
  @keyframes hpPop{ 0%{transform:scale(1);} 50%{transform:scale(1.35);} 100%{transform:scale(1);} }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
  .loading{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    z-index:50;
    color:#111;
    font-weight:900;
  }

  .bigTime{
  position:fixed;
  right:16px;
  top:12px;
  z-index:30;

  font-size:56px;
  font-weight:900;
  color:#111;

  background:rgba(255,255,255,.8);
  padding:8px 16px;
  border-radius:16px;

  display:none;
}

.bigTime.show{
  display:block;
}

/* ======================
  â­ å³ä¸Š é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
====================== */
.closeBtn{
  position:fixed;
  right:12px;
  top:12px;
  z-index:999;

  width:44px;
  height:44px;

  border-radius:999px;
  border:none;

  background:rgba(0,0,0,.25);
  color:#fff;
  font-size:24px;
  font-weight:900;

  display:none;
}

.closeBtn.show{
  display:block;
}
.closeBtn:active{
  transform:scale(0.94);
  filter:brightness(0.95);
}

.shareTapBtn{
  position:fixed;
  display:none;
  border:none;
  background:transparent;
  padding:0;
  margin:0;
  z-index:130;
}
.shareTapBtn:active{
  transform:scale(0.94);
}
#titleStartBtn:active{
  transform:translateX(-50%) scale(0.96);
  filter:brightness(0.97);
}

.middle-image,
.middle-video{
  position:absolute;
  left:42px;
  right:42px;
  top:308px;
  width:calc(100% - 84px);
  margin:0;
  padding:0;
  display:block;
  object-fit:cover;
  box-sizing:border-box;
  z-index:140;
  pointer-events:none;
}

.middle-image,
.middle-video{
  display:none;
}

</style>
</head>

<body>
<canvas id="game" width="960" height="540"></canvas>
<img id="mobileLayer"
class="middle-image"
src="ui_sound_sp2.png"
alt=""
>

<!-- â­ ã‚¹ãƒãƒ›ã‚¿ã‚¤ãƒˆãƒ«èƒŒæ™¯ï¼ˆvideoã®ä¸‹ï¼‰ -->
<img id="titleBg"
src="ui_sound_sp2.png"
loading="lazy"
decoding="async"
style="
pointer-events:none;
">


<!-- â­ ã‚¹ãƒãƒ›ã‚¿ã‚¤ãƒˆãƒ«å‹•ç”» -->
<video id="titleVideo"
src=""
playsinline muted loop autoplay
preload="metadata"
class="middle-video"
></video>



<!-- â­ ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
<img id="titleStartBtn"
src="btn_title_start_sp.png"
style="
position:fixed;
left:50%;
transform:translateX(-50%);

/* â­ å‹•ç”»ä¸‹ã®èƒŒæ™¯éƒ¨åˆ† */
bottom:20px;

width:70vw;
max-width:420px;

z-index:110;
display:none;
">



<button id="closeBtn" class="closeBtn">Ã—</button>
<button id="shareTapX" class="shareTapBtn" aria-label="Xã§ã‚·ã‚§ã‚¢"></button>
<button id="shareTapLINE" class="shareTapBtn" aria-label="LINEã§ã‚·ã‚§ã‚¢"></button>
<div class="flash" id="damageFlash"></div>
<div class="fever" id="feverLayer"></div>

<div class="loading" id="loading">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<script>

/* =========================================================
  0) çŠ¶æ…‹ï¼ˆç”»é¢é·ç§»ï¼‰
  éŸ³ã‚ã‚Š/ãªã— â†’ ã‚³ãƒ¼ã‚¹é¸æŠ â†’ ã‚¹ã‚¿ãƒ¼ãƒˆ â†’ ã‚²ãƒ¼ãƒ  â†’ çµæœ
========================================================= */
const STATE = {
  TITLE: "title", // â­è¿½åŠ 
  SOUND: "sound",
  COURSE: "course",
  START: "start",
  GAME: "game",
  END: "end"
};

const BTN = {

  // ã‚¹ãƒãƒ›ç¸¦ ENDç”»é¢
  end_retry_sp : { x1:0.2, x2:0.8, y1:0.55, y2:0.7 },
  end_exit_sp  : { x1:0.2, x2:0.8, y1:0.72, y2:0.9 },

  // PCæ¨ª ENDç”»é¢
  end_retry_pc : { x1:140/960, x2:460/960, y1:340/540, y2:460/540 },
  end_exit_pc  : { x1:500/960, x2:820/960, y1:340/540, y2:460/540 },

  // ğŸ­ éŸ³é¸æŠï¼ˆã‚¹ãƒãƒ›ï¼šä¸Šä¸‹ãƒœã‚¿ãƒ³ï¼‰â˜…ä¸‹ã«ã‚ºãƒ©ã—ãŸ
sound_on_sp  : { x1:0.15, x2:0.85, y1:0.57, y2:0.72 },
sound_off_sp : { x1:0.15, x2:0.85, y1:0.74, y2:0.90 },



  // â­ éŸ³é¸æŠï¼ˆPCï¼‰
sound_on_pc  : { x1:140/960, x2:420/960, y1:260/540, y2:400/540 },
sound_off_pc : { x1:520/960, x2:800/960, y1:260/540, y2:400/540 },

// â­ ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ï¼ˆè¿½åŠ ï¼‰
shareX: { x:0, y:0, w:0, h:0 },
shareLINE: { x:0, y:0, w:0, h:0 }

};

const SOUND_BTN_LAYOUT_SP = {
  left: 27 / 960,
  top: 1386 / 1676,
  width: 906 / 960,
  height: 290 / 1676
};


let state = STATE.SOUND;
let soundOn = true;
let mode = null; // "ch" | "mm"
const MOBILE_UI_ASPECT = 1313 / 1038;
const MOBILE_STAGE_TOP = 80;
const MOBILE_SIDE_INSET = 0;
const FRAME_STATES_MOBILE = new Set([STATE.SOUND, STATE.COURSE, STATE.START, STATE.GAME, STATE.END]);
const MOBILE_FRAME_BG = {
  [STATE.SOUND]: "ui_sound_sp.png",
  [STATE.TITLE]: "ui_main_sp.png",
  [STATE.COURSE]: "ui_course_sp.png",
  [STATE.START]: "ui_start_sp.png",
  [STATE.GAME]: "background_sp.png",
  [STATE.END]: "ui_score_sp.png"
};
const MOBILE_INNER_SRC = {
  [STATE.SOUND]: "ui_sound_sp2.png",
  [STATE.COURSE]: "ui_course_sp2.png",
  [STATE.GAME]: "background_sp2.png",
  [STATE.END]: "ui_score_sp2.png"
};
const MOBILE_FOOTER_BTN_BY_STATE = {
  [STATE.TITLE]: "btn_sound_on",
  [STATE.SOUND]: "btn_exit",
  [STATE.COURSE]: "btn_course",
  [STATE.START]: "btn_start",
  [STATE.GAME]: "btn_jump_footer",
  [STATE.END]: "btn_retry"
};

/* =========================================================
  1) UIç”»åƒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åï¼‰
========================================================= */
const UI_SRC = {
  sound:  "ui_sound.png",
  title:  "ui_start.png",
  sound_sp: "ui_sound_sp2.png",

  course: "ui_course.png",
  course_sp: "ui_course_select_sp.png",

  start:  "ui_start.png",
  start_mm: "ui_start_mm.png",
  start_ch: "ui_start_ch.png",
  start_sp: "ui_start_sp.png",

  score: "ui_score.png",

  clear:  "ui_game_clear.png",
  clear_sp: "ui_game_clear_sp.png",

  over:   "ui_game_over.png",
  over_sp: "ui_game_over_sp.png"
};

const UI = {};
let mobileUiFallbackMsg = "";

/* =========================================================
  2) ã‚²ãƒ¼ãƒ ç”¨ã‚¢ã‚»ãƒƒãƒˆï¼ˆç”»åƒï¼‰
========================================================= */
const ASSET = {
  bg: "background.jpg",
  bg_sp: "background_sp.png",
  bg_sp2: "background_sp2.png",
  ui_main_sp: "ui_main_sp.png",
  btn_sound_sp: "btn_sound_sp.png",
  btn_exit: "btn_exit.png",
  btn_sound_on: "btn_sound_on.png",
  btn_sound_ok: "btn_sound_ok.png",
  btn_sound_no: "btn_sound_no.png",
  btn_course: "btn_course.png",
  btn_start: "btn_start.png",
  btn_jump_footer: "btn_jump.png",
  btn_retry: "btn_retry.png",

  ui_jump: "ui_jump.png",

  event_fever: "ch_event_fever.png",

  // ã‚­ãƒ£ãƒ©
  ch_player: "ch_character.png",
  mm_player: "mm_character.png",

  // å…±é€šï¼ˆâš¡ï¼‰
  lightning: "ch_item_lightning.png",
  lightningBig: "ch_item_lightning_big.png",

  // ch ã‚¢ã‚¤ãƒ†ãƒ 
  ch_repair: "ch_item_repair.png",
  ch_map: "ch_item_map.png",
  ch_compass: "ch_item_compass.png",
  ch_station: "ch_item_station.png",
  ch_curry: "ch_item_curry.png",
  ch_item_battery: "ch_item_battery.png",

  // mm ã‚¢ã‚¤ãƒ†ãƒ 
  mm_onigiri: "mm_item_onigiri.png",
  mm_dango: "mm_item_dango.png",
  mm_senbei: "mm_item_senbei.png",
  mm_tea: "mm_item_tea.png",

  // æ•µ
  pitfall: "ch_enemy_pitfall.png",
  construction: "ch_enemy_construction.png",
  traffic: "ch_enemy_traffic.png",
  trouble: "ch_enemy_trouble.png",

  // â­ ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³
  share_x: "x_icon.png",
  share_line: "line_icon.png",

  // â­ ã‚¹ãƒãƒ›çŠ¶æ…‹ã”ã¨ã®ä¸­èº«UI
  ui_sound_sp2: "ui_sound_sp2.png",
  ui_course_sp2: "ui_course_sp2.png",
  ui_start_ch_sp: "ui_start_ch_sp.png",
  ui_start_mm_sp: "ui_start_mm_sp.png",
  ui_score_sp2: "ui_score_sp2.png"
};


const MODE = {
  ch: {
    name: "ğŸ¶ ãƒãƒ£ãƒ¼ã™ã‘ã‚³ãƒ¼ã‚¹",
    desc: "ğŸ› /â›½ã§å›å¾©ã€ğŸ›ã§åŠ é€Ÿã€ğŸ—ºã§å…ˆèª­ã¿ã€ğŸ§­ã§æ•µDOWNã€‚30ç§’ã§âš¡ã‚’é›†ã‚ã‚ˆã†ï¼",
    playerKey: "ch_player",
    itemEvery: ["ch_repair","ch_map","ch_compass"],
    itemRare5: ["ch_station","ch_curry"],
    bgm: "bgm_ch_game.mp3"
  },
  mm: {
    name: "ğŸ± ãƒŸãƒ©ã¾ã‚‹ã‚³ãƒ¼ã‚¹",
    desc: "ğŸ™ã§å›å¾©ã€ğŸ¡ã§åŠ é€Ÿã€ğŸµã§æ•µDOWNã€ğŸ˜ã§ãƒ€ãƒ¡ãƒ¼ã‚¸ç„¡åŠ¹1å›ã€‚30ç§’ã§âš¡ã‚’é›†ã‚ã‚ˆã†ï¼",
    playerKey: "mm_player",
    itemEvery: ["mm_onigiri","mm_dango"],
    itemRare5: ["mm_senbei","mm_tea"],
    bgm: "bgm_mm_game.mp3"
  }
};
const RESULT_BGM = {
  ch: {
    clear: "bgm_ch_clear.mp3",
    over:  "bgm_ch_clear.mp3"
  },
  mm: {
    clear: "bgm_mm_clear.mp3",
    over:  "bgm_mm_clear.mp3"
  }
};

const ENEMY_Y_OFFSET = {
  pitfall:{ pc:120, sp:170 },
  construction:{ pc:120, sp:170 },
  traffic:{ pc:120, sp:170 },
  trouble:{ pc:120, sp:170 }
};

/* =========================================================
  3) éŸ³æºï¼ˆSEï¼‰
  â€»ã‚ãªãŸã®æŒ‡å®šã‚’ãã®ã¾ã¾åæ˜ 
========================================================= */
const SE_SRC = {
  // æ“ä½œ
  jump: "se_jump.mp3",
  countdown: "se_countdown.mp3",

  // å–å¾—
  lightning: "se_get_lightning.mp3",                 // âš¡
  itemCommon: "GB-Action01-09(Item).mp3",            // ğŸ™ğŸ˜ğŸ—ºğŸ§­ ãªã©
  itemRare: "NES-Action01-12(Item).mp3",             // ğŸ›ğŸµ
  
  // è¢«å¼¾
  hitConstruction: "SNES-Action01-13(Defeat).mp3",   // å·¥äº‹ä¸­
  hitPitfall: "GB-Action01-06(Miss).mp3",            // ç©´
  hitTraffic: "Car_Horn-Fake03-1.mp3",               // ğŸš—
  hitTrouble: "SNES-Action01-13(Defeat).mp3",        // ğŸ’¥ï¼ˆæŒ‡å®šãªã—ãªã®ã§å·¥äº‹ã¨åŒç³»çµ±ã§ï¼‰
  
  // çµæœï¼ˆæŒ‡å®šãŒãªã„ã®ã§ã€å¿…è¦ãªã‚‰å·®ã—æ›¿ãˆã¦OKï¼‰
  clear: "NES-Action01-12(Item).mp3",
  gameover: "SNES-Action01-13(Defeat).mp3"
};

/* =========================================================
  4) Canvas / DOM
========================================================= */
const canvas = document.getElementById("game");
// â­ ã‚¿ã‚¤ãƒˆãƒ«è¦ç´ å–å¾—
const titleBg = document.getElementById("titleBg");
const titleVideo = document.getElementById("titleVideo");
const titleStartBtn = document.getElementById("titleStartBtn");
const mobileLayer = document.getElementById("mobileLayer");
titleVideo.poster = "ui_main_sp.png";

const ctx = canvas.getContext("2d");
const damageFlash = document.getElementById("damageFlash");
const feverLayer = document.getElementById("feverLayer");
let groundY = 0;
let mobileFrameRect = null;
let canvasPressFx = null; // Canvasä¸Šãƒœã‚¿ãƒ³ã®æŠ¼ä¸‹ãƒã‚¤ãƒ©ã‚¤ãƒˆ
let pcCourseHoverMode = null; // "mm" | "ch" | null


canvas.style.touchAction = "none";

// â­ è¿½åŠ ï¼ˆÃ—ãƒœã‚¿ãƒ³å–å¾—ï¼‰
const closeBtn = document.getElementById("closeBtn");
const shareTapXBtn = document.getElementById("shareTapX");
const shareTapLINEBtn = document.getElementById("shareTapLINE");

function hideMobileEndShareButtons(){
  if(shareTapXBtn) shareTapXBtn.style.display = "none";
  if(shareTapLINEBtn) shareTapLINEBtn.style.display = "none";
}
function syncMobileEndShareButtons(){
  if(!shareTapXBtn || !shareTapLINEBtn) return;
  if(!isMobile() || state !== STATE.END){
    hideMobileEndShareButtons();
    return;
  }
  const rects = getMobileEndShareRectsScreen();
  if(!rects){
    hideMobileEndShareButtons();
    return;
  }
  const applyRect = (el, r)=>{
    el.style.display = "block";
    el.style.left = r.x + "px";
    el.style.top = r.y + "px";
    el.style.width = r.w + "px";
    el.style.height = r.h + "px";
  };
  applyRect(shareTapXBtn, rects.x);
  applyRect(shareTapLINEBtn, rects.line);
}
shareTapXBtn?.addEventListener("click",(e)=>{
  e.preventDefault();
  e.stopPropagation();
  shareToX();
});
shareTapLINEBtn?.addEventListener("click",(e)=>{
  e.preventDefault();
  e.stopPropagation();
  shareToLINE();
});


// â­ã‚¹ãƒãƒ›ç¸¦æ¨ªãƒ•ã‚£ãƒƒãƒˆï¼ˆè¦‹åˆ‡ã‚Œé˜²æ­¢ï¼‰
function detectMobile(){
  const ua = navigator.userAgent || "";
  const uaMobile = /iPhone|Android.+Mobile|iPad|iPod/i.test(ua);
  const uaDataMobile = !!(navigator.userAgentData && navigator.userAgentData.mobile);
  // iPadOS desktop UAå¯¾ç­–: Macintosh ãªã®ã«ã‚¿ãƒƒãƒãƒã‚¤ãƒ³ãƒˆãŒå¤šã„
  const ipadDesktopMode = /Macintosh/i.test(ua) && (navigator.maxTouchPoints || 0) > 1;
  return uaMobile || uaDataMobile || ipadDesktopMode;
}
let mobileMode = detectMobile();
function isMobile(){
  return mobileMode;
}
const MOBILE_SPRITE_SCALE = 1.08; // ã‚¹ãƒãƒ›ã®ã‚­ãƒ£ãƒ©/ã‚¢ã‚¤ã‚³ãƒ³ã‚’å°‘ã—ã ã‘å¤§ãã
function spSpriteSize(size){
  return isMobile() ? Math.round(size * MOBILE_SPRITE_SCALE) : size;
}
const MOBILE_STAGE_WIDTH_RATIO = 0.98; // ã‚¹ãƒãƒ›ã ã‘å°‘ã—æ¨ªå¹…ã‚’ç‹­ãã™ã‚‹
function getMobileStageRect(){
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const stageW = Math.round(vw * MOBILE_STAGE_WIDTH_RATIO);
  const stageH = vh;
  const left = Math.round((vw - stageW) / 2);
  return { left, top: 0, width: stageW, height: stageH };
}
function useOverlayLayout(){
  // PCã«ã¯çµ¶å¯¾é©ç”¨ã—ãªã„
  return isMobile();
}
function refreshDeviceMode(){
  mobileMode = detectMobile();
}

function fitCanvas(){
  refreshDeviceMode();

  let baseW;
  let baseH;

  // ã‚¹ãƒãƒ›: UIç”»åƒã‚µã‚¤ã‚ºå„ªå…ˆ / PC: ç¾çŠ¶ç¶­æŒ
  if(isMobile()){
    const spUiImg = UI?.sound_sp?.ok ? UI.sound_sp.img : null;
    if(spUiImg && spUiImg.naturalWidth && spUiImg.naturalHeight){
      baseW = spUiImg.naturalWidth;
      baseH = spUiImg.naturalHeight;
    }else{
      baseW = 960;  // fallback
      baseH = 1400; // fallback
    }
  }else{
    baseW = 960;
    baseH = 540;
  }

  // Canvaså†…éƒ¨ã‚µã‚¤ã‚º
  canvas.width  = baseW;
  canvas.height = baseH;

  // åœ°é¢ä½ç½®: ã‚¹ãƒãƒ›ã¯æ¯”ç‡ã€PCã¯ç¾çŠ¶ç¶­æŒ
  // ã‚¹ãƒãƒ›ã®åœ°é¢åŸºæº–ã‚’å°‘ã—ä¸Šã’ã‚‹ï¼ˆã‚­ãƒ£ãƒ©/ã‚¢ã‚¤ãƒ†ãƒ /éšœå®³ç‰©ã‚’ã¾ã¨ã‚ã¦ä¸Šã«å¯„ã›ã‚‹ï¼‰
  groundY = isMobile() ? (canvas.height * 0.58) : (canvas.height - 200);

  const vw = window.innerWidth;
  const vh = window.innerHeight;

  if(isMobile()){
    const stageRect = getMobileStageRect();
    mobileFrameRect = stageRect;
    canvas.style.position = "absolute";
    canvas.style.left = stageRect.left + "px";
    canvas.style.top = stageRect.top + "px";
    canvas.style.width = stageRect.width + "px";
    canvas.style.height = stageRect.height + "px";
    canvas.style.margin = "0";
  }else{
    const scale = Math.min(vw/baseW, vh/baseH);
    canvas.style.position = "static";
    canvas.style.left = "";
    canvas.style.top = "";
    canvas.style.width  = (baseW * scale) + "px";
    canvas.style.height = (baseH * scale) + "px";
    canvas.style.margin = "0";
    mobileFrameRect = null;
  }

  syncTitleLayout();
  syncMobileLayerLayout();
}

window.addEventListener("resize", fitCanvas);
window.addEventListener("orientationchange", fitCanvas);
window.addEventListener("load", fitCanvas);

fitCanvas();

const loadingEl   = document.getElementById("loading");

function enterSoundSelect(){
  state = STATE.SOUND;
  try{ titleVideo.pause(); }catch(e){}
}

function syncTitleLayout(){
  if(!isMobile()) return;

  const rect = mobileFrameRect || canvas.getBoundingClientRect();
  const rectBottom = rect.top + rect.height;
  const framePadX = rect.width * 0.08;
  const framePadTop = rect.height * 0.10;
  const framePadBottom = rect.height * 0.17;

  titleVideo.style.left = (rect.left + framePadX) + "px";
  titleVideo.style.top = (rect.top + framePadTop) + "px";
  titleVideo.style.width = (rect.width - framePadX * 2) + "px";
  titleVideo.style.height = (rect.height - framePadTop - framePadBottom) + "px";
  titleVideo.style.transform = "none";
  titleVideo.style.objectFit = "cover";

  const btnW = Math.min(rect.width * 0.78, 420);
  titleStartBtn.style.left = (rect.left + rect.width/2) + "px";
  titleStartBtn.style.transform = "translateX(-50%)";
  titleStartBtn.style.width = btnW + "px";
  titleStartBtn.style.bottom = (window.innerHeight - rectBottom + rect.height * 0.03) + "px";
}

function syncMobileLayerLayout(){
  if(!useOverlayLayout()) return;
  const stageRect = getMobileStageRect();
  const bgRect = { left: 0, top: stageRect.top, width: window.innerWidth, height: stageRect.height };
  const gameBgOnly = (state === STATE.GAME);
  const mobileLayerRect = bgRect;
  mobileLayer.style.left = mobileLayerRect.left + "px";
  mobileLayer.style.right = "";
  mobileLayer.style.width = mobileLayerRect.width + "px";
  const mobileLayerTopOffset = gameBgOnly ? Math.round(stageRect.height * 0.027) : 0;
  mobileLayer.style.top = (mobileLayerRect.top - mobileLayerTopOffset) + "px";
  mobileLayer.style.height = (mobileLayerRect.height + mobileLayerTopOffset) + "px";
  mobileLayer.style.objectFit = "cover";
  mobileLayer.style.objectPosition = gameBgOnly ? "center 5%" : "center bottom";
  mobileLayer.style.clipPath = "none";
  titleVideo.style.left = stageRect.left + "px";
  titleVideo.style.right = "";
  titleVideo.style.width = stageRect.width + "px";
  titleVideo.style.top = stageRect.top + "px";
  titleVideo.style.height = stageRect.height + "px";
  titleVideo.style.objectFit = "cover";
  titleVideo.style.objectPosition = "center center";
  titleBg.style.left = bgRect.left + "px";
  titleBg.style.right = "";
  titleBg.style.width = bgRect.width + "px";
  titleBg.style.top = bgRect.top + "px";
  titleBg.style.height = bgRect.height + "px";
  titleBg.style.objectFit = "cover";
  titleBg.style.objectPosition = "center bottom";
}


/* =========================================================
  5) ç”»åƒãƒ­ãƒ¼ãƒ‰
========================================================= */
function loadOneImage(src){
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>resolve({ok:true, img});
    img.onerror = ()=>resolve({ok:false, img:null});
    img.src = src;
  });
}

let I = {}; // game images

/* =========================================================
  6) éŸ³ï¼ˆBGM/SEï¼‰
========================================================= */
let bgm = null;
let feverBgm = null;
let normalBgmSrc = null;
let pendingGameBgmSrc = null; // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†å¾Œã«å†ç”Ÿã™ã‚‹ã‚²ãƒ¼ãƒ BGM
let audioUnlocked = false;
let audioCtx = null;


function stopBgm(){

  // â­é€šå¸¸BGMåœæ­¢
  if(bgm){
    try{
      bgm.pause();
      bgm.currentTime = 0;
      bgm.src = "";
      bgm.removeAttribute("src");
      bgm.load();
    }catch(e){}
  }

  // â­ãƒ•ã‚£ãƒ¼ãƒãƒ¼BGMã‚‚åœæ­¢ï¼ˆâ†ã“ã‚Œè¶…é‡è¦ï¼‰
  if(feverBgm){
    try{
      feverBgm.pause();
      feverBgm.currentTime = 0;
      feverBgm.src = "";
      feverBgm.removeAttribute("src");
      feverBgm.load();
    }catch(e){}
  }

  bgm = null;
  feverBgm = null;
  normalBgmSrc = null;
  pendingGameBgmSrc = null;
}

function playBgm(src, loop=true){

  if(!soundOn) return;

  // â­ PCã§ã‚‚éŸ³å‡ºã‚‹ã‚ˆã†ã«
  if(audioCtx){
    try{ audioCtx.resume(); }catch(e){}
  }

  stopBgm();

  normalBgmSrc = src;

  bgm = new Audio();

  bgm.src = src;
  bgm.loop = loop;
  bgm.volume = 0.6;
  bgm.preload = "auto";

  bgm.playsInline = true;
  bgm.setAttribute("playsinline","");
  bgm.setAttribute("webkit-playsinline","");

  const p = bgm.play();
  if(p && p.catch) p.catch(()=>{});
}


// iOS/Safariå¯¾ç­–ï¼šæœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
function unlockAudioOnce(){

  if(audioUnlocked) return;
  audioUnlocked = true;

  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    audioCtx.resume();
  }catch(e){}

  // â­â­â­ iPhoneéŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
  try{
    const unlock = new Audio("se_jump.mp3"); // â†å¿…ãšå­˜åœ¨ã™ã‚‹éŸ³
    unlock.volume = 0;
    unlock.playsInline = true;
    unlock.setAttribute("playsinline","");
    unlock.setAttribute("webkit-playsinline","");

    const p = unlock.play();
    if(p && p.catch) p.catch(()=>{});

    setTimeout(()=>{
      unlock.pause();
    },60);

  }catch(e){}
}

// SEã¯å¤šé‡å†ç”Ÿã§ãã‚‹ã‚ˆã†ã«cloneã—ã¦é³´ã‚‰ã™
function inFeverNow(){
  return performance.now() < feverUntil;
}

const sePool = {};
const activeSeList = new Set();

function stopAllSE(){
  activeSeList.forEach((a)=>{
    try{
      a.pause();
      a.currentTime = 0;
      a.src = "";
      a.removeAttribute("src");
      a.load();
    }catch(e){}
  });
  activeSeList.clear();
}

function playSE(key){
  if(!soundOn) return;

  const src = SE_SRC[key];
  if(!src) return;

  // åˆå›ã ã‘ç”Ÿæˆï¼ˆè¶…é‡è¦ï¼‰
  if(!sePool[key]){
    sePool[key] = new Audio(src);
  }

  // cloneNode ã¯è¶…è»½ã„
  const a = sePool[key].cloneNode();

a.playsInline = true;   // â† â­è¿½åŠ ï¼ˆè¶…é‡è¦ï¼‰
a.volume = 0.85;


  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ãƒ”ãƒƒãƒUP
  if(inFeverNow()){
    a.playbackRate = 1.25;
  }

  activeSeList.add(a);
  a.addEventListener("ended", ()=>activeSeList.delete(a), { once:true });
  a.addEventListener("pause", ()=>{
    if(a.ended || a.currentTime === 0) activeSeList.delete(a);
  });

  const p = a.play();
  if(p && p.catch) p.catch(()=>{});
}

/* =========================================================
  7) å…¥åŠ›ï¼ˆUIã‚¯ãƒªãƒƒã‚¯åº§æ¨™ / ã‚²ãƒ¼ãƒ æ“ä½œï¼‰
========================================================= */

function getPointerXY(e){

  const rect = canvas.getBoundingClientRect();

  // â­ iOSå®Œå…¨å¯¾å¿œ
  const scaleX = canvas.width  / rect.width;
  const scaleY = canvas.height / rect.height;

  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;

  const x = (clientX - rect.left) * scaleX;
  const y = (clientY - rect.top)  * scaleY;

  return {x,y};
}

function hitBtn(btn, x, y){
  const nx = x / canvas.width;
  const ny = y / canvas.height;

  return (
    nx > btn.x1 &&
    nx < btn.x2 &&
    ny > btn.y1 &&
    ny < btn.y2
  );
}

function hitRect(rect, x, y){
  return (
    x > rect.x &&
    x < rect.x + rect.w &&
    y > rect.y &&
    y < rect.y + rect.h
  );
}

function triggerCanvasPressFx(rect){
  if(!rect) return;
  // ç¾åœ¨ã¯PC/ã‚¹ãƒãƒ›ã¨ã‚‚ã«æŠ¼ä¸‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æ¼”å‡ºã‚’ä½¿ã‚ãªã„
  return;
  canvasPressFx = {
    x: rect.x,
    y: rect.y,
    w: rect.w,
    h: rect.h,
    until: performance.now() + 120
  };
}

function drawCanvasPressFx(){
  if(!canvasPressFx) return;
  // ç¾åœ¨ã¯æœªä½¿ç”¨ï¼ˆä¿é™ºã§æ®‹éª¸ã‚’æ¶ˆã™ï¼‰
  canvasPressFx = null;
  return;
  const remain = canvasPressFx.until - performance.now();
  if(remain <= 0){
    canvasPressFx = null;
    return;
  }
  const alpha = Math.min(1, remain / 120);
  const r = Math.min(24, Math.max(12, Math.min(canvasPressFx.w, canvasPressFx.h) * 0.18));

  ctx.save();
  ctx.globalAlpha = 0.18 + alpha * 0.12;
  ctx.fillStyle = "#ffffff";
  roundRect(ctx, canvasPressFx.x, canvasPressFx.y, canvasPressFx.w, canvasPressFx.h, r);
  ctx.fill();

  ctx.globalAlpha = 0.22 + alpha * 0.15;
  ctx.lineWidth = 3;
  ctx.strokeStyle = "rgba(0,0,0,0.28)";
  roundRect(ctx, canvasPressFx.x + 1.5, canvasPressFx.y + 1.5, canvasPressFx.w - 3, canvasPressFx.h - 3, Math.max(8, r - 2));
  ctx.stroke();
  ctx.restore();
}

function getSoundStartBtnRect(){
  if(isMobile()){
    const w = canvas.width * SOUND_BTN_LAYOUT_SP.width;
    const h = canvas.height * SOUND_BTN_LAYOUT_SP.height;
    return {
      x: canvas.width * SOUND_BTN_LAYOUT_SP.left,
      y: canvas.height * SOUND_BTN_LAYOUT_SP.top,
      w,
      h
    };
  }
  // PCã¯æ—¢å­˜ã®æ¯”ç‡ãƒœã‚¿ãƒ³åˆ¤å®šã‚’ä½¿ã†ãŸã‚æœªä½¿ç”¨ï¼ˆå®‰å…¨ã®ãŸã‚è¿”ã™ï¼‰
  const w = canvas.width * 0.7;
  const h = w * (290 / 906);
  return {
    x: canvas.width * 0.15,
    y: canvas.height * 0.57,
    w,
    h
  };
}

function getMobileFooterButtonRect(assetKey){
  const left = canvas.width * 0.03;
  const top = canvas.height * 0.82;
  const w = canvas.width * 0.94;
  const imgObj = I[assetKey];
  let h;
  if(imgObj?.ok && imgObj.img.naturalWidth && imgObj.img.naturalHeight){
    h = w * (imgObj.img.naturalHeight / imgObj.img.naturalWidth) * 0.90;
  }else{
    h = canvas.height * 0.10;
  }
  return { x:left, y:top, w, h };
}

function drawMobileFooterButtonByState(stateKey){
  if(!isMobile()) return null;
  const assetKey = MOBILE_FOOTER_BTN_BY_STATE[stateKey];
  if(!assetKey) return null;
  const imgObj = I[assetKey];
  const rect = getMobileFooterButtonRect(assetKey);
  if(imgObj?.ok){
    ctx.drawImage(imgObj.img, rect.x, rect.y, rect.w, rect.h);
  }
  return rect;
}

function getMobileFooterButtonHitAreas(stateKey){
  if(!isMobile()) return null;
  const assetKey = MOBILE_FOOTER_BTN_BY_STATE[stateKey];
  if(!assetKey) return null;
  const full = getMobileFooterButtonRect(assetKey);
  const leftW = full.w * 0.17; // å·¦é’ãƒœã‚¿ãƒ³ / å®¶ãƒœã‚¿ãƒ³ã®æƒ³å®šå¹…
  return {
    full,
    left: { x: full.x, y: full.y, w: leftW, h: full.h },
    main: { x: full.x + leftW, y: full.y, w: full.w - leftW, h: full.h }
  };
}

function getPcFooterButtonRect(assetKey){
  if(isMobile()) return null;
  const imgObj = I[assetKey];
  const maxW = canvas.width * 0.62;
  let w = maxW;
  let h = canvas.height * 0.14;
  if(imgObj?.ok && imgObj.img.naturalWidth && imgObj.img.naturalHeight){
    h = w * (imgObj.img.naturalHeight / imgObj.img.naturalWidth);
  }
  const maxH = canvas.height * 0.22;
  if(h > maxH){
    const s = maxH / h;
    h *= s;
    w *= s;
  }
  const x = (canvas.width - w) / 2;
  const y = canvas.height - h - canvas.height * 0.035;
  return { x, y, w, h };
}

function getPcFooterButtonHitAreas(stateKey){
  if(isMobile()) return null;
  const assetKey = getPcFooterButtonAssetByState(stateKey);
  const main = assetKey ? getPcFooterButtonRect(assetKey) : null;
  if(!main) return null;

  // PCã®å·¦é’ãƒœã‚¿ãƒ³ï¼ˆæˆ»ã‚‹/ãƒ›ãƒ¼ãƒ ï¼‰ã¯èƒŒæ™¯ç”»åƒå´ã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€å³ã®ã‚ªãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³åŸºæº–ã§æ¨å®š
  if(stateKey === STATE.COURSE || stateKey === STATE.START || stateKey === STATE.END){
    const leftSize = main.h * 0.95;
    const gap = canvas.width * 0.012;
    const leftShift = (stateKey === STATE.COURSE || stateKey === STATE.START)
      ? (canvas.width * 0.022)
      : 0;
    const left = {
      // é’ãƒœã‚¿ãƒ³ã¯ã‚ªãƒ¬ãƒ³ã‚¸ã®å·¦éš£ã€‚1å€‹åˆ†å·¦ã«ã‚ºãƒ¬ã¦ã„ãŸã®ã§å³ã¸è£œæ­£
      x: main.x - gap + (canvas.width * 0.004) - leftShift,
      y: main.y + (main.h - leftSize) / 2,
      w: leftSize,
      h: leftSize
    };
    // å³ã‚ªãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³ã®åˆ¤å®šã¯å°‘ã—å³ã¸å¯„ã›ã¦ã€é’ãƒœã‚¿ãƒ³å´ã«ã‹ã¶ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
    const mainAdjusted = {
      x: main.x + (canvas.width * 0.01),
      y: main.y,
      w: main.w - (canvas.width * 0.01),
      h: main.h
    };
    return { left, main: mainAdjusted };
  }

  return { main };
}

function getPcCourseChoiceRects(){
  if(isMobile()) return null;
  return {
    mm: {
      x: canvas.width * 0.009,
      y: canvas.height * 0.22,
      w: canvas.width * 0.245,
      h: canvas.height * 0.49
    },
    ch: {
      x: canvas.width * 0.253,
      y: canvas.height * 0.22,
      w: canvas.width * 0.245,
      h: canvas.height * 0.49
    }
  };
}

function drawPcCourseSelectionOverlay(){
  if(isMobile() || state !== STATE.COURSE) return;
  const rects = getPcCourseChoiceRects();
  if(!rects) return;

  const drawSelectedFrame = (rect)=>{
    const outerPad = 10;
    const innerPad = 2;
    ctx.save();
    ctx.lineJoin = "round";

    // å¤–å´ã®ç™½æ 
    ctx.strokeStyle = "rgba(255,255,255,0.95)";
    ctx.lineWidth = 8;
    ctx.strokeRect(
      rect.x - outerPad,
      rect.y - outerPad,
      rect.w + outerPad * 2,
      rect.h + outerPad * 2
    );

    // å†…å´ã®é»„è‰²æ 
    ctx.strokeStyle = "rgba(255,220,0,0.98)";
    ctx.lineWidth = 5;
    ctx.strokeRect(
      rect.x - innerPad,
      rect.y - innerPad,
      rect.w + innerPad * 2,
      rect.h + innerPad * 2
    );

    // ã€Œé¸æŠä¸­ã€ãƒãƒƒã‚¸
    const badgeW = Math.min(rect.w * 0.42, 128);
    const badgeH = 42;
    const badgeX = rect.x + rect.w - badgeW - 8;
    const badgeY = rect.y + 10;
    ctx.fillStyle = "rgba(238,238,238,0.98)";
    ctx.strokeStyle = "rgba(150,160,170,0.95)";
    ctx.lineWidth = 3;
    if(ctx.roundRect){
      ctx.beginPath();
      ctx.roundRect(badgeX, badgeY, badgeW, badgeH, 12);
      ctx.fill();
      ctx.stroke();
    }else{
      ctx.fillRect(badgeX, badgeY, badgeW, badgeH);
      ctx.strokeRect(badgeX, badgeY, badgeW, badgeH);
    }
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.font = "900 24px sans-serif";
    ctx.fillStyle = "#1460d2";
    ctx.fillText("é¸æŠä¸­", badgeX + badgeW/2, badgeY + badgeH/2 + 1);
    ctx.restore();
  };

  if(mode === "mm"){
    drawSelectedFrame(rects.mm);
  }else if(mode === "ch"){
    drawSelectedFrame(rects.ch);
  }
}

function drawPcCourseFooterDisabledOverlay(){
  if(isMobile() || state !== STATE.COURSE) return;
  if(mode) return;
  const areas = getPcFooterButtonHitAreas(STATE.COURSE);
  const rect = areas?.main;
  if(!rect) return;

  const dimRect = {
    x: rect.x + rect.w * 0.17,
    y: rect.y + rect.h * 0.04,
    w: rect.w * 0.90,
    h: rect.h * 0.78
  };

  ctx.save();
  ctx.fillStyle = "rgba(255,255,255,0.36)";
  if(ctx.roundRect){
    ctx.beginPath();
    ctx.roundRect(dimRect.x, dimRect.y, dimRect.w, dimRect.h, 18);
    ctx.fill();
  }else{
    ctx.fillRect(dimRect.x, dimRect.y, dimRect.w, dimRect.h);
  }
  ctx.restore();
}

function getPcSoundChoiceRects(){
  if(isMobile()) return null;
  const leftImg = I.btn_sound_ok;
  const rightImg = I.btn_sound_no;
  const maxBtnW = canvas.width * 0.33;
  let btnW = maxBtnW;
  let btnH = canvas.height * 0.14;
  if(leftImg?.ok && leftImg.img.naturalWidth && leftImg.img.naturalHeight){
    btnH = btnW * (leftImg.img.naturalHeight / leftImg.img.naturalWidth);
  }else if(rightImg?.ok && rightImg.img.naturalWidth && rightImg.img.naturalHeight){
    btnH = btnW * (rightImg.img.naturalHeight / rightImg.img.naturalWidth);
  }
  const maxH = canvas.height * 0.20;
  if(btnH > maxH){
    const s = maxH / btnH;
    btnW *= s;
    btnH *= s;
  }
  const gap = canvas.width * 0.04;
  const totalW = btnW * 2 + gap;
  const startX = (canvas.width - totalW) / 2;
  const y = canvas.height - btnH - canvas.height * 0.035;
  return {
    ok: { x: startX, y, w: btnW, h: btnH },
    no: { x: startX + btnW + gap, y, w: btnW, h: btnH }
  };
}

function drawPcSoundChoiceButtons(){
  if(isMobile()) return null;
  const rects = getPcSoundChoiceRects();
  if(!rects) return null;
  if(I.btn_sound_ok?.ok){
    ctx.drawImage(I.btn_sound_ok.img, rects.ok.x, rects.ok.y, rects.ok.w, rects.ok.h);
  }
  if(I.btn_sound_no?.ok){
    ctx.drawImage(I.btn_sound_no.img, rects.no.x, rects.no.y, rects.no.w, rects.no.h);
  }
  return rects;
}

function getPcFooterButtonAssetByState(stateKey){
  if(stateKey === STATE.SOUND) return "btn_exit";
  if(stateKey === STATE.TITLE) return "btn_sound_on";
  if(stateKey === STATE.COURSE) return "btn_course";
  if(stateKey === STATE.START) return "btn_start";
  if(stateKey === STATE.END) return "btn_retry";
  return null;
}

function drawPcFooterButtonByState(stateKey){
  if(isMobile()) return null;
  const assetKey = getPcFooterButtonAssetByState(stateKey);
  if(!assetKey) return null;
  const rect = getPcFooterButtonRect(assetKey);
  const imgObj = I[assetKey];
  if(imgObj?.ok && rect){
    ctx.drawImage(imgObj.img, rect.x, rect.y, rect.w, rect.h);
  }
  return rect;
}

function getMobileSoundChoiceRects(){
  // ã‚¹ãƒãƒ›SOUNDç”»é¢ã®ä¸­å¤®2ãƒœã‚¿ãƒ³ï¼ˆèµ¤æ =éŸ³ã‚ã‚Š / é»’æ =éŸ³ãªã—ï¼‰ã«åˆã‚ã›ãŸåˆ¤å®š
  // ç”»åƒå…¨ä½“ã«å¯¾ã™ã‚‹æ¯”ç‡ã§ç®¡ç†ï¼ˆPCã«ã¯å½±éŸ¿ã—ãªã„ï¼‰
  return {
    on: {
      x: canvas.width * 0.06,
      y: canvas.height * 0.29,
      w: canvas.width * 0.88,
      h: canvas.height * 0.12
    },
    off: {
      x: canvas.width * 0.06,
      y: canvas.height * 0.43,
      w: canvas.width * 0.88,
      h: canvas.height * 0.12
    }
  };
}

function getMobileCourseChoiceRects(){
  return {
    mm: {
      // ç”»é¢ä¸­å¤®ã€œå°‘ã—ä¸Šã€ä¸­å¤®ç·šã®å·¦å´
      x: canvas.width * 0.06,
      y: canvas.height * 0.28,
      w: canvas.width * 0.41,
      h: canvas.height * 0.26
    },
    ch: {
      // ç”»é¢ä¸­å¤®ã€œå°‘ã—ä¸Šã€ä¸­å¤®ç·šã®å³å´
      x: canvas.width * 0.53,
      y: canvas.height * 0.28,
      w: canvas.width * 0.41,
      h: canvas.height * 0.26
    }
  };
}

function getMobileEndShareRectsScreen(){
  if(!isMobile()) return null;
  const layerRect = mobileLayer?.getBoundingClientRect?.();
  if(!layerRect || !layerRect.width || !layerRect.height) return null;
  const srcW = mobileLayer.naturalWidth || canvas.width;
  const srcH = mobileLayer.naturalHeight || canvas.height;
  if(!srcW || !srcH) return null;

  // mobileLayer ã¯ cover + center bottom ã§è¡¨ç¤ºã—ã¦ã„ã‚‹ãŸã‚ã€å®Ÿè¡¨ç¤ºä¸­ã®ç”»åƒé ˜åŸŸã‚’ç®—å‡ºã™ã‚‹
  const scale = Math.max(layerRect.width / srcW, layerRect.height / srcH);
  const drawW = srcW * scale;
  const drawH = srcH * scale;
  const imageRect = {
    left: layerRect.left + (layerRect.width - drawW) / 2,
    top: layerRect.top + (layerRect.height - drawH), // center bottom
    width: drawW,
    height: drawH
  };

  const panel = {
    x: imageRect.width * 0.05,
    y: imageRect.height * 0.28,
    w: imageRect.width * 0.90,
    h: imageRect.height * 0.52
  };
  const shareY = panel.y + panel.h * 0.70;
  const scaleX = imageRect.width / canvas.width;
  const scaleY = imageRect.height / canvas.height;
  const btnSize = 70 * Math.min(scaleX, scaleY);
  const gap = 24 * scaleX;
  const center = imageRect.width / 2;
  const hitPad = Math.max(10, btnSize * 0.20); // å°‘ã—åºƒã‚ã«å–ã‚‹

  return {
    x: {
      x: imageRect.left + center - gap/2 - btnSize - hitPad/2,
      y: imageRect.top + shareY - btnSize/2 - hitPad/2,
      w: btnSize + hitPad,
      h: btnSize + hitPad
    },
    line: {
      x: imageRect.left + center + gap/2 - hitPad/2,
      y: imageRect.top + shareY - btnSize/2 - hitPad/2,
      w: btnSize + hitPad,
      h: btnSize + hitPad
    }
  };
}

function tryHandleMobileEndShareTap(e){
  if(!isMobile() || state !== STATE.END) return false;
  const rects = getMobileEndShareRectsScreen();
  if(!rects) return false;
  const px = e.clientX;
  const py = e.clientY;
  const now = performance.now();

  if(now - (window.__lastShareTapAt || 0) < 450) return false;

  if(hitRect(rects.x, px, py)){
    window.__lastShareTapAt = now;
    shareToX();
    return true;
  }
  if(hitRect(rects.line, px, py)){
    window.__lastShareTapAt = now;
    shareToLINE();
    return true;
  }
  return false;
}

function drawMobileCourseSelectionOverlay(){
  if(!isMobile() || state !== STATE.COURSE) return;

  const rects = getMobileCourseChoiceRects();
  const selectedRect = mode === "mm" ? rects.mm : (mode === "ch" ? rects.ch : null);

  ctx.save();

  if(!selectedRect){
    const footer = getMobileFooterButtonHitAreas(STATE.COURSE);
    if(footer?.main){
      const dimRect = {
        x: footer.main.x + footer.main.w * 0.06,
        y: footer.main.y + footer.main.h * 0.04,
        w: footer.main.w * 0.93,
        h: footer.main.h * 0.72
      };
      ctx.fillStyle = "rgba(255,255,255,0.36)";
      if(ctx.roundRect){
        ctx.beginPath();
        ctx.roundRect(dimRect.x, dimRect.y, dimRect.w, dimRect.h, 22);
        ctx.fill();
      }else{
        ctx.fillRect(dimRect.x, dimRect.y, dimRect.w, dimRect.h);
      }
    }
    ctx.restore();
    return;
  }

  // é¸æŠä¸­ã‚«ãƒ¼ãƒ‰ã‚’å¼·èª¿è¡¨ç¤º
  const outerPad = 12;
  const innerPad = 10;
  const isMmSelected = mode === "mm";
  const outerLeftExtra = isMmSelected ? 14 : 0;
  const outerRightExtra = isMmSelected ? 0 : 14;
  const innerLeftExtra = isMmSelected ? 14 : 0;
  const innerRightExtra = isMmSelected ? 0 : 14;
  ctx.strokeStyle = "rgba(255,255,255,0.95)";
  ctx.lineWidth = 12;
  ctx.strokeRect(
    selectedRect.x - outerPad - outerLeftExtra,
    selectedRect.y - outerPad,
    selectedRect.w + outerPad * 2 + outerLeftExtra + outerRightExtra,
    selectedRect.h + outerPad * 2
  );

  ctx.strokeStyle = "rgba(255,215,0,0.95)";
  ctx.lineWidth = 6;
  ctx.strokeRect(
    selectedRect.x - innerPad - innerLeftExtra,
    selectedRect.y - innerPad,
    selectedRect.w + innerPad * 2 + innerLeftExtra + innerRightExtra,
    selectedRect.h + innerPad * 2
  );

  // ãƒ©ãƒ™ãƒ«
  const badgeW = selectedRect.w * 0.46;
  const badgeH = selectedRect.h * 0.14;
  const badgeX = selectedRect.x + selectedRect.w - badgeW - 12;
  const badgeY = selectedRect.y + 12;
  ctx.fillStyle = "rgba(255,255,255,0.92)";
  ctx.strokeStyle = "rgba(0,0,0,0.25)";
  ctx.lineWidth = 3;
  if(ctx.roundRect){
    ctx.beginPath();
    ctx.roundRect(badgeX, badgeY, badgeW, badgeH, 14);
    ctx.fill();
    ctx.stroke();
  }else{
    ctx.fillRect(badgeX, badgeY, badgeW, badgeH);
    ctx.strokeRect(badgeX, badgeY, badgeW, badgeH);
  }
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillStyle = "#0d56d8";
  ctx.font = "900 24px sans-serif";
  ctx.fillText("é¸æŠä¸­", badgeX + badgeW/2, badgeY + badgeH/2 + 1);

  ctx.restore();
}
// =============================
// â­ Ã—ãƒœã‚¿ãƒ³ â†’ éŸ³é¸æŠã¸æˆ»ã‚‹
// =============================
closeBtn.addEventListener("click",()=>{

  running = false;
  stopBgm();
  stopAllSE();
  feverLayer.classList.remove("show");
  // ã‚¹ãƒãƒ›/PCå…±é€š: å³ä¸ŠÃ—ã¯å¸¸ã«ãƒˆãƒƒãƒ—ï¼ˆéŸ³ã‚ã‚Š/éŸ³ãªã—é¸æŠç”»é¢ï¼‰ã¸æˆ»ã‚‹
  state = STATE.SOUND;

  closeBtn.classList.remove("show");
});

function handleTitleStart(e){
  if(e && e.preventDefault) e.preventDefault();
}
if(titleStartBtn){
  titleStartBtn.addEventListener("pointerdown", handleTitleStart);
  titleStartBtn.addEventListener("click", handleTitleStart);
}

canvas.addEventListener("mousemove",(e)=>{
  if(isMobile()){
    pcCourseHoverMode = null;
    return;
  }
  if(state !== STATE.COURSE){
    pcCourseHoverMode = null;
    return;
  }
  const { x, y } = getPointerXY(e);
  const rects = getPcCourseChoiceRects();
  if(!rects){
    pcCourseHoverMode = null;
    return;
  }
  if(hitRect(rects.mm, x, y)){
    pcCourseHoverMode = "mm";
  }else if(hitRect(rects.ch, x, y)){
    pcCourseHoverMode = "ch";
  }else{
    pcCourseHoverMode = null;
  }
});

canvas.addEventListener("mouseleave",()=>{
  pcCourseHoverMode = null;
});

canvas.addEventListener("pointerdown",(e)=>{
  unlockAudioOnce();
  if(tryHandleMobileEndShareTap(e)) return;
  const { x, y } = getPointerXY(e); 

  if(!isMobile()){
    if(state === STATE.END){
      const pcFooterAreas = getPcFooterButtonHitAreas(STATE.END);
      if(pcFooterAreas?.left && hitRect(pcFooterAreas.left, x, y)){
        triggerCanvasPressFx(pcFooterAreas.left);
        stopBgm();
        state = STATE.SOUND; // èµ¤æ : éŸ³ã‚ã‚Š/éŸ³ãªã—é¸æŠç”»é¢
        return;
      }
      if(pcFooterAreas?.main && hitRect(pcFooterAreas.main, x, y)){
        triggerCanvasPressFx(pcFooterAreas.main);
        stopBgm();
        state = STATE.COURSE; // é»’æ : ã‚³ãƒ¼ã‚¹é¸æŠç”»é¢
        return;
      }
    }

    if(state === STATE.SOUND){
      const soundRects = getPcSoundChoiceRects();
      if(soundRects && hitRect(soundRects.ok, x, y)){
        triggerCanvasPressFx(soundRects.ok);
        soundOn = true;
        state = STATE.TITLE;
        // æ¬¡ç”»é¢é·ç§»å¾Œã«BGMé–‹å§‹
        requestAnimationFrame(()=>playBgm("bgm_common_intro.mp3"));
        return;
      }
      if(soundRects && hitRect(soundRects.no, x, y)){
        triggerCanvasPressFx(soundRects.no);
        soundOn = false;
        stopBgm();
        state = STATE.TITLE;
        return;
      }
    }

    const pcFooterAreas = getPcFooterButtonHitAreas(state);
    const pcFooterRect = pcFooterAreas?.main || null;

    if(state === STATE.TITLE && pcFooterRect && hitRect(pcFooterRect, x, y)){
      triggerCanvasPressFx(pcFooterRect);
      state = STATE.COURSE;
      return;
    }

    if(state === STATE.COURSE && pcFooterAreas?.left && hitRect(pcFooterAreas.left, x, y)){
      triggerCanvasPressFx(pcFooterAreas.left);
      state = STATE.TITLE; // å‰ã®ç”»é¢ã¸æˆ»ã‚‹
      return;
    }
    if(state === STATE.COURSE && pcFooterRect && hitRect(pcFooterRect, x, y)){
      triggerCanvasPressFx(pcFooterRect);
      if(!mode) return;
      state = STATE.START;
      return;
    }

    if(state === STATE.START && pcFooterAreas?.left && hitRect(pcFooterAreas.left, x, y)){
      triggerCanvasPressFx(pcFooterAreas.left);
      state = STATE.COURSE; // å‰ã®ç”»é¢ã¸æˆ»ã‚‹
      return;
    }
    if(state === STATE.START && pcFooterRect && hitRect(pcFooterRect, x, y)){
      triggerCanvasPressFx(pcFooterRect);
      startBtnPressUntil = performance.now() + 120;
      setTimeout(()=>{ startGame(); },120);
      return;
    }

  }

  if(isMobile()){
    const footerHit = getMobileFooterButtonHitAreas(state);
    if(footerHit){
      // TITLE: ã‚²ãƒ¼ãƒ ã§éŠã¶ãƒœã‚¿ãƒ³ï¼ˆå…¨ä½“ï¼‰â†’ æ¬¡ç”»é¢ã¸
      if(state === STATE.TITLE && hitRect(footerHit.full, x, y)){
        triggerCanvasPressFx(footerHit.full);
        state = STATE.COURSE;
        return;
      }
      // SOUND: é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ç”»åƒï¼ˆç¾çŠ¶ã¯ç”»é¢é·ç§»ã•ã›ãªã„ï¼‰
      if(state === STATE.SOUND && hitRect(footerHit.full, x, y)){
        triggerCanvasPressFx(footerHit.full);
        state = STATE.TITLE;
        return;
      }
      // COURSE/START: å·¦é’ãƒœã‚¿ãƒ³ã§1ã¤å‰ã¸æˆ»ã‚‹
      if(state === STATE.COURSE && hitRect(footerHit.left, x, y)){
        triggerCanvasPressFx(footerHit.left);
        state = STATE.TITLE;
        return;
      }
      // COURSE: ä¸‹éƒ¨ãƒœã‚¿ãƒ³ã§æ¬¡ã¸ï¼ˆé¸æŠæ¸ˆãƒ¢ãƒ¼ãƒ‰ã‚’ç¢ºå®šï¼‰
      if(state === STATE.COURSE && hitRect(footerHit.main, x, y)){
        triggerCanvasPressFx(footerHit.main);
        if(!mode) return;
        state = STATE.START;
        return;
      }
      if(state === STATE.START && hitRect(footerHit.left, x, y)){
        triggerCanvasPressFx(footerHit.left);
        state = STATE.COURSE;
        return;
      }
      // START: ä¸‹éƒ¨ãƒœã‚¿ãƒ³ã§ã‚²ãƒ¼ãƒ é–‹å§‹
      if(state === STATE.START && hitRect(footerHit.full, x, y)){
        triggerCanvasPressFx(footerHit.full);
        startBtnPressUntil = performance.now() + 120;
        setTimeout(()=>{ startGame(); },120);
        return;
      }
      // END: å·¦ä¸‹ã®å®¶ãƒœã‚¿ãƒ³ã§ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹
      if(state === STATE.END && hitRect(footerHit.left, x, y)){
        triggerCanvasPressFx(footerHit.left);
        stopBgm();
        state = STATE.TITLE;
        return;
      }
      // END: ã‚‚ã†ä¸€åº¦éŠã¶ï¼ˆå‰å‰ã®ç”»é¢ = STARTï¼‰ã¸æˆ»ã‚‹
      if(state === STATE.END && hitRect(footerHit.main, x, y)){
        triggerCanvasPressFx(footerHit.main);
        stopBgm();
        state = STATE.START;
        return;
      }
    }
  }

  // ==========================
// â­ ã‚¿ã‚¤ãƒˆãƒ«å‹•ç”»ã‚¿ãƒƒãƒ—ï¼ˆã‚¹ãƒãƒ›ã ã‘ï¼‰
// ==========================
// â­ ã‚¹ãƒãƒ›ã‚¿ã‚¤ãƒˆãƒ« â†’ ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³åˆ¤å®š
if(state === STATE.TITLE && isMobile()){
  // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã¯ä¸‹éƒ¨ãƒœã‚¿ãƒ³ã§é€²ã‚€ï¼ˆå…¨ä½“ã‚¿ãƒƒãƒ—ã§ã¯é€²ã¾ãªã„ï¼‰
  return;
}

if(state === STATE.TITLE && !isMobile()){
  // PCã‚¿ã‚¤ãƒˆãƒ«ã¯ä¸‹éƒ¨ä¸­å¤®ãƒœã‚¿ãƒ³ã§ã®ã¿é€²ã‚€
  return;
}



  // ==========================
// ğŸ”Š éŸ³ã‚ã‚Š / éŸ³ãªã—é¸æŠ
// ==========================
  if (state === STATE.SOUND) {

  if (isMobile()) {
    const soundChoice = getMobileSoundChoiceRects();
    if (hitRect(soundChoice.on, x, y)) {
      triggerCanvasPressFx(soundChoice.on);
      soundOn = true;
      playBgm("bgm_common_intro.mp3");
      state = STATE.TITLE;
      return;
    }
    if (hitRect(soundChoice.off, x, y)) {
      triggerCanvasPressFx(soundChoice.off);
      soundOn = false;
      stopBgm();
      state = STATE.TITLE;
      return;
    }

  } else {
    // PCã¯ä¸Šã§ãƒ•ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³åˆ¤å®šæ¸ˆã¿ï¼ˆSOUNDâ†’TITLEï¼‰
  }
  return;
}

  // â‘¡ ã‚³ãƒ¼ã‚¹é¸æŠï¼ˆå·¦=ãƒŸãƒ©ã¾ã‚‹ã€å³=ãƒãƒ£ãƒ¼ã™ã‘ï¼‰
if(state===STATE.COURSE){

  if(isMobile()){
    const courseRects = getMobileCourseChoiceRects();
    if(hitRect(courseRects.mm, x, y)){
      triggerCanvasPressFx(courseRects.mm);
      mode = "mm";
    }else if(hitRect(courseRects.ch, x, y)){
      triggerCanvasPressFx(courseRects.ch);
      mode = "ch";
    }
    return;

  }else{
    // PCã¯å·¦å³ã§ã‚³ãƒ¼ã‚¹é¸æŠã®ã¿ï¼ˆé–‹å§‹ã¯ä¸‹éƒ¨ä¸­å¤®ã®btn_courseï¼‰
    const courseRects = getPcCourseChoiceRects();
    if(courseRects && hitRect(courseRects.mm, x, y)){
      mode = "mm";
      return;
    }else if(courseRects && hitRect(courseRects.ch, x, y)){
      mode = "ch";
      return;
    }
    return;
  }
}

  // â‘¢ ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆç”»åƒUIï¼šä¸­å¤®ã®ãƒœã‚¿ãƒ³ç¯„å›²ï¼‰
  if(state===STATE.START){
  if(isMobile()){
    // ã‚¹ãƒãƒ›STARTã¯ä¸‹éƒ¨btn_startã§ã®ã¿é–‹å§‹
    return;
  }
  // PC STARTã‚‚ä¸‹éƒ¨ä¸­å¤®ãƒœã‚¿ãƒ³ã§é–‹å§‹
  return;
}

  // â‘£ ã‚²ãƒ¼ãƒ ä¸­ï¼šã‚¸ãƒ£ãƒ³ãƒ—
  if(state===STATE.GAME){

  // â­ JUMPãƒœã‚¿ãƒ³æŠ¼ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
  if((SHOW_JUMP_BUTTON_MOBILE || isMobile()) && jumpBtnRect){
  if(
    x > jumpBtnRect.x &&
    x < jumpBtnRect.x + jumpBtnRect.w &&
    y > jumpBtnRect.y &&
    y < jumpBtnRect.y + jumpBtnRect.h
  ){
    triggerCanvasPressFx(jumpBtnRect);
    jumpBtnPressUntil = performance.now() + 120; // â†0.12ç§’ã¸ã“ã‚€
    jump();
    return;
  }
}
  // PCã¯ç”»é¢ã‚¯ãƒªãƒƒã‚¯ã§ã‚¸ãƒ£ãƒ³ãƒ—ã€‚ã‚¹ãƒãƒ›ã¯ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ç¯„å›²ã®ã¿ã§ã‚¸ãƒ£ãƒ³ãƒ—
  if(!isMobile()){
    jump();
  }
  return;
}

  // â‘¤ çµ‚äº†ç”»é¢ï¼šã‚‚ã†ä¸€åº¦ / ã‚„ã‚ã‚‹
if(state===STATE.END){

  if(!isMobile()){
    if(hitRect(BTN.shareX, x, y)){
      shareToX();
      return;
    }
    if(hitRect(BTN.shareLINE, x, y)){
      shareToLINE();
      return;
    }
  }

  if(isMobile()){
    // ç”»åƒå†…ã®X/LINEã‚¢ã‚¤ã‚³ãƒ³ç”¨: åºƒã‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é ˜åŸŸï¼ˆã‚¹ãƒãƒ›ENDï¼‰
    if(state === STATE.END){
      const fallbackShareX = {
        x: canvas.width * 0.28,
        y: canvas.height * 0.67,
        w: canvas.width * 0.18,
        h: canvas.height * 0.14
      };
      const fallbackShareLINE = {
        x: canvas.width * 0.50,
        y: canvas.height * 0.67,
        w: canvas.width * 0.20,
        h: canvas.height * 0.14
      };
      if(hitRect(fallbackShareX, x, y)){
        shareToX();
        return;
      }
      if(hitRect(fallbackShareLINE, x, y)){
        shareToLINE();
        return;
      }
    }

    const xRect = BTN.shareX ? {
      x: BTN.shareX.x - 18,
      y: BTN.shareX.y - 18,
      w: BTN.shareX.w + 36,
      h: BTN.shareX.h + 36
    } : null;
    const lineRect = BTN.shareLINE ? {
      x: BTN.shareLINE.x - 18,
      y: BTN.shareLINE.y - 18,
      w: BTN.shareLINE.w + 36,
      h: BTN.shareLINE.h + 36
    } : null;
    if(xRect && hitRect(xRect, x, y)){
      shareToX();
      return;
    }
    if(lineRect && hitRect(lineRect, x, y)){
      shareToLINE();
      return;
    }
    // ã‚¹ãƒãƒ›ENDã¯ä¸‹éƒ¨ãƒœã‚¿ãƒ³ï¼ˆå®¶ / ã‚‚ã†ä¸€åº¦éŠã¶ï¼‰ã‚‚ä½¿ç”¨
    return;

  }else{
    // PC ENDã¯ä¸‹éƒ¨ä¸­å¤®btn_retryã§å†é–‹ï¼ˆä¸Šã§åˆ¤å®šï¼‰
  }
}

});

document.addEventListener("pointerdown",(e)=>{
  // mobileLayer ã¯ pointer-events:none ã ãŒã€å…±æœ‰ã ã‘ã¯ã‚­ãƒ£ãƒ³ãƒã‚¹å¤–ã‚¿ãƒƒãƒ—ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ä¿é™ºã‚’ã‹ã‘ã‚‹
  if(tryHandleMobileEndShareTap(e)){
    e.preventDefault();
  }
});

document.addEventListener("keydown",(e)=>{
  if(e.code==="Space"){
    e.preventDefault();
    unlockAudioOnce();

    // â­ ã‚²ãƒ¼ãƒ ä¸­ã ã‘ã‚¸ãƒ£ãƒ³ãƒ—
    if(state===STATE.GAME){
      jump();
      return;
    }

    // â­ ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã ã‘é–‹å§‹
    if(state===STATE.START){
      startGame();
      return;
    }

    // â­ ENDã§ã¯ä½•ã‚‚ã—ãªã„ï¼ˆâ†ã“ã“ãŒè¿½åŠ ãƒã‚¤ãƒ³ãƒˆï¼‰
  }
});

/* =========================================================
  8) ã‚²ãƒ¼ãƒ æœ¬ä½“ï¼ˆã‚ãªãŸã®æ—¢å­˜ä»•æ§˜ã‚’ç¶­æŒï¼‰
========================================================= */
const GAME_MS = 60_000;
const gravity = isMobile() ? 1.2 : 1.0;
const SHOW_JUMP_BUTTON_MOBILE = false;

function getJumpPower(){
  return isMobile() ? -24 : -21;
}

const BASE_SPEED = 4.5;
const PLAYER_GROUND_OFFSET = isMobile() ? 30 : 20;

let running = false;
let startAt = 0;
let lastCleared = false;

let playCount = 0;        // ãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼šlocalStorage
let gameEvent = null;     // ã“ã®ã‚²ãƒ¼ãƒ ã®ãƒ¬ã‚¢æ 
let used = null;

let player = {};
let score = 0;
let displayScore = 0; // è¡¨ç¤ºç”¨ã‚¹ã‚³ã‚¢ï¼ˆã‚¢ãƒ‹ãƒ¡ç”¨ï¼‰
let combo = 0;
let comboText = "";
let comboTextUntil = 0;
let comboTimeout = 0;
let hp = 3;

let lightnings = [];
let items = [];
let enemies = [];
let bgScrollX = 0;


let lastSpawn = 0;
let spawnCount = 0;
let enemySpawnStreak = 0;

let feverCount = 0;
let feverUntil = 0;

let speedUntil = 0;
let slowUntil  = 0;
let enemyRateDownUntil = 0;
let mapRevealUntil = 0;

let shakeUntil = 0;
let sinkUntil  = 0;
let starsUntil = 0;
let starsAngle = 0;

let popups = [];
let comment = { text:"", until:0 };
let jumpBtnRect = null; 
let jumpBtnPressUntil = 0;
let startBtnPressUntil = 0;
let shieldUntilHit = false; // mmå°‚ç”¨ğŸ˜
let countdownStartAt = 0;
const COUNTDOWN_MS = 4000;

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function getGameElapsedMs(){
  return Math.max(0, Date.now() - startAt - COUNTDOWN_MS);
}
function getCountdownInfo(){
  const dt = performance.now() - countdownStartAt;
  if(dt < 0 || dt >= COUNTDOWN_MS) return null;
  const idx = Math.floor(dt / 1000); // 0,1,2,3
  const label = idx === 0 ? "3" : idx === 1 ? "2" : idx === 2 ? "1" : "GO!";
  return { dt, idx, label };
}

/* å½“ãŸã‚Šåˆ¤å®šï¼ˆå®‰å®šç‰ˆï¼‰ */
function hit(a, b){
  const marginA = 14;
  const marginB = 10;
  return (
    a.x + marginA < b.x + b.w - marginB &&
    a.x + a.w - marginA > b.x + marginB &&
    a.y + marginA < b.y + b.h - marginB &&
    a.y + a.h - marginA > b.y + marginB
  );
}

// æ•µã ã‘ã¯ã‚¹ãƒãƒ›æ™‚ã®è¦‹ãŸç›®æ‹¡å¤§åˆ†ã‚’å°‘ã—ç›¸æ®ºã—ã¦ã€ç†ä¸å°½ãªæ¥è§¦ã‚’æ¸›ã‚‰ã™
function hitEnemy(a, b){
  const marginA = isMobile() ? 20 : 14;
  const marginB = isMobile() ? 18 : 10;
  return (
    a.x + marginA < b.x + b.w - marginB &&
    a.x + a.w - marginA > b.x + marginB &&
    a.y + marginA < b.y + b.h - marginB &&
    a.y + a.h - marginA > b.y + marginB
  );
}

function updateHUD(remainMs){}

function flashDamage(){
  damageFlash.classList.add("show");
  setTimeout(()=>damageFlash.classList.remove("show"), 120);
}

/* ã‚²ãƒ¼ãƒ å›æ•°ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰ */
function storageKeyForCount(){
  return mode === "ch" ? "evrun_playCount_ch" : "evrun_playCount_mm";
}
function loadPlayCount(){
  const raw = localStorage.getItem(storageKeyForCount());
  const n = raw ? parseInt(raw,10) : 0;
  return Number.isFinite(n) ? n : 0;
}
function savePlayCount(n){
  localStorage.setItem(storageKeyForCount(), String(n));
}
function decideGameEvent(){
  const fever = (playCount % 15 === 0);              // 15ã‚²ãƒ¼ãƒ ã«1å›
  const bigLightning = (!fever && playCount % 10 === 0); // 10ã‚²ãƒ¼ãƒ ã«1å›
  const rare5 = (!fever && playCount % 5 === 0);     // 5ã‚²ãƒ¼ãƒ ã«1å›ï¼ˆãƒ¢ãƒ¼ãƒ‰ã®ãƒ¬ã‚¢æ ï¼‰
  return { fever, bigLightning, rare5 };
}

/* ãƒ•ã‚£ãƒ¼ãƒãƒ¼ */
function startFever(){

  const t = performance.now();

  feverUntil = t + 15200; // ãƒ•ã‚£ãƒ¼ãƒãƒ¼BGM/æ¼”å‡ºã‚’ã•ã‚‰ã«ç´„5ç§’å»¶é•·ï¼ˆåˆè¨ˆç´„15ç§’ï¼‰
  feverLayer.classList.add("show");

  // â­ã“ã“ã§ stopBgm ã—ãªã„
  // ï¼ˆplayBgm ãŒå®Œå…¨åœæ­¢ç®¡ç†ã™ã‚‹ã‹ã‚‰ï¼‰

  if(soundOn){

  // â­é€šå¸¸BGMã‚’ä¸€æ™‚åœæ­¢ï¼ˆæ­¢ã‚ãªã„ï¼‰
  if(bgm){
    try{ bgm.pause(); }catch(e){}
  }

  feverBgm = new Audio("bgm_fever.mp3");
  const currentFeverBgm = feverBgm;
  feverBgm.loop = true;
  feverBgm.volume = 0.7;

  feverBgm.playsInline = true;
  feverBgm.setAttribute("playsinline","");
  feverBgm.setAttribute("webkit-playsinline","");

  // iOSãªã©ã§ loop ãŒä¸å®‰å®šãªå ´åˆã«ä¿é™ºã§å†ç”Ÿç¶™ç¶š
  feverBgm.addEventListener("ended", ()=>{
    if(feverBgm !== currentFeverBgm) return;
    if(performance.now() < feverUntil){
      try{
        feverBgm.currentTime = 0;
        const p = feverBgm.play();
        if(p && p.catch){
          p.catch(()=>{
            feverUntil = performance.now();
          });
        }
        return;
      }catch(e){
        feverUntil = performance.now();
      }
    }
  });

  feverBgm.play().catch(()=>{});
}
  say("ğŸŒˆ ãƒ•ã‚£ãƒ¼ãƒãƒ¼çªå…¥ï¼",1100);
}

function endFeverNow(){
  feverLayer.classList.remove("show");

  if(feverBgm){
    try{
      feverBgm.pause();
      feverBgm.currentTime = 0;
    }catch(e){}
    feverBgm = null;
  }

  // é€šå¸¸BGMã‚’å†é–‹ï¼ˆã‚²ãƒ¼ãƒ ä¸­ã®ã¿ï¼‰
  if(running && bgm){
    try{ bgm.play(); }catch(e){}
  }
}

function endFeverIfNeeded(){
  const t = performance.now();
  if(feverUntil <= 0) return;
  if(!feverBgm && t < feverUntil) return;
  if(t >= feverUntil) endFeverNow();
}

/* ã‚¹ãƒãƒ¼ãƒ³ */
function makeLightning(){

  // â­ PCã ã‘æœ€é«˜é«˜ã•ã‚’åˆ¶é™
  const maxHeight = isMobile() ? 120 : 80;

  // â­ 30%ã§åœ°é¢
  if(Math.random() < 0.3){
    return {
      kind:"lightning",
      x: canvas.width,
      y: groundY + 20,
      w:spSpriteSize(50),
      h:spSpriteSize(50)
    };
  }

  // â­ ãã‚Œä»¥å¤–ã¯ç©ºä¸­
  return {
    kind:"lightning",
    x: canvas.width,
    y: groundY - 60 - Math.random()*maxHeight,
    w:spSpriteSize(50),
    h:spSpriteSize(50)
  };
}

function makeItem(key){

  // â­ PC/SPã§ä½ç½®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’åˆ†é›¢
let Y_BASE = isMobile() ? 120 : 60;

// PCã ã‘æœ€é«˜ä½ç½®ã‚’ä¸‹ã’ã‚‹ï¼ˆã“ã“ãŒé‡è¦ï¼‰
let Y_RAND = isMobile() ? 180 : 60;
  let y = groundY - Y_BASE - Math.random()*Y_RAND;

  // ===== å€‹åˆ¥èª¿æ•´ =====
  if(key === "ch_station") y = groundY + (isMobile()?30:10);
  if(key === "lightningBig") y = groundY - (isMobile()?160:110);
  if(key === "ch_repair" || key === "mm_onigiri") y = groundY - (isMobile()?80:40);

    // â­ ã‚¹ãƒãƒ›ã ã‘å°‘ã—å¤§ãã
const itemSize = isMobile() ? spSpriteSize(66) : 56;
const bigSize  = isMobile() ? spSpriteSize(74) : 64;

return {
  type:"item",
  key:key,
  x: canvas.width,
  y: y,
  w:(key==="lightningBig") ? bigSize : itemSize,
  h:(key==="lightningBig") ? bigSize : itemSize
};
}

function makeEnemyByRule(){
  let kind;
  if(spawnCount % 5 === 0) kind = "trouble";
  else if(spawnCount % 2 === 0 && Math.random() < 0.45) kind = "traffic";
  else kind = (Math.random() < 0.52) ? "pitfall" : "construction";

  const h = spSpriteSize(70);
  const device = isMobile() ? "sp" : "pc";
  const yOffset = ENEMY_Y_OFFSET[kind]?.[device] ?? 50;

  return {
    type: "enemy",
    kind,
    x: canvas.width,
    y: groundY - h + yOffset, // â­ åœ°é¢ã‚ˆã‚Šä¸‹ã«æ²ˆã‚ã‚‹
    w: spSpriteSize(70),
    h: h,
    rot: 0
  };
}

/* ã“ã®ã‚²ãƒ¼ãƒ ã®ãƒ¬ã‚¢æ ã‚’ã€Œ1å›ãšã¤ã€æ¶ˆåŒ– */
function trySpawnPlannedEvent(){
  if(spawnCount < 6) return false;

  const t = performance.now();

  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆã“ã®ã‚²ãƒ¼ãƒ 1å›ï¼‰
  if(gameEvent.fever && !used.fever){
    items.push({
      type:"item",
      key:"event_fever",
      x: canvas.width,
      y: groundY - 120,
      w: spSpriteSize(64),
      h: spSpriteSize(64)
    });
    used.fever = true;
    say("ğŸŒˆ ä½•ã‹ç‰¹åˆ¥ãªã‚‚ã®ãŒâ€¦ï¼Ÿ",1000);
    return true;
  }

  if(t < feverUntil) return false;

  // å¤§âš¡ï¼ˆ10å›ã«1å›ï¼šã“ã®ã‚²ãƒ¼ãƒ ã§1å›ï¼‰
  if(gameEvent.bigLightning && !used.bigLightning){
    items.push(makeItem("lightningBig"));
    used.bigLightning = true;
    say("ãŸã¾ã«å¤§âš¡ããŸï¼ğŸ‰", 1000);
    return true;
  }

  // 5å›ã«1å›æ ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
  if(gameEvent.rare5 && !used.rare5){
    const rareKeys = MODE[mode].itemRare5;
    const pick = rareKeys[(playCount/5|0) % rareKeys.length];
    items.push(makeItem(pick));
    used.rare5 = true;

    if(mode==="ch"){
      if(pick==="ch_curry") say("ä»Šå›ã¯ğŸ›æ¥ãŸï¼", 1000);
      else if(pick==="ch_station") say("ä»Šå›ã¯â›½æ¥ãŸï¼", 1000);
      else say("ä»Šæ—¥ã¯ãƒ¬ã‚¢ï¼", 900);
    }else{
      if(pick==="mm_senbei") say("ä»Šå›ã¯ğŸ˜æ¥ãŸï¼", 1000);
      else if(pick==="mm_tea") say("ä»Šå›ã¯ğŸµæ¥ãŸï¼", 1000);
      else say("ä»Šæ—¥ã¯ãƒ¬ã‚¢ï¼", 900);
    }
    return true;
  }
  return false;
}

// â­ âš¡é…ç½®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚²ãƒ¼ãƒ ã£ã½ã„ï¼‰
function spawnLightningPattern(){

  const baseX = canvas.width;
  const r = Math.random();

  // ===== åœ°é¢ãƒ©ã‚¤ãƒ³ï¼ˆåˆå¿ƒè€…å‘ã‘ï¼‰
  if(r < 0.35){

    for(let i=0;i<3;i++){
      lightnings.push({
        kind:"lightning",
        x: baseX + i*80,
        y: groundY + 20,
        w:spSpriteSize(50),h:spSpriteSize(50)
      });
    }
    return;
  }

  // ===== ç¸¦ãƒ©ã‚¤ãƒ³ï¼ˆã‚¸ãƒ£ãƒ³ãƒ—ç”¨ï¼‰
  if(r < 0.65){

    const maxHeight = isMobile() ? 120 : 80;
const y = groundY - 60 - Math.random()*maxHeight;


    for(let i=0;i<2;i++){
      lightnings.push({
        kind:"lightning",
        x: baseX,
        y: y - i * (isMobile() ? 80 : 40),
        w:spSpriteSize(50),h:spSpriteSize(50)
      });
    }
    return;
  }

  // ===== ãªãªã‚ãƒ©ã‚¤ãƒ³ï¼ˆæ°—æŒã¡ã„ã„ï¼‰
  if(r < 0.9){

    const maxHeight = isMobile() ? 120 : 80;
const startY = groundY - 60 - Math.random()*maxHeight;


    for(let i=0;i<3;i++){
      lightnings.push({
        kind:"lightning",
        x: baseX + i*70,
        y: startY - i*40,
        w:spSpriteSize(50),h:spSpriteSize(50)
      });
    }
    return;
  }

  // ===== å˜ç™ºï¼ˆæ™®é€šï¼‰
  lightnings.push(makeLightning());
}

function spawn(){
  const now = Date.now();
  const t = performance.now();
  const inFever = (t < feverUntil);

  let interval = inFever ? 350 : 800;

  if(now - lastSpawn < interval) return;
  lastSpawn = now;

  spawnCount++;

  // ã¾ãšã€Œã“ã®ã‚²ãƒ¼ãƒ ã®äºˆå®šã€ã‚’å‡ºã™
  if(trySpawnPlannedEvent()){
    enemySpawnStreak = 0;
    return;
  }

  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ï¼šæ•µãªã—ï¼†âš¡å¤§é‡
  if(inFever){
    enemySpawnStreak = 0;
    lightnings.push(makeLightning());
    if(Math.random() < 0.35) lightnings.push(makeLightning());
    return;
  }

  // é€šå¸¸ï¼šæ•µ or ã‚¢ã‚¤ãƒ†ãƒ  or âš¡
  const enemyChanceBase = 0.35;
  let enemyChance = (t < enemyRateDownUntil) ? 0.30 : enemyChanceBase;
  if(isMobile() && enemySpawnStreak >= 2){
    enemyChance = 0; // ã‚¹ãƒãƒ›ã¯æ•µ3é€£ç¶šã‚’é˜²ã
  }

  if(Math.random() < enemyChance){
    enemies.push(makeEnemyByRule());
    enemySpawnStreak++;
  }else{
    enemySpawnStreak = 0;
    const r = Math.random();
    const every = MODE[mode].itemEvery;

    if(mode==="ch"){
  if(r < 0.16) items.push(makeItem(every[0]));
  else if(r < 0.28) items.push(makeItem(every[1]));
  else if(r < 0.40) items.push(makeItem(every[2]));
  else if(r < 0.92) spawnLightningPattern();
  else spawnLightningPattern();
}
else{
  if(r < 0.22) items.push(makeItem(every[0]));
  else if(r < 0.44) items.push(makeItem(every[1]));
  else if(r < 0.92) spawnLightningPattern();
  else spawnLightningPattern();
}
  }
}

/* æ“ä½œ */
function jump(){
  if(!running) return;

  const playerGroundY = groundY + PLAYER_GROUND_OFFSET;

  if(player.y === playerGroundY){
    player.vy = getJumpPower();
    playSE("jump");
  }
}

/* åˆæœŸåŒ– */
function resetGameCore(){
  running = false;
  startAt = 0;

  const baseW = isMobile() ? spSpriteSize(100) : 90;

// â­ å…ƒç”»åƒã®æ¯”ç‡å–å¾—
const img = I[MODE[mode].playerKey]?.img;

let w = baseW;
let h = baseW;

if(img){
  const ratio = img.naturalHeight / img.naturalWidth;
  h = w * ratio;
}

player = {
  x: isMobile() ? 46 : 100,
  y: groundY + PLAYER_GROUND_OFFSET,
  w: w,
  h: h,
  vy: 0
};

  score = 0;
displayScore = 0; 
hp = 3;

  lightnings = [];
  items = [];
  enemies = [];

  lastSpawn = 0;
  spawnCount = 0;
  enemySpawnStreak = 0;

  feverCount = 0;
  feverUntil = 0;

  speedUntil = 0;
  slowUntil  = 0;
  enemyRateDownUntil = 0;
  mapRevealUntil = 0;

  shakeUntil = 0;
  sinkUntil  = 0;
  starsUntil = 0;
  starsAngle = 0;

  popups = [];
  comment = { text:"", until:0 };

  shieldUntilHit = false;
  countdownStartAt = 0;

  used = { fever:false, bigLightning:false, rare5:false };
  feverLayer.classList.remove("show");
  updateHUD(GAME_MS);
}

/* é–‹å§‹ */
function startGame(){
  if(!mode) mode = "ch";

  state = STATE.GAME;

  playCount = loadPlayCount() + 1;
  savePlayCount(playCount);

  gameEvent = decideGameEvent();
  resetGameCore();

  stopBgm();
  // 3,2,1,GO ã®SEãŒçµ‚ã‚ã£ã¦ã‹ã‚‰BGMã‚’å†ç”Ÿã™ã‚‹
  pendingGameBgmSrc = MODE[mode].bgm;

  if(gameEvent.fever) say("ä»Šæ—¥ã¯â€¦ç‰¹åˆ¥ãªäºˆæ„Ÿï¼", 1000);
  else if(gameEvent.bigLightning) say("ãŸã¾ã«å¤§âš¡ãã‚‹ã‹ã‚‚ï¼", 1000);
  else if(gameEvent.rare5){
    if(mode==="ch") say("æ¬¡ã¯ãƒ¬ã‚¢ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‚ï¼Ÿ", 1000);
    else say("æ¬¡ã¯ãƒ¬ã‚¢ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‚ï¼Ÿ", 1000);
  }else{
    say("ã„ãã‚ˆãƒ¼ï¼", 900);
  }
  running = true;
  startAt = Date.now();
  countdownStartAt = performance.now();
  // se_countdown.mp3 ãŒã€Œ3,2,1,GOã€ã®ä¸€é€£éŸ³å£°ãªã®ã§é–‹å§‹æ™‚ã«1å›ã ã‘å†ç”Ÿ
  playSE("countdown");
}

/* çµ‚äº† */
function finish(cleared){

  if(!running) return;
  running = false;
  normalBgmSrc = null;
  lastCleared = !!cleared;

  stopBgm();
  state = STATE.END;

  if(soundOn){
    const bgmSrc = cleared
      ? RESULT_BGM[mode].clear
      : RESULT_BGM[mode].over;

    playBgm(bgmSrc, false); 
  }
}  
function getShareText(){
  return `âš¡${score}ã‚¹ã‚³ã‚¢é”æˆï¼
ãƒŸãƒ©ã¾ã‚‹ï¼†ãƒãƒ£ãƒ¼ã™ã‘ã®EVã‚¨ãƒŠã‚¸ãƒ¼ãƒ©ãƒ³âš¡
â–¶ https://ev-plus.jp/lp/energy-run/
#ãƒŸãƒ©ã¾ã‚‹ #ãƒãƒ£ãƒ¼ã™ã‘ #EVã‚¨ãƒŠã‚¸ãƒ¼ãƒ©ãƒ³`;
}

// â­ ã‚·ã‚§ã‚¢å‡¦ç†
function shareToX(){
  const text = getShareText();
  const url = "https://twitter.com/intent/tweet?text=" + encodeURIComponent(text);
  const win = window.open(url, "_blank", "noopener,noreferrer");
  if(!win){
    window.location.href = url;
  }
}

function shareToLINE(){
  const text = getShareText();
  const url = "https://line.me/R/msg/text/?" + encodeURIComponent(text);
  const win = window.open(url, "_blank", "noopener,noreferrer");
  if(!win){
    window.location.href = url;
  }
}

/* æ›´æ–° */
function update(delta){
  const t = performance.now();
  if((t - countdownStartAt) < COUNTDOWN_MS){
    // ã‚«ã‚¦ãƒ³ãƒˆä¸­ã¯ã‚²ãƒ¼ãƒ é€²è¡Œã‚’æ­¢ã‚ã‚‹ï¼ˆè¡¨ç¤ºã ã‘è¡Œã†ï¼‰
    return;
  }

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†å¾Œã«ã‚²ãƒ¼ãƒ BGMã‚’1å›ã ã‘é–‹å§‹
  if(pendingGameBgmSrc){
    const src = pendingGameBgmSrc;
    pendingGameBgmSrc = null;
    playBgm(src);
  }

  bgScrollX -= 2 * delta;
  if(!isMobile() && bgScrollX <= -canvas.width){
    bgScrollX = 0;
  }

// ç‰©ç†
player.vy += gravity * delta;

if(isMobile()){

  // â­ ä¸Šæ˜‡ä¸­ã ã‘ã»ã‚“ã®å°‘ã—ä¼¸ã°ã™
  if(player.vy < 0){
    player.vy += gravity * -0.22 * delta;
 
  }
  // â­ è½ä¸‹ã¯ä»Šã®é€Ÿã•ã‚’ç¶­æŒ
  else{
    player.vy += gravity * 0.75 * delta;
  }
}

player.y += player.vy * delta;

  // åœ°é¢ã«å¸ç€
  const playerGroundY = groundY + PLAYER_GROUND_OFFSET;

if(player.y > playerGroundY){
  player.y = playerGroundY;
  player.vy = 0;
}

  // ã‚¹ãƒãƒ¼ãƒ³
  spawn();

  // é€Ÿåº¦
let curSpeed = BASE_SPEED;

// â­ã‚¹ãƒãƒ›è£œæ­£
if(isMobile()){
  curSpeed *= 0.95;
}

if(t < speedUntil) curSpeed *= 1.25;
if(t < slowUntil)  curSpeed *= 0.72;

// ç§»å‹•ï¼ˆå·¦ã¸æµã™ï¼‰
lightnings.forEach(l => { l.x -= curSpeed * delta; });
items.forEach(it => { it.x -= curSpeed * delta; });
enemies.forEach(en => {
  en.x -= curSpeed * delta;

  if(en.kind === "construction"){
    en.rot += 0.06 * delta;
  }
});

  // +1ãƒãƒƒãƒ—
  popups.forEach(p => { p.y -= 0.6; p.life--; });
  popups = popups.filter(p => p.life > 0);

  // â­âš¡å–å¾—ï¼ˆã‚³ãƒ³ãƒœå¯¾å¿œï¼‰
lightnings = lightnings.filter(l => {

  if(hit(player, l)){

    combo++;
    comboTimeout = performance.now() + 2000; // 2ç§’ä»¥å†…ãªã‚‰ç¶™ç¶š

    // â­ 3ã‚³ãƒ³ãƒœä»¥ä¸Šã§è¡¨ç¤º
if(combo >= 3){
  comboText = combo + " COMBO!";
  comboTextUntil = performance.now() + 800;
}

    const addScore = 10 * combo;
    score += addScore;

    playSE("lightning");

    // â­ ã‚­ãƒ£ãƒ©ä¸Šã«ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º
    popups.push({
      x: player.x + player.w/2 - 10,
      y: player.y - 10,
      text: "+" + addScore,
      life: 40
    });

    if(Math.random() < 0.10) talk("lightning");
    return false;
  }

  return l.x > -60;
});

  // ã‚¢ã‚¤ãƒ†ãƒ å–å¾—ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
  items = items.filter(it=>{
  if(hit(player, it)){

    // å…±é€š
    if(it.key === "lightningBig"){
      score += 50;
      playSE("lightning");
      talk("lightning");
      return false;
    }

    if(it.key === "event_fever"){
      playSE("itemRare");
      startFever();
      talk("fever");
      return false;
    }

    // ===== ch =====
    if(mode==="ch"){

      if(it.key === "ch_repair" || it.key === "ch_station"){
        playSE("itemCommon");
        const before = hp;
        hp = clamp(hp + 1, 0, 3);

        if(hp !== before){
          popHP();
          popups.push({
            x: player.x + player.w/2 + 10,
            y: player.y - 10,
            text: "+1",
            life: 40
          });
        }
        talk("heal");
        return false;
      }

      if(it.key === "ch_curry"){
        speedUntil = t + 4200;
        playSE("itemRare");
        talk("speed");
        return false;
      }

      if(it.key === "ch_compass"){
        enemyRateDownUntil = t + 5200;
        playSE("itemCommon");
        talk("enemyDown");
        return false;
      }

      if(it.key === "ch_map"){
        mapRevealUntil = t + 4800;
        playSE("itemCommon");
        talk("map");
        return false;
      }
    }

    // ===== mm =====
    if(mode==="mm"){

      if(it.key === "mm_onigiri"){
        playSE("itemCommon");

        const before = hp;
        hp = clamp(hp + 1, 0, 3);

        if(hp !== before){
          popHP();
          popups.push({
            x: player.x + player.w/2 + 10,
            y: player.y - 10,
            text: "+1",
            life: 40
          });
        }

        talk("heal");
        return false;
      }

      if(it.key === "mm_dango"){
        speedUntil = t + 4200;
        playSE("itemCommon");
        talk("speed");
        return false;
      }

      if(it.key === "mm_tea"){
        enemyRateDownUntil = t + 5200;
        playSE("itemRare");
        talk("enemyDown");
        return false;
      }

      if(it.key === "mm_senbei"){
        shieldUntilHit = true;
        playSE("itemCommon");
        talk("guard");
        return false;
      }
    }
    return false;
  }

  return it.x > -90;
});

  // æ•µè¡çª
  enemies = enemies.filter(en=>{
    if(hitEnemy(player, en)){
      // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯æ•µãŒå‡ºãªã„è¨­è¨ˆã ãŒå¿µã®ãŸã‚
      if(t < feverUntil) return false;

      // mmã®ğŸ˜ã‚¬ãƒ¼ãƒ‰
      if(mode==="mm" && shieldUntilHit){
        shieldUntilHit = false;
        playSE("itemCommon"); // ã‚¬ãƒ¼ãƒ‰éŸ³ï¼ˆå¥½ã¿ã§å·®ã—æ›¿ãˆOKï¼‰
        talk("guard");
        return false;
      }

      flashDamage();
      shakeUntil = t + 220;
      popHP();

      if(en.kind === "traffic"){
        slowUntil = t + 3000;
        playSE("hitTraffic");
        talk("damage");
        return false;
      }

      // ãƒ€ãƒ¡ãƒ¼ã‚¸
      hp = clamp(hp - 1, 0, 3);
      talk("damage");

      if(en.kind === "pitfall"){
        playSE("hitPitfall");
        sinkUntil = t + 650;
      }else if(en.kind === "construction"){
        playSE("hitConstruction");
        starsUntil = t + 900;
        starsAngle = 0;
      }else if(en.kind === "trouble"){
        playSE("hitTrouble");
        shakeUntil = t + 320;
      }else{
        // å¿µã®ãŸã‚
        playSE("hitTrouble");
      }
      return false;
    }
    return en.x > -120;
  });

  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼çµ‚ã‚ã‚Š
  endFeverIfNeeded();

// â­ ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
if(performance.now() > comboTimeout){
  combo = 0;
  comboText = "";
}

if(lightnings.length > 25) lightnings.splice(0,5);
if(items.length > 20) items.splice(0,5);
if(enemies.length > 20) enemies.splice(0,5);

  const remain = GAME_MS - getGameElapsedMs();

if(hp <= 0) finish(false);
else if(remain <= 0) finish(true);
}

// ================================
// â­ ä¸Šéƒ¨ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤º
// ================================
function say(text, duration=1200){
  comment.text = text;
  comment.until = performance.now() + duration;
}

// ================================
// â­ ã‚­ãƒ£ãƒ©å£èª¿ãƒˆãƒ¼ã‚¯ï¼ˆé…åˆ—å¯¾å¿œç‰ˆï¼‰
// ================================
function talk(type){

  const MM = {
    lightning: [
      "ã„ã„æ„Ÿã˜ã‹ã‚‚â€¦",
      "ã¾ã ã„ã‘ã‚‹ã­",
      "é †èª¿ãã†â€¦"
    ],

    fever: [
      "ãªã‚“ã ã‹ã™ã”ãã†â€¦",
      "ã‚­ãƒ©ã‚­ãƒ©ã—ã¦ã‚‹â€¦"
    ],

    heal: [
      "ã¡ã‚‡ã£ã¨å…ƒæ°—ã«ãªã£ãŸã­",
      "å›å¾©ã§ããŸã¿ãŸã„"
    ],

    speed: [
      "å°‘ã—æ€¥ã”ã†ã‹",
      "ã„ã„ãƒšãƒ¼ã‚¹ã ã­"
    ],

    map: [
      "ãªã‚“ã¨ãªãåˆ†ã‹ã‚‹ã‹ã‚‚â€¦",
      "ãƒˆãƒ©ãƒ–ãƒ«ãŒè¦‹ã‚„ã™ããªã£ãŸã¿ãŸã„"
    ],

    enemyDown: [
      "å±ãªããªã•ãã†â€¦",
      "è½ã¡ç€ã„ã¦ã„ã“ã†"
    ],

    guard: [
      "å®ˆã‚‰ã‚Œã¦ã‚‹ã­",
      "å®‰å¿ƒã§ãã‚‹ã‹ã‚‚"
    ],

    damage: [
      "ã ã„ã˜ã‚‡ã†ã¶â€¦ï¼Ÿ",
      "ã„ãŸã„ã£â€¦",
      "æ°—ã‚’ã¤ã‘ã¦â€¦",
      "ã†ã‚ã£â€¦"
    ],
  };

  const CH = {
    lightning: [
      "ã„ã„ã­ï¼",
      "ãƒŠã‚¤ã‚¹ï¼",
      "ãã®èª¿å­ï¼"
    ],

    fever: [
      "ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã ï¼",
      "ã„ã£ãããƒ¼ï¼"
    ],

    heal: [
      "å›å¾©ã—ãŸã‚ˆï¼",
      "ã¾ã ã¾ã ã„ã‘ã‚‹ï¼"
    ],

    speed: [
      "ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼",
      "åŠ é€Ÿã ãƒ¼ï¼"
    ],

    map: [
      "ãƒˆãƒ©ãƒ–ãƒ«ãŒè¦‹ã‚„ã™ããªã£ãŸã‚ˆï¼",
      "ãƒˆãƒ©ãƒ–ãƒ«ã«æ°—ã‚’ã¤ã‘ã¦ï¼"
    ],

    enemyDown: [
      "ãƒˆãƒ©ãƒ–ãƒ«ãŒæ¸›ã£ãŸï¼",
      "ä»ŠãŒãƒãƒ£ãƒ³ã‚¹ï¼"
    ],

    guard: [
      "ã‚¬ãƒ¼ãƒ‰ï¼",
      "å®ˆã‚‰ã‚Œã¦ã‚‹ï¼"
    ],

    damage: [
      "ã‚ã£ï¼",
      "ã¶ã¤ã‹ã£ãŸï¼",
      "ã„ã¦ã£ï¼",
      "å¤§ä¸ˆå¤«ï¼ï¼Ÿ",
      "ã†ã‚ã£ï¼"
    ],
  };

  const dict = (mode==="mm") ? MM : CH;
  const list = dict[type];

  if(!list) return;

  // â­ é…åˆ—ãªã‚‰ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º
  if(Array.isArray(list)){
    const txt = list[Math.floor(Math.random()*list.length)];
    say(txt,900);
  }else{
    say(list,900);
  }
}

/* =========================================================
  9) æç”»ï¼ˆçŠ¶æ…‹åˆ¥ï¼‰
========================================================= */
function drawUI(){
  if(isMobile()){
    if(state===STATE.SOUND){
      // SOUNDä¸‹éƒ¨ãƒœã‚¿ãƒ³ï¼ˆCanvas %é…ç½®ï¼‰
      const btn = drawMobileFooterButtonByState(STATE.SOUND) || getSoundStartBtnRect();
      console.log("[btn_sound_sp] draw rect", {
        canvasW: canvas.width,
        canvasH: canvas.height,
        x: Math.round(btn.x),
        y: Math.round(btn.y),
        w: Math.round(btn.w),
        h: Math.round(btn.h)
      });
      BTN.sound_on_sp = {
        x1: btn.x / canvas.width,
        x2: (btn.x + btn.w) / canvas.width,
        y1: btn.y / canvas.height,
        y2: (btn.y + btn.h) / canvas.height
      };
      if(!I.btn_sound_on?.ok){
        drawFallbackText("btn_sound_on.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
      }
      return;
    }

    if(state===STATE.END){
      // ã‚¹ã‚³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
      if(displayScore < score){
        displayScore += Math.ceil((score - displayScore) * 0.08);
        if(score - displayScore < 1){
          displayScore = score;
        }
      }

      const text = "SCORE " + displayScore.toString().padStart(4,"0");
      // èµ¤æ ç›¸å½“ã®é ˜åŸŸï¼ˆã‚¹ãƒãƒ›ENDï¼‰
      const scoreBox = {
        x: canvas.width * 0.12,
        y: canvas.height * 0.41,
        w: canvas.width * 0.76,
        h: canvas.height * 0.11
      };

      ctx.save();
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillStyle = "#fff";
      ctx.strokeStyle = "#5193ff";

      // æ ã„ã£ã±ã„ã«åã‚ã‚‹ãŸã‚ã«æ–‡å­—ã‚µã‚¤ã‚ºã‚’è‡ªå‹•èª¿æ•´
      let fontSize = Math.floor(scoreBox.h * 0.78);
      ctx.font = `900 ${fontSize}px sans-serif`;
      while(ctx.measureText(text).width > scoreBox.w * 0.96 && fontSize > 24){
        fontSize -= 2;
        ctx.font = `900 ${fontSize}px sans-serif`;
      }
      ctx.lineWidth = Math.max(4, Math.floor(fontSize * 0.10));
      const scoreX = scoreBox.x + scoreBox.w / 2 - (canvas.width * 0.02);
      const scoreY = scoreBox.y + scoreBox.h / 2;
      ctx.strokeText(text, scoreX, scoreY);
      ctx.fillText(text, scoreX, scoreY);
      ctx.restore();

      // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³åº§æ¨™æ›´æ–°ï¼ˆã‚¿ãƒƒãƒ—åˆ¤å®šã‚’ç¶­æŒï¼‰
      const panel = {
        x: canvas.width * 0.05,
        y: canvas.height * 0.28,
        w: canvas.width * 0.90,
        h: canvas.height * 0.52
      };
      const shareY = panel.y + panel.h * 0.70;
      const btnSize = 70;
      const gap = 24;
      const center = canvas.width / 2;
      BTN.shareX = {
        x: center - gap/2 - btnSize,
        y: shareY - btnSize/2,
        w: btnSize,
        h: btnSize
      };
      BTN.shareLINE = {
        x: center + gap/2,
        y: shareY - btnSize/2,
        w: btnSize,
        h: btnSize
      };
      // ã‚¹ãƒãƒ›çµ‚äº†ç”»é¢ã®ã‚·ã‚§ã‚¢æ ï¼ˆç”»åƒå†…ã®X / LINEï¼‰ã‚’ã‚¿ãƒƒãƒ—å¯èƒ½ã«ã™ã‚‹
      drawMobileFooterButtonByState(STATE.END);
      return;
    }

    ctx.fillStyle = "#bbdfff";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    if(mobileUiFallbackMsg){
      drawFallbackText(mobileUiFallbackMsg);
    }
    drawMobileFooterButtonByState(state);
    return;
  }

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,canvas.width,canvas.height);


  if(state===STATE.SOUND){

    const img = isMobile()?UI.sound_sp:UI.sound;

    if(img?.ok){
      ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
      drawPcSoundChoiceButtons();
}else{
  drawFallbackText("ui_sound.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
}
    return;
  }

  if(state===STATE.TITLE){
    const img = UI.title;
    if(img?.ok){
      ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
      drawPcFooterButtonByState(STATE.TITLE);
    }else{
      drawFallbackText("ui_start.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
    }
    return;
  }

  if(state===STATE.COURSE){

    const img = isMobile()?UI.course_sp:UI.course;

    if(img?.ok){
      ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
      drawPcCourseSelectionOverlay();
      drawPcFooterButtonByState(STATE.COURSE);
      drawPcCourseFooterDisabledOverlay();
    }else{
      drawFallbackText("ui_course.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
    }
    return;
  }

  if(state===STATE.START){

  const img = isMobile()
    ? UI.start_sp
    : ((mode === "mm") ? UI.start_mm : (mode === "ch" ? UI.start_ch : UI.start));

  if(img?.ok){

    // â­æŠ¼ã—ãŸç¬é–“ãƒã‚§ãƒƒã‚¯
    const pressed = performance.now() < startBtnPressUntil;

    // â­æŠ¼ã—ãŸæ™‚ã ã‘å°‘ã—ç¸®ã‚€
    if(pressed){
      ctx.save();
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.scale(0.96, 0.96);
      ctx.translate(-canvas.width/2, -canvas.height/2);
    }

    ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
    if(!isMobile()) drawPcFooterButtonByState(STATE.START);

    if(pressed) ctx.restore();

  }else{
    drawFallbackText((!isMobile() && mode==="mm") ? "ui_start_mm.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„" : ((!isMobile() && mode==="ch") ? "ui_start_ch.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„" : "ui_start.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„"));
  }
  return;
}

if(state===STATE.END){

  // â­ ã‚¹ã‚³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
  if(displayScore < score){
    displayScore += Math.ceil((score - displayScore) * 0.08);

    if(score - displayScore < 1){
      displayScore = score;
    }
  }

  const img = isMobile()
    ? (lastCleared ? UI.clear_sp : UI.over_sp)
    : (UI.score || UI.over);

  if(img?.ok){
    ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
  }

  // â­ SCOREè¡¨ç¤ºï¼ˆã‚¹ãƒãƒ›/PCã§åˆ¥ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰
  const panel = isMobile()
    ? {
        x: canvas.width * 0.05,
        y: canvas.height * 0.28,
        w: canvas.width * 0.90,
        h: canvas.height * 0.52
      }
    : {
        x: canvas.width * 0.22,
        y: canvas.height * 0.20,
        w: canvas.width * 0.56,
        h: canvas.height * 0.46
      };

  const text = "SCORE " + displayScore.toString().padStart(4,"0");

  ctx.save();
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillStyle = "#fff";
  ctx.strokeStyle = isMobile() ? "rgba(0,0,0,0.45)" : "#5193ff";

  if(isMobile()){
    ctx.font = "900 44px sans-serif";
    ctx.lineWidth = 6;
    const scoreY = panel.y + panel.h * 0.43;
    ctx.strokeText(text, canvas.width/2, scoreY);
    ctx.fillText(text, canvas.width/2, scoreY);
  }else{
    // PC: èµ¤æ æƒ³å®šã®é ˜åŸŸã«åã¾ã‚‹ã‚ˆã†ã«è¡¨ç¤º
    const scoreBox = {
      x: canvas.width * 0.28,
      y: canvas.height * 0.31,
      w: canvas.width * 0.40,
      h: canvas.height * 0.18
    };
    let fontSize = Math.floor(scoreBox.h * 0.72);
    ctx.font = `900 ${fontSize}px sans-serif`;
    while(ctx.measureText(text).width > scoreBox.w * 0.96 && fontSize > 26){
      fontSize -= 2;
      ctx.font = `900 ${fontSize}px sans-serif`;
    }
    ctx.lineWidth = Math.max(5, Math.floor(fontSize * 0.09));
    const scoreX = scoreBox.x + scoreBox.w / 2 + (canvas.width * 0.02);
    const scoreY = scoreBox.y + scoreBox.h / 2;
    ctx.strokeText(text, scoreX, scoreY);
    ctx.fillText(text, scoreX, scoreY);
  }
  ctx.restore();


// =========================
// â­ ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³
// =========================

if(isMobile()){
  const shareY = panel.y + panel.h * 0.70;
  const btnSize = 70;
  const gap = 24;
  const center = canvas.width / 2;
  BTN.shareX = {
    x: center - gap/2 - btnSize,
    y: shareY - btnSize/2,
    w: btnSize,
    h: btnSize
  };
  BTN.shareLINE = {
    x: center + gap/2,
    y: shareY - btnSize/2,
    w: btnSize,
    h: btnSize
  };
}else{
  // PC: èƒŒæ™¯ç”»åƒå†…ã®X/LINEã‚¢ã‚¤ã‚³ãƒ³ä½ç½®ã«ãƒªãƒ³ã‚¯é ˜åŸŸã‚’åˆã‚ã›ã‚‹ï¼ˆç”»åƒã®é»„è‰²/é»’æ ä½ç½®ï¼‰
  BTN.shareX = {
    x: canvas.width * 0.395,
    y: canvas.height * 0.515,
    w: canvas.width * 0.09,
    h: canvas.height * 0.16
  };
  BTN.shareLINE = {
    x: canvas.width * 0.505,
    y: canvas.height * 0.515,
    w: canvas.width * 0.09,
    h: canvas.height * 0.16
  };
}

if(isMobile()){
  drawShareBtn(BTN.shareX, "X");
  drawShareBtn(BTN.shareLINE, "LINE");
}
if(!isMobile()) drawPcFooterButtonByState(STATE.END);

return;
}
  }

function drawScrollingTileX(img, y, w, h, scrollX, baseX=0){
  if(!img || w <= 0 || h <= 0) return;
  const tileW = Math.max(1, w);
  let offset = scrollX % tileW;
  if(offset > 0) offset -= tileW;

  for(let x = baseX + offset - tileW; x < canvas.width + tileW; x += tileW){
    // ã‚µãƒ–ãƒ”ã‚¯ã‚»ãƒ«ã§ç¶™ãç›®ãŒè¦‹ãˆã‚„ã™ã„ã®ã§ã€ä¸¸ã‚ï¼‹1pxé‡ã­ã¦æã
    const dx = Math.round(x);
    const dw = Math.ceil(w) + 1;
    ctx.drawImage(img, dx, y, dw, h);
  }
}

function drawGame(){
  // èƒŒæ™¯
  if(isMobile()){
    // ãƒ™ãƒ¼ã‚¹èƒŒæ™¯ã¯ mobileLayer å´ã§ãƒ•ãƒ«å¹…è¡¨ç¤ºï¼ˆCanvasã¯å‰æ™¯ãƒ»ã‚²ãƒ¼ãƒ è¦ç´ ã‚’æãï¼‰
    if(!I.bg_sp?.ok){
      ctx.fillStyle = "#bbdfff";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      drawFallbackText("background_sp.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
    }

    // background_sp2.png ã¯ background_sp.png ã¨åŒã˜ã€Œãƒ•ãƒ«å¹…ã‚¹ã‚±ãƒ¼ãƒ«æ¯”ã€ã‚’é©ç”¨ã—ã¦ä¸­å¤®å¯„ã›
    if(I.bg_sp?.ok && I.bg_sp2?.ok){
      const baseImg = I.bg_sp.img;
      const overlayImg = I.bg_sp2.img;
      const baseW = baseImg.naturalWidth || canvas.width;
      const baseScale = canvas.width / baseW; // background_sp.png ã‚’ãƒ•ãƒ«å¹…ã«ã—ãŸæ¯”ç‡

      const ow = (overlayImg.naturalWidth || canvas.width) * baseScale * 0.88;
      // ä¸‹ç«¯ä½ç½®ã¯ãªã‚‹ã¹ãç¶­æŒã—ã¤ã¤ã€ä¸Šå´ã‚’å°‘ã—ç‹­ãã™ã‚‹
      // ä¸­å¤®ã®ã‚²ãƒ¼ãƒ ç”»åƒã ã‘ç¸¦ã‚’å°‘ã—ç¸®ã‚ã‚‹ï¼ˆæ¨ªå¹…ã¯ç¶­æŒï¼‰
      const oh = (overlayImg.naturalHeight || canvas.height) * baseScale * 0.76;
      const ox = (canvas.width - ow) / 2;
      const prevTopRef = (canvas.height - ((overlayImg.naturalHeight || canvas.height) * baseScale * 0.78)) / 2 - (canvas.height * 0.04);
      const baseOy = prevTopRef - (canvas.height * 0.002);
      const cropTopOnly = canvas.height * 0.008; // ä¸Šã ã‘ã»ã‚“ã®å°‘ã—å‰Šã‚‹
      const oy = baseOy + cropTopOnly;
      const drawH = oh - cropTopOnly;
      // å‰æ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å°‘ã—é…ãæµã—ã¦ã€åˆ‡ã‚Šæ›¿ã‚ã‚Šã‚’è‡ªç„¶ã«è¦‹ã›ã‚‹
      drawScrollingTileX(overlayImg, oy, ow, drawH, bgScrollX * 0.72, ox);
    }
  }else{
    const bg = I.bg;
    if(bg && bg.ok){
      ctx.drawImage(bg.img, bgScrollX, 0, canvas.width, canvas.height);
      ctx.drawImage(bg.img, bgScrollX + canvas.width, 0, canvas.width, canvas.height);
    }else{
      ctx.fillStyle = "#fff";
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }
  }

  const t = performance.now();

  // 3,2,1,GO ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºï¼ˆè‰²ã¯ã‚¹ã‚³ã‚¢ã¨åŒç³»ï¼‰
  const countdown = getCountdownInfo();
  if(countdown){
    const alpha = countdown.label === "GO!" ? 0.95 : 0.9;
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    const fontSize = isMobile() ? (countdown.label === "GO!" ? 126 : 138) : (countdown.label === "GO!" ? 108 : 122);
    ctx.font = `900 ${fontSize}px sans-serif`;
    ctx.lineWidth = Math.max(8, Math.floor(fontSize * 0.10));
    ctx.strokeStyle = "#5193ff";
    ctx.fillStyle = "#fff";
    const cx = canvas.width / 2;
    const cy = canvas.height * (isMobile() ? 0.42 : 0.36);
    ctx.strokeText(countdown.label, cx, cy);
    ctx.fillText(countdown.label, cx, cy);
    ctx.restore();
  }

  // å…ˆèª­ã¿ï¼ˆchã®ã¿ï¼‰
if(mode==="ch" && t < mapRevealUntil){
  ctx.save();

  enemies.forEach(en=>{

    // â­ æ•µã®ä¸‹ã«å½±ï¼ˆå…ˆèª­ã¿ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‰
    ctx.globalAlpha = 0.35;
    ctx.fillStyle = "#000";

    ctx.beginPath();
    ctx.ellipse(
      en.x + en.w/2,     // ä¸­å¤®
      en.y + en.h - 6,   // è¶³å…ƒ
      en.w/2.2,          // æ¨ªå¹…
      8,                 // ç¸¦å¹…
      0, 0, Math.PI*2
    );
    ctx.fill();
  });
  ctx.restore();
}

  // ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚²ãƒ¼ãƒ æœ¬ä½“ã®æç”»ã‚’ä¸‹éƒ¨UI/ãƒ†ãƒ­ãƒƒãƒ—é ˜åŸŸã¾ã§å‡ºã•ãªã„
  ctx.save();
  if(isMobile()){
    const footerMaskY = canvas.height * 0.815;
    let clipBottom = footerMaskY;
    const telopOverlap = 12; // å¢ƒç•Œã®ã‚µãƒ–ãƒ”ã‚¯ã‚»ãƒ«éš™é–“å¯¾ç­–
    const mobileGameBtnKey = MOBILE_FOOTER_BTN_BY_STATE[STATE.GAME];
    if(mobileGameBtnKey){
      const gameBtnRect = getMobileFooterButtonRect(mobileGameBtnKey);
      if(t < comment.until && comment.text){
        clipBottom = Math.min(clipBottom, gameBtnRect.y - 56 - telopOverlap);
      }
    }
    ctx.beginPath();
    ctx.rect(0, 0, canvas.width, Math.max(0, clipBottom));
    ctx.clip();
  }

  // âš¡
  lightnings.forEach(l=>{
    if(I.lightning?.ok) ctx.drawImage(I.lightning.img, l.x, l.y, l.w, l.h);
    else { ctx.fillStyle="#ff0"; ctx.fillRect(l.x,l.y,l.w,l.h); }
  });

  // ã‚¢ã‚¤ãƒ†ãƒ 
items.forEach(it=>{
  const imgObj = I[it.key];
  if(imgObj?.ok){
    ctx.drawImage(imgObj.img, it.x, it.y, it.w, it.h);
  }
});

  // æ•µ
  enemies.forEach(en=>{
    ctx.save();
    const imgObj = I[en.kind];
    if(en.kind === "construction" && imgObj?.ok){
      ctx.translate(en.x + en.w/2, en.y + en.h/2);
      ctx.rotate(en.rot);
      ctx.drawImage(imgObj.img, -en.w/2, -en.h/2, en.w, en.h);
    }else{
      if(imgObj?.ok) ctx.drawImage(imgObj.img, en.x, en.y, en.w, en.h);
      else { ctx.fillStyle="#f00"; ctx.fillRect(en.x,en.y,en.w,en.h); }
    }
    ctx.restore();
  });

  // ã‚­ãƒ£ãƒ©ï¼ˆæºã‚Œ/æ²ˆã‚€ï¼‰
  let px = player.x;
  let py = player.y;

  // æºã‚Œ
  if(t < shakeUntil) px += (Math.random()*8 - 4);

  // æ²ˆã‚€
  if(t < sinkUntil){
    const p = 1 - (sinkUntil - t) / 650;
    py += p * 220;
  }

// ã‚­ãƒ£ãƒ©ï¼ˆã·ã«ã£ã¨è†¨ã‚‰ã‚€ã‚¢ãƒ‹ãƒ¡ï¼‰
const playerKey = MODE[mode].playerKey;

// â­ è†¨ã‚‰ã¿å¼·ã•
const scale = 1 + Math.sin(t * 0.015) * 0.04;

const cx = px + player.w/2;
const cy = py + player.h/2;

ctx.save();
ctx.translate(cx, cy);
ctx.scale(scale, scale);
ctx.translate(-cx, -cy);

if(I[playerKey]?.ok){
  ctx.drawImage(I[playerKey].img, px, py, player.w, player.h);
}

ctx.restore();


  // ğŸ˜ã‚¬ãƒ¼ãƒ‰ãƒªãƒ³ã‚°
  if(mode==="mm" && shieldUntilHit){
    ctx.save();
    ctx.globalAlpha = 0.8;
    ctx.strokeStyle = "rgba(255,165,0,.95)";
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.arc(px + player.w/2 + 8, py + player.h/2, 44, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();
  }

  // ğŸš§æ˜Ÿãã‚‹ãã‚‹
  if(t < starsUntil){
    const centerX = px + player.w/2;
    const centerY = py + player.h/2;
    starsAngle += 0.22;
    const r = 44;
    for(let k=0; k<5; k++){
      const a = starsAngle + k*(Math.PI*2/5);
      const sx = centerX + Math.cos(a)*r;
      const sy = centerY + Math.sin(a)*r;
      ctx.save();
      ctx.translate(sx, sy);
      ctx.rotate(a);
      ctx.globalAlpha = 0.9;
      drawStar(ctx, 0, 0, 5, 10, 5);
      ctx.restore();
    }
  }

  // +1ãƒãƒƒãƒ—
popups.forEach(p=>{

  ctx.save();

  const alpha = p.life / 40;
  const scale = 1;

  ctx.globalAlpha = alpha;

  ctx.translate(p.x, p.y);
  ctx.scale(scale, scale);

  // â­ æ–‡å­—å¤§ãã
  ctx.font = "bold 28px sans-serif";
  ctx.textAlign = "center";

  // â­ é»’ãµã¡ï¼ˆè¶…é‡è¦ï¼‰
  ctx.lineWidth = 5;
  ctx.strokeStyle = "#000";
  ctx.strokeText(p.text, 0, 0);

  // â­ ç™½æ–‡å­—
  ctx.fillStyle = "#fff";
  ctx.fillText(p.text, 0, 0);

  ctx.restore();
});

ctx.restore();

if(t < comboTextUntil && comboText){
  ctx.save();
  ctx.font = isMobile() ? "bold 42px sans-serif" : "bold 48px sans-serif";
  ctx.textAlign = "center";
  ctx.lineWidth = 6;
  ctx.strokeStyle = "rgba(0,0,0,0.55)";
  ctx.fillStyle = "#ffe14d";
  ctx.strokeText(comboText, canvas.width/2, canvas.height*0.28);
  ctx.fillText(comboText, canvas.width/2, canvas.height*0.28);
  ctx.restore();
}


// â­ ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤ºï¼ˆPC=ä¸Š / ã‚¹ãƒãƒ›=ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ä¸Šï¼‰
if(t < comment.until && comment.text){
  // ã‚¹ãƒãƒ›ã§ä¸‹éƒ¨è¡¨ç¤ºä½ç½®ã‚’å–ã‚Œãªã„å ´åˆã¯ä¸Šå´ãƒ†ãƒ­ãƒƒãƒ—ã‚’å‡ºã•ãªã„
  if(isMobile() && !jumpBtnRect){
    // SHOW_JUMP_BUTTON_MOBILE=false ã®ã¨ãä¸Šã«å‡ºã¦ã—ã¾ã†ã®ã‚’é˜²ã
  }else{

  ctx.save();

  let boxY;
  let textY;
  const telopH = isMobile() ? 56 : 44;
  const telopOverlap = isMobile() ? 12 : 0;

  // â­ ã‚¹ãƒãƒ› â†’ ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã®ä¸Šã«è¡¨ç¤º
  if(isMobile() && jumpBtnRect){

    boxY = jumpBtnRect.y - telopH; // â† ãƒœã‚¿ãƒ³ã¨ã®è·é›¢ï¼ˆèª¿æ•´OKï¼‰
    textY = boxY + (telopH / 2);

  }else{
    // â­ PC â†’ ä»Šã¾ã§ã¨åŒã˜ä½ç½®
    boxY = 120;
    textY = boxY + (telopH / 2);
  }

  const barY = boxY - telopOverlap;
  const barH = telopH + (telopOverlap * 2);

  // èƒŒæ™¯ãƒãƒ¼
  ctx.globalAlpha = 0.85;
  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fillRect(0, barY, canvas.width, barH);

  // ãƒ†ã‚­ã‚¹ãƒˆ
  ctx.textBaseline = "middle";
  ctx.strokeStyle = "rgba(0,0,0,0.75)";
  ctx.lineWidth = isMobile() ? 5 : 3;
  ctx.fillStyle = "#fff";
  ctx.font = isMobile() ? "900 24px sans-serif" : "900 18px sans-serif";
  ctx.textAlign = "center";
  ctx.strokeText(comment.text, canvas.width/2, textY);
  ctx.fillText(comment.text, canvas.width/2, textY);

  ctx.restore();
  }
}

// ã‚¹ãƒãƒ›GAMEä¸‹éƒ¨: èƒŒæ™¯ç”»åƒã«å«ã¾ã‚Œã‚‹å‰ç”»é¢ãƒœã‚¿ãƒ³/ã‚³ãƒ”ãƒ¼ã‚’éš ã™å¸¯
// ï¼ˆã“ã®å¾Œã«ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã‚’æãã®ã§ã€ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã ã‘è¦‹ãˆã‚‹ï¼‰
if(isMobile()){
  const footerMaskY = canvas.height * 0.815;
  ctx.save();
  ctx.fillStyle = "#5193ff";
  ctx.fillRect(0, footerMaskY, canvas.width, canvas.height - footerMaskY);
  // èƒŒæ™¯ä¸‹éƒ¨ã®ã‚³ãƒ”ãƒ¼æ–‡å­—ã¯ä¸Šæ›¸ãã§å¾©å…ƒ
  ctx.fillStyle = "#00167a";
  ctx.font = "700 22px system-ui,-apple-system,\"Hiragino Sans\",\"Noto Sans JP\",sans-serif";
  ctx.textAlign = "left";
  ctx.textBaseline = "alphabetic";
  const copyText = "@2026 Miraiz ENECHANGE Ltd è‘—ä½œ ãƒŸãƒ©ã‚¤ã‚ºã‚¨ãƒãƒã‚§ãƒ³ã‚¸æ ªå¼ä¼šç¤¾";
  const copyY = canvas.height * 0.981;
  const sidePad = canvas.width * 0.022; // ç«¯ã‹ã‚‰å°‘ã—ä½™ç™½
  const copyX = sidePad;
  const naturalW = ctx.measureText(copyText).width || 1;
  const targetW = canvas.width - sidePad * 2;
  const scaleX = targetW / naturalW;
  ctx.save();
  ctx.translate(copyX, copyY);
  ctx.scale(scaleX, 1);
  ctx.fillText(copyText, 0, 0);
  ctx.restore();
  ctx.restore();
}else{
  // PCã‚²ãƒ¼ãƒ ä¸­ã®ä¸‹éƒ¨ã‚³ãƒ”ãƒ¼
  const copyText = "@2026 Miraiz ENECHANGE Ltd è‘—ä½œ ãƒŸãƒ©ã‚¤ã‚ºã‚¨ãƒãƒã‚§ãƒ³ã‚¸æ ªå¼ä¼šç¤¾";
  ctx.save();
  ctx.fillStyle = "#00167a";
  ctx.font = "700 15px system-ui,-apple-system,\"Hiragino Sans\",\"Noto Sans JP\",sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "alphabetic";
  ctx.fillText(copyText, canvas.width * 0.5, canvas.height * 0.985);
  ctx.restore();
}

  // â­â­â­ JUMPãƒœã‚¿ãƒ³ï¼ˆPCï¼‹ã‚¹ãƒãƒ›ï¼‰
if((!isMobile() && I.btn_jump_footer?.ok) || (isMobile() && I.btn_jump_footer?.ok)){


// â­ ã‚­ãƒ£ãƒ©åŸºæº–ã®åœ°é¢
const playerGroundY = groundY + PLAYER_GROUND_OFFSET;

// â­ åœ°é¢ä¸‹ã‚¹ãƒšãƒ¼ã‚¹
const groundSpace = canvas.height - playerGroundY;

// â­ ã‚µã‚¤ã‚ºå…ˆã«ä½œã‚‹ï¼ˆâ†è¶…é‡è¦ï¼‰
const btnH = groundSpace * 0.55;
const btnW = canvas.width * (isMobile() ? 0.75 : 0.35);
const btnX = (canvas.width - btnW) / 2;

// â­ ä¸‹ã«ãšã‚‰ã™é‡
const offsetY = isMobile() ? 60 : 40;

// â­ Yåº§æ¨™ï¼ˆæœ€å¾Œã«è¨ˆç®—ï¼‰
const btnY = playerGroundY + (groundSpace - btnH) / 2 + offsetY;

if(isMobile()){
  const mobileJumpRect = drawMobileFooterButtonByState(STATE.GAME);
  if(mobileJumpRect){
    jumpBtnRect = mobileJumpRect;
  }else{
    jumpBtnRect = null;
  }
}else if(!isMobile() || SHOW_JUMP_BUTTON_MOBILE){
  ctx.globalAlpha = 0.95;
  const pressing = performance.now() < jumpBtnPressUntil;
  const scale = pressing ? 0.92 : 1; // â†æŠ¼ã—ãŸã‚‰å°ã•ã

  ctx.save();

  ctx.translate(btnX + btnW/2, btnY + btnH/2);
  ctx.scale(scale, scale);
  ctx.translate(-btnW/2, -btnH/2);

  ctx.drawImage(I.btn_jump_footer.img, 0, 0, btnW, btnH);

  ctx.restore();
  ctx.globalAlpha = 1;
  jumpBtnRect = { x: btnX, y: btnY, w: btnW, h: btnH };
}else{
  // ã‚¹ãƒãƒ›ã¯èƒŒæ™¯ç”»åƒã«ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ãŒå«ã¾ã‚Œã‚‹ãŸã‚ã€æç”»ã—ãªãã¦ã‚‚åˆ¤å®šã ã‘ã¯æŒã¤
  jumpBtnRect = isMobile() ? { x: btnX, y: btnY, w: btnW, h: btnH } : null;
}

// =======================
// â­ å³ä¸ŠUIï¼ˆã‚¿ã‚¤ãƒ ï¼‹ã‚¹ã‚³ã‚¢ï¼‰
// =======================
ctx.save();
ctx.textAlign = "right";
ctx.textBaseline = "top";
ctx.fillStyle = "#fff";
ctx.strokeStyle = "rgba(0,0,0,0.4)";

const remainMs = GAME_MS - getGameElapsedMs();
const sec = Math.ceil(Math.max(0, remainMs / 1000));

if(isMobile()){
  // å·¦ä¸Šèµ¤æ ã‚ãŸã‚Šã«ãƒãƒƒãƒ†ãƒªãƒ¼
  const batteryX = canvas.width * 0.03;
  const batteryY = canvas.height * 0.145;
  drawBattery(batteryX, batteryY, hp);

  // å³ä¸Šèµ¤æ ã‚ãŸã‚Šã« TIME / SCORE
  const hudRightX = canvas.width * 0.965;
  const timeY = canvas.height * 0.160;
  const scoreY = canvas.height * 0.195;

  ctx.lineWidth = 8;
  ctx.font = "bold 52px system-ui";
  ctx.strokeText(`TIME ${sec}`, hudRightX, timeY);
  ctx.fillText(`TIME ${sec}`, hudRightX, timeY);

  ctx.font = "bold 40px system-ui";
  ctx.strokeText(`SCORE ${score}`, hudRightX, scoreY);
  ctx.fillText(`SCORE ${score}`, hudRightX, scoreY);
}else{
  ctx.lineWidth = 6;
  ctx.font = "bold 42px system-ui";
  ctx.strokeText(`TIME ${sec}`, canvas.width - 20, 20);
  ctx.fillText(`TIME ${sec}`, canvas.width - 20, 20);

  ctx.font = "bold 28px system-ui";
  ctx.strokeText(`SCORE ${score}`, canvas.width - 20, 70);
  ctx.fillText(`SCORE ${score}`, canvas.width - 20, 70);
  drawBattery(20, 20, hp);
}
ctx.restore();

}
}

function drawFallbackText(msg){
  ctx.save();
  ctx.fillStyle="#111";
  ctx.font="bold 18px sans-serif";
  ctx.fillText(msg, 40, 80);
  ctx.font="14px sans-serif";
  ctx.fillText("ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å†ç¢ºèªã—ã¦ã€index.htmlã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ã„ã¦ã­", 40, 110);
  ctx.restore();
}

const trimCache = new WeakMap();

function getTrimRect(img){
  const cached = trimCache.get(img);
  if(cached) return cached;

  const w = img.naturalWidth;
  const h = img.naturalHeight;
  const c = document.createElement("canvas");
  c.width = w;
  c.height = h;
  const ictx = c.getContext("2d", { willReadFrequently: true });
  ictx.drawImage(img, 0, 0, w, h);
  const data = ictx.getImageData(0, 0, w, h).data;

  let minX = w, minY = h, maxX = -1, maxY = -1;
  for(let y=0; y<h; y++){
    for(let x=0; x<w; x++){
      const i = (y*w + x) * 4;
      const a = data[i+3];
      if(a < 8) continue;
      const r = data[i], g = data[i+1], b = data[i+2];
      const nearWhite = (r > 235 && g > 235 && b > 235);
      if(nearWhite) continue;
      if(x < minX) minX = x;
      if(y < minY) minY = y;
      if(x > maxX) maxX = x;
      if(y > maxY) maxY = y;
    }
  }

  const rect = (maxX >= minX && maxY >= minY)
    ? { sx:minX, sy:minY, sw:maxX-minX+1, sh:maxY-minY+1 }
    : { sx:0, sy:0, sw:w, sh:h };
  trimCache.set(img, rect);
  return rect;
}

function drawCoverToRect(media, dx, dy, dw, dh, srcRect=null){
  const mw = media.videoWidth || media.naturalWidth || 0;
  const mh = media.videoHeight || media.naturalHeight || 0;
  if(!mw || !mh) return null;

  let sx = 0;
  let sy = 0;
  let sw = mw;
  let sh = mh;
  if(srcRect){
    sx = srcRect.sx;
    sy = srcRect.sy;
    sw = srcRect.sw;
    sh = srcRect.sh;
  }

  // object-fit: cover ç›¸å½“ï¼ˆä½™ç™½ãªã—ï¼‰
  const scale = Math.max(dw / sw, dh / sh);
  const cropW = dw / scale;
  const cropH = dh / scale;
  const cx = sx + (sw - cropW) / 2;
  const cy = sy + (sh - cropH) / 2;
  ctx.drawImage(media, cx, cy, cropW, cropH, dx, dy, dw, dh);
  return {x:dx,y:dy,w:dw,h:dh};
}

function ensureUiVideo(src){
  if(titleVideo.dataset.uiSrc !== src){
    try{ titleVideo.pause(); }catch(e){}
    titleVideo.src = src;
    titleVideo.dataset.uiSrc = src;
    titleVideo.load();
  }
  const p = titleVideo.play();
  if(p && p.catch) p.catch(()=>{});
}

function drawCenteredLayer(imgObj, maxRatio=0.96, trimWhite=false, yOffsetRatio=0, cropOverride=null){
  if(!imgObj?.ok) return null;
  const iw = imgObj.img.naturalWidth;
  const ih = imgObj.img.naturalHeight;
  if(!iw || !ih) return null;
  let src;
  if(cropOverride){
    src = {
      sx: Math.floor(iw * cropOverride.x),
      sy: Math.floor(ih * cropOverride.y),
      sw: Math.floor(iw * cropOverride.w),
      sh: Math.floor(ih * cropOverride.h)
    };
  }else{
    src = trimWhite ? getTrimRect(imgObj.img) : { sx:0, sy:0, sw:iw, sh:ih };
  }
  const scale = Math.min((canvas.width * maxRatio) / src.sw, (canvas.height * maxRatio) / src.sh);
  const w = src.sw * scale;
  const h = src.sh * scale;
  const x = (canvas.width - w) / 2;
  const y = (canvas.height - h) / 2 + canvas.height * yOffsetRatio;
  ctx.drawImage(imgObj.img, src.sx, src.sy, src.sw, src.sh, x, y, w, h);
  return {x,y,w,h};
}

function drawStar(ctx, x, y, spikes, outerRadius, innerRadius){
  let rot = Math.PI / 2 * 3;
  let step = Math.PI / spikes;
  ctx.beginPath();
  ctx.moveTo(x, y - outerRadius);
  for(let i=0; i<spikes; i++){
    ctx.lineTo(x + Math.cos(rot) * outerRadius, y + Math.sin(rot) * outerRadius);
    rot += step;
    ctx.lineTo(x + Math.cos(rot) * innerRadius, y + Math.sin(rot) * innerRadius);
    rot += step;
  }
  ctx.lineTo(x, y - outerRadius);
  ctx.closePath();
  ctx.fillStyle = "rgba(255, 200, 0, .95)";
  ctx.strokeStyle = "rgba(255, 140, 0, .95)";
  ctx.lineWidth = 2;
  ctx.fill(); ctx.stroke();
}

function roundRect(ctx, x, y, w, h, r){

  r = Math.min(r, w/2, h/2);
  if(ctx.roundRect){
    ctx.beginPath();
    ctx.roundRect(x, y, w, h, r);
    return;
  }
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}

let lastTime = 0;
let titleVisible = false;
let frameOnlyVisible = false;
let mobileGameLayoutApplied = false;

function applyMobileBodyBg(stateKey){
  void stateKey;
  if(!isMobile()) return;
  document.body.style.background = "#bbdfff";
}

function syncMobileOverlayByState(stateKey){
  if(!isMobile()){
    mobileLayer.style.display = "none";
    titleVideo.style.display = "none";
    titleBg.style.display = "none";
    return;
  }

  applyMobileBodyBg(stateKey);
  syncMobileLayerLayout();
  mobileLayer.style.zIndex = "140";

  mobileLayer.style.display = "none";
  titleVideo.style.display = "none";
  titleBg.style.display = (stateKey === STATE.SOUND) ? "block" : "none";

  if(stateKey === STATE.SOUND){
    // SOUNDã¯ ui_sound_sp.png ã‚’èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¡¨ç¤º + Canvasä¸Šãƒœã‚¿ãƒ³
    titleBg.style.display = "none";
    mobileLayer.onerror = ()=>{
      mobileUiFallbackMsg = "ui_sound_sp.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„";
    };
    mobileLayer.onload = ()=>{
      mobileUiFallbackMsg = "";
    };
    mobileLayer.src = "ui_sound_sp.png";
    mobileLayer.style.zIndex = "90";
    mobileLayer.style.display = "block";
    return;
  }

  if(stateKey === STATE.TITLE){
    mobileLayer.onerror = ()=>{
      mobileUiFallbackMsg = "ui_start_sp.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„";
    };
    mobileLayer.onload = ()=>{
      mobileUiFallbackMsg = "";
    };
    mobileLayer.src = "ui_start_sp.png";
    mobileLayer.style.zIndex = "90";
    mobileLayer.style.display = "block";
    return;
  }

  if(stateKey === STATE.COURSE){
    mobileLayer.onerror = ()=>{
      mobileUiFallbackMsg = "ui_course_sp.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„";
    };
    mobileLayer.onload = ()=>{
      mobileUiFallbackMsg = "";
    };
    mobileLayer.src = "ui_course_sp.png";
    mobileLayer.style.zIndex = "90";
    mobileLayer.style.display = "block";
    return;
  }

  if(stateKey === STATE.START){
    mobileLayer.onerror = ()=>{
      mobileUiFallbackMsg = ((mode === "ch") ? "ui_start_ch_sp.png" : "ui_start_mm_sp.png") + " ãŒè¦‹ã¤ã‹ã‚‰ãªã„";
    };
    mobileLayer.onload = ()=>{
      mobileUiFallbackMsg = "";
    };
    mobileLayer.src = (mode === "ch") ? "ui_start_ch_sp.png" : "ui_start_mm_sp.png";
    mobileLayer.style.zIndex = "90";
    mobileLayer.style.display = "block";
    return;
  }

  if(stateKey === STATE.END){
    mobileLayer.onerror = ()=>{
      mobileUiFallbackMsg = "ui_score_sp.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„";
    };
    mobileLayer.onload = ()=>{
      mobileUiFallbackMsg = "";
    };
    mobileLayer.src = "ui_score_sp.png";
    mobileLayer.style.zIndex = "90";
    mobileLayer.style.display = "block";
    return;
  }

  if(stateKey === STATE.GAME){
    // GAMEèƒŒæ™¯ã¯ mobileLayer å´ã§ãƒ•ãƒ«å¹…è¡¨ç¤ºï¼ˆCanvaså‰æ™¯ã¯åˆ¥æç”»ï¼‰
    titleVideo.style.display = "none";
    titleBg.style.display = "none";
    mobileLayer.onerror = ()=>{
      mobileUiFallbackMsg = "background_sp.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„";
    };
    mobileLayer.onload = ()=>{
      mobileUiFallbackMsg = "";
    };
    mobileLayer.src = "background_sp.png";
    mobileLayer.style.zIndex = "90";
    mobileLayer.style.display = "block";
    return;
  }
}

function setTitleVisible(visible){
  void visible;
}

function setMobileFrameVisible(visible, stateKey){
  if(!visible){
    mobileLayer.style.display = "none";
    titleVideo.style.display = "none";
    return;
  }
  syncMobileOverlayByState(stateKey);
}

function syncMobileGameCanvasLayout(){
  if(!isMobile()) return;
  if(state === STATE.GAME){
    const stageRect = getMobileStageRect();
    const gameLift = Math.round(stageRect.height * 0.03); // ã‚²ãƒ¼ãƒ ç”»é¢ã ã‘å°‘ã—ä¸Šã¸
    canvas.style.left = stageRect.left + "px";
    canvas.style.top = (stageRect.top - gameLift) + "px";
    canvas.style.width = stageRect.width + "px";
    canvas.style.height = (stageRect.height + gameLift) + "px";
    mobileGameLayoutApplied = true;
  }else if(mobileGameLayoutApplied){
    mobileGameLayoutApplied = false;
    fitCanvas();
  }
}

/* =========================================================
  10) æç”»ãƒ«ãƒ¼ãƒ—ï¼ˆå¸¸æ™‚ï¼‰
========================================================= */
function drawFrame(time){
if(isMobile()){
  syncMobileOverlayByState(state);
  syncMobileGameCanvasLayout();
  syncMobileEndShareButtons();
}else{
  mobileLayer.style.display = "none";
  titleVideo.style.display = "none";
  hideMobileEndShareButtons();
}
// â­ SOUNDä»¥å¤–ã¯Ã—è¡¨ç¤º
if(state !== STATE.SOUND){
  closeBtn.classList.add("show");
}else{
  closeBtn.classList.remove("show");
}

  // â­ FPSå·®ã‚’ãªãã™ï¼ˆè¶…é‡è¦ï¼‰
if(!lastTime) lastTime = time;
const delta = (time - lastTime) / 16.67;
lastTime = time;

  if(state===STATE.TITLE || state===STATE.SOUND || state===STATE.COURSE || state===STATE.START || state===STATE.END){
    if(isMobile()){
      // ã‚¹ãƒãƒ›SOUND/ENDã¯Canvasã«é‡ã­æç”»
      if(state===STATE.SOUND || state===STATE.END){
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawUI();
      }else{
        // ãã‚Œä»¥å¤–ã¯HTMLã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã§UIã‚’è¦‹ã›ã‚‹
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if(mobileUiFallbackMsg){
          drawFallbackText(mobileUiFallbackMsg);
        }
        drawMobileFooterButtonByState(state);
        if(state===STATE.COURSE){
          drawMobileCourseSelectionOverlay();
        }
      }
    }else{
      drawUI();
    }
    drawCanvasPressFx();
    requestAnimationFrame(drawFrame);
    return;
  }

  if(state===STATE.GAME){
    if(running) update(delta);
    drawGame();
    drawCanvasPressFx();
    requestAnimationFrame(drawFrame);
    return;
  }

  requestAnimationFrame(drawFrame);
}

/* =========================================================
  11) èµ·å‹•ï¼šç”»åƒãƒ­ãƒ¼ãƒ‰
========================================================= */
async function boot(){
  const uiKeys = Object.keys(UI_SRC).filter((k)=>{
    if(isMobile()) return k.endsWith("_sp");
    return !k.endsWith("_sp");
  });
  const uiLoaded = await Promise.all(uiKeys.map(k=>loadOneImage(UI_SRC[k])));
  uiKeys.forEach((k,idx)=>UI[k]=uiLoaded[idx]);

  const keys = Object.keys(ASSET).filter((k)=>{
    if(k === "bg_sp") return isMobile();
    if(k === "bg") return !isMobile();
    return true;
  });
  const loaded = await Promise.all(keys.map(k => loadOneImage(ASSET[k])));
  keys.forEach((k, idx)=>{ I[k] = loaded[idx]; });

  mobileLayer.style.display = "none";
  titleVideo.style.display = "none";
  titleStartBtn.style.display = "none";

  // UIç”»åƒãƒ­ãƒ¼ãƒ‰å¾Œã«å†ãƒ•ã‚£ãƒƒãƒˆï¼ˆnaturalWidth/Heightã‚’åæ˜ ï¼‰
  fitCanvas();

  loadingEl.style.display = "none";
requestAnimationFrame(drawFrame);
}

// =========================
// â­ ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³æç”»ï¼ˆæ ãªã—ç‰ˆï¼‰
// =========================
function drawShareBtn(rect,label){

  const icon =
    label === "X" ? I.share_x :
    label === "LINE" ? I.share_line : null;

  if(!icon || !icon.ok) return;

  const iconSize = Math.min(rect.w, rect.h) * 0.52;
  const radius = Math.min(rect.w, rect.h) * 0.24;

  ctx.save();
  ctx.fillStyle = "rgba(255,255,255,0.92)";
  ctx.strokeStyle = "rgba(0,0,0,0.12)";
  ctx.lineWidth = 2;
  roundRect(ctx, rect.x, rect.y, rect.w, rect.h, radius);
  ctx.fill();
  ctx.stroke();

  const iw = icon.img.naturalWidth;
  const ih = icon.img.naturalHeight;
  const scale = Math.min(iconSize / iw, iconSize / ih);

  const w = iw * scale;
  const h = ih * scale;

  const ix = rect.x + (rect.w - w)/2;
  const iy = rect.y + (rect.h - h)/2;

  ctx.drawImage(icon.img, ix, iy, w, h);
  ctx.restore();
}

// =======================
// â­ ãƒãƒƒãƒ†ãƒªãƒ¼è¡¨ç¤ºï¼ˆ3å€‹ä¸¦ã³ï¼‰
// =======================
function drawBattery(x,y,hp){

  const size = isMobile() ? 58 : 48;   // é›»æ± ã‚µã‚¤ã‚ºï¼ˆã‚¹ãƒãƒ›ã ã‘ä¸€å›ã‚Šå¤§ããï¼‰
  const gap = isMobile() ? 10 : 8;     // é–“éš”
  const maxHp = 3;

  ctx.save();

  for(let i=0; i<maxHp; i++){

    const bx = x + i * (size + gap);

    // HPã‚ã‚‹åˆ†ã ã‘è¡¨ç¤º
    if(i < hp){

      if(I.ch_item_battery?.ok){
        ctx.drawImage(I.ch_item_battery.img, bx, y, size, size);
      }

    }else{
      // HPãªã„éƒ¨åˆ†ã¯åŠé€æ˜ï¼ˆç©ºé›»æ± ã£ã½ãï¼‰
      if(I.ch_item_battery?.ok){
        ctx.globalAlpha = 0.25;
        ctx.drawImage(I.ch_item_battery.img, bx, y, size, size);
        ctx.globalAlpha = 1;
      }
    }
  }
  ctx.restore();
}
// â­ èµ·å‹•çŠ¶æ…‹ã¯PC/SPã¨ã‚‚ã«SOUND

boot();
function popHP(){} 

</script>
</body>
</html>
