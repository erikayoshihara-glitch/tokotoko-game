<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<title>ãƒŸãƒ©ã¾ã‚‹ï¼†ãƒãƒ£ãƒ¼ã™ã‘ã®EVã‚¨ãƒŠã‚¸ãƒ¼ãƒ©ãƒ³</title>
<style>
html,body{
margin:0;
background:#fff;
overflow:hidden;
height:100dvh;

/* â­ä¸­å¤®å›ºå®šï¼ˆã“ã“ã«å…¥ã‚Œã‚‹ï¼‰ */
display:flex;
align-items:center;
justify-content:center;

font-family:system-ui,-apple-system,"Hiragino Sans","Noto Sans JP",sans-serif;
}

canvas{
display:block;
margin:0;
background:#fff;
touch-action:manipulation;

/* â­ç¸¦æ¨ªã©ã£ã¡ã§ã‚‚åã¾ã‚‹ã‚µã‚¤ã‚º */
width:min(100vw, calc(100dvh * (960/540)));
height:auto;
}



  /* ===== æ¼”å‡º ===== */
  .flash{
    position:fixed; inset:0;
    background:rgba(255,0,0,.28);
    opacity:0; pointer-events:none;
    transition:opacity .15s;
    z-index:20;
  }
  .flash.show{ opacity:1; }

  .fever{
    position:fixed; inset:0;
    opacity:0; pointer-events:none;
    z-index:15;
    background: linear-gradient(
      120deg,
      rgba(255,0,0,.24),
      rgba(255,255,0,.22),
      rgba(0,255,0,.20),
      rgba(0,255,255,.20),
      rgba(0,0,255,.20),
      rgba(255,0,255,.22)
    );
    background-size: 300% 300%;
    animation: rainbowMove 3.6s ease-in-out infinite;
    transition: opacity .25s ease;
  }
  .fever.show{ opacity:1; }
  @keyframes rainbowMove{
    0%{ background-position:0% 50%; }
    50%{ background-position:100% 50%; }
    100%{ background-position:0% 50%; }
  }

  /* ===== HUD ===== */
  .hud{
    position:fixed; left:12px; top:12px;
    display:none; gap:8px; flex-wrap:wrap;
    z-index:25;
    user-select:none;
  }
  .hud.show{ display:flex; }

  .pill{
    background:rgba(255,255,255,.86);
    backdrop-filter: blur(4px);
    border:1px solid rgba(0,0,0,.08);
    border-radius:999px;
    padding:8px 10px;
    font-size:13px;
    font-weight:900;
    color:#111;
    display:flex; align-items:center; gap:8px;
  }
  .tiny{ font-size:12px; color:#333; font-weight:900; }

  .feverBadge{
    display:none;
    animation: pulse .8s ease-in-out infinite;
  }
  .feverBadge.on{ display:flex; }
  @keyframes pulse{ 0%,100%{transform:scale(1);} 50%{transform:scale(1.06);} }

  .hp-pop{ animation: hpPop .28s ease; }
  @keyframes hpPop{ 0%{transform:scale(1);} 50%{transform:scale(1.35);} 100%{transform:scale(1);} }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
  .loading{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    background:#fff;
    z-index:50;
    color:#111;
    font-weight:900;
  }

  .bigTime{
  position:fixed;
  right:16px;
  top:12px;
  z-index:30;

  font-size:56px;
  font-weight:900;
  color:#111;

  background:rgba(255,255,255,.8);
  padding:8px 16px;
  border-radius:16px;

  display:none;
}

.bigTime.show{
  display:block;
}

</style>
</head>

<body>
<canvas id="game" width="960" height="540"></canvas>

<div class="flash" id="damageFlash"></div>
<div class="fever" id="feverLayer"></div>

<div class="loading" id="loading">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

<script>
/* =========================================================
  0) çŠ¶æ…‹ï¼ˆç”»é¢é·ç§»ï¼‰
  éŸ³ã‚ã‚Š/ãªã— â†’ ã‚³ãƒ¼ã‚¹é¸æŠ â†’ ã‚¹ã‚¿ãƒ¼ãƒˆ â†’ ã‚²ãƒ¼ãƒ  â†’ çµæœ
========================================================= */
const STATE = {
  SOUND: "sound",
  COURSE: "course",
  START: "start",
  GAME: "game",
  END: "end"
};

// â­â†“â†“â†“â†“ ã“ã“ã«è¿½åŠ  â†“â†“â†“â†“
const BTN = {

  // ã‚¹ãƒãƒ›ç¸¦ ENDç”»é¢
  end_retry_sp : { x1:0.2, x2:0.8, y1:0.55, y2:0.7 },
  end_exit_sp  : { x1:0.2, x2:0.8, y1:0.72, y2:0.9 },

  // PCæ¨ª ENDç”»é¢
  end_retry_pc : { x1:140/960, x2:460/960, y1:340/540, y2:460/540 },
  end_exit_pc  : { x1:500/960, x2:820/960, y1:340/540, y2:460/540 },

  // ğŸ­ éŸ³é¸æŠï¼ˆã‚¹ãƒãƒ›ï¼šä¸Šä¸‹ãƒœã‚¿ãƒ³ï¼‰â˜…ä¸‹ã«ã‚ºãƒ©ã—ãŸ
sound_on_sp  : { x1:0.15, x2:0.85, y1:0.57, y2:0.72 },
sound_off_sp : { x1:0.15, x2:0.85, y1:0.74, y2:0.90 },



  // â­ éŸ³é¸æŠï¼ˆPCï¼‰
sound_on_pc  : { x1:140/960, x2:420/960, y1:260/540, y2:400/540 },
sound_off_pc : { x1:520/960, x2:800/960, y1:260/540, y2:400/540 },

// â­ ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ï¼ˆè¿½åŠ ï¼‰
shareX: { x:0, y:0, w:0, h:0 },
shareLINE: { x:0, y:0, w:0, h:0 }

};


let state = STATE.SOUND;
let soundOn = true;
let mode = null; // "ch" | "mm"

/* =========================================================
  1) UIç”»åƒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åï¼‰
========================================================= */
const UI_SRC = {
  sound:  "ui_sound_select.png",
  sound_sp: "ui_sound_select_sp.png",

  course: "ui_course_select.png",
  course_sp: "ui_course_select_sp.png",

  start:  "ui_start.png",
  start_sp: "ui_start_sp.png",

  clear:  "ui_game_clear.png",
  clear_sp: "ui_game_clear_sp.png",

  over:   "ui_game_over.png",
  over_sp: "ui_game_over_sp.png"
};

const UI = {};

/* =========================================================
  2) ã‚²ãƒ¼ãƒ ç”¨ã‚¢ã‚»ãƒƒãƒˆï¼ˆç”»åƒï¼‰
========================================================= */
const ASSET = {
  bg: "background.jpg",
  bg_sp: "background_sp.jpg",

  ui_jump: "ui_jump.png",

  event_fever: "ch_event_fever.png",

  // ã‚­ãƒ£ãƒ©
  ch_player: "ch_character.png",
  mm_player: "mm_character.png",

  // å…±é€šï¼ˆâš¡ï¼‰
  lightning: "ch_item_lightning.png",
  lightningBig: "ch_item_lightning_big.png",

  // ch ã‚¢ã‚¤ãƒ†ãƒ 
  ch_repair: "ch_item_repair.png",
  ch_map: "ch_item_map.png",
  ch_compass: "ch_item_compass.png",
  ch_station: "ch_item_station.png",
  ch_curry: "ch_item_curry.png",

  // mm ã‚¢ã‚¤ãƒ†ãƒ 
  mm_onigiri: "mm_item_onigiri.png",
  mm_dango: "mm_item_dango.png",
  mm_senbei: "mm_item_senbei.png",
  mm_tea: "mm_item_tea.png",

  // æ•µ
  pitfall: "ch_enemy_pitfall.png",
  construction: "ch_enemy_construction.png",
  traffic: "ch_enemy_traffic.png",
  trouble: "ch_enemy_trouble.png",

// â­ ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ç”¨ï¼ˆã“ã“è¿½åŠ ï¼‰
share_x: "x_icon.png",
share_line: "line_icon.png"
};


const MODE = {
  ch: {
    name: "ğŸ¶ ãƒãƒ£ãƒ¼ã™ã‘ã‚³ãƒ¼ã‚¹",
    desc: "ğŸ› /â›½ã§å›å¾©ã€ğŸ›ã§åŠ é€Ÿã€ğŸ—ºã§å…ˆèª­ã¿ã€ğŸ§­ã§æ•µDOWNã€‚30ç§’ã§âš¡ã‚’é›†ã‚ã‚ˆã†ï¼",
    playerKey: "ch_player",
    itemEvery: ["ch_repair","ch_map","ch_compass"],
    itemRare5: ["ch_station","ch_curry"],
    bgm: "bgm_ch_game.mp3"
  },
  mm: {
    name: "ğŸ± ãƒŸãƒ©ã¾ã‚‹ã‚³ãƒ¼ã‚¹",
    desc: "ğŸ™ã§å›å¾©ã€ğŸ¡ã§åŠ é€Ÿã€ğŸµã§æ•µDOWNã€ğŸ˜ã§ãƒ€ãƒ¡ãƒ¼ã‚¸ç„¡åŠ¹1å›ã€‚30ç§’ã§âš¡ã‚’é›†ã‚ã‚ˆã†ï¼",
    playerKey: "mm_player",
    itemEvery: ["mm_onigiri","mm_dango"],
    itemRare5: ["mm_senbei","mm_tea"],
    bgm: "bgm_mm_game.mp3"
  }
};
const RESULT_BGM = {
  ch: {
    clear: "bgm_ch_clear.mp3",
    over:  "bgm_ch_over.mp3"
  },
  mm: {
    clear: "bgm_mm_clear.mp3",
    over:  "bgm_mm_over.mp3"
  }
};

// â­â­â­ ã“ã“ã«è¿½åŠ  â­â­â­
const ENEMY_Y_OFFSET = {
  pitfall:{ pc:100, sp:160 },
  construction:{ pc:70, sp:130 },
  traffic:{ pc:80, sp:130 },
  trouble:{ pc:100, sp:130 }
};


/* =========================================================
  3) éŸ³æºï¼ˆSEï¼‰
  â€»ã‚ãªãŸã®æŒ‡å®šã‚’ãã®ã¾ã¾åæ˜ 
========================================================= */
const SE_SRC = {
  // æ“ä½œ
  jump: "se_jump.mp3",

  // å–å¾—
  lightning: "se_get_lightning.mp3",                 // âš¡
  itemCommon: "GB-Action01-09(Item).mp3",            // ğŸ™ğŸ˜ğŸ—ºğŸ§­ ãªã©
  itemRare: "NES-Action01-12(Item).mp3",             // ğŸ›ğŸµ
  
  // è¢«å¼¾
  hitConstruction: "SNES-Action01-13(Defeat).mp3",   // å·¥äº‹ä¸­
  hitPitfall: "GB-Action01-06(Miss).mp3",            // ç©´
  hitTraffic: "Car_Horn-Fake03-1.mp3",               // ğŸš—
  hitTrouble: "SNES-Action01-13(Defeat).mp3",        // ğŸ’¥ï¼ˆæŒ‡å®šãªã—ãªã®ã§å·¥äº‹ã¨åŒç³»çµ±ã§ï¼‰
  
  // çµæœï¼ˆæŒ‡å®šãŒãªã„ã®ã§ã€å¿…è¦ãªã‚‰å·®ã—æ›¿ãˆã¦OKï¼‰
  clear: "NES-Action01-12(Item).mp3",
  gameover: "SNES-Action01-13(Defeat).mp3"
};

/* =========================================================
  4) Canvas / DOM
========================================================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.style.touchAction = "none"; // â†1å›ã ã‘ã§OK


// â­ã‚¹ãƒãƒ›ç¸¦æ¨ªãƒ•ã‚£ãƒƒãƒˆï¼ˆè¦‹åˆ‡ã‚Œé˜²æ­¢ï¼‰
function isMobile(){
  return /iPhone|Android.+Mobile|iPad|iPod/i.test(navigator.userAgent);
}


function fitCanvas(){

  let baseW;
  let baseH;

  // â­ã‚¹ãƒãƒ›ã¯ç¸¦ / PCã¯æ¨ª
  if(isMobile()){
    baseW = 540;
    baseH = 960;
  }else{
    baseW = 960;
    baseH = 540;
  }

  // Canvaså†…éƒ¨ã‚µã‚¤ã‚º
  canvas.width  = baseW;
  canvas.height = baseH;

  // åœ°é¢ä½ç½®
  groundY = canvas.height - (isMobile()?300:200);

  const vw = window.innerWidth;
  const vh = window.innerHeight;

  const scale = Math.min(vw/baseW, vh/baseH);

  // â­ã‚¹ãƒãƒ›ã‚‚PCã‚‚åŒã˜è¨ˆç®—ï¼ˆâ†ã“ã“ãŒä»Šå›ã®ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼‰
  canvas.style.width  = (baseW * scale) + "px";
  canvas.style.height = (baseH * scale) + "px";
}

window.addEventListener("resize", fitCanvas);
window.addEventListener("orientationchange", fitCanvas);
window.addEventListener("load", fitCanvas);

fitCanvas();

const loadingEl   = document.getElementById("loading");


/* =========================================================
  5) ç”»åƒãƒ­ãƒ¼ãƒ‰
========================================================= */
function loadOneImage(src){
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>resolve({ok:true, img});
    img.onerror = ()=>resolve({ok:false, img:null});
    img.src = src;
  });
}

let I = {}; // game images

/* =========================================================
  6) éŸ³ï¼ˆBGM/SEï¼‰
========================================================= */
let bgm = null;
let feverBgm = null;
let normalBgmSrc = null;
let audioUnlocked = false;
let audioCtx = null;


function stopBgm(){

  // â­é€šå¸¸BGMåœæ­¢
  if(bgm){
    try{
      bgm.pause();
      bgm.currentTime = 0;
      bgm.src = "";
      bgm.removeAttribute("src");
      bgm.load();
    }catch(e){}
  }

  // â­ãƒ•ã‚£ãƒ¼ãƒãƒ¼BGMã‚‚åœæ­¢ï¼ˆâ†ã“ã‚Œè¶…é‡è¦ï¼‰
  if(feverBgm){
    try{
      feverBgm.pause();
      feverBgm.currentTime = 0;
      feverBgm.src = "";
      feverBgm.removeAttribute("src");
      feverBgm.load();
    }catch(e){}
  }

  bgm = null;
  feverBgm = null;
  normalBgmSrc = null;
}





function playBgm(src, loop=true){

  if(!soundOn) return;

  // â­ PCã§ã‚‚éŸ³å‡ºã‚‹ã‚ˆã†ã«
  if(audioCtx){
    try{ audioCtx.resume(); }catch(e){}
  }

  stopBgm();

  normalBgmSrc = src;

  bgm = new Audio();

  bgm.src = src;
  bgm.loop = loop;
  bgm.volume = 0.6;
  bgm.preload = "auto";

  bgm.playsInline = true;
  bgm.setAttribute("playsinline","");
  bgm.setAttribute("webkit-playsinline","");

  const p = bgm.play();
  if(p && p.catch) p.catch(()=>{});
}


// iOS/Safariå¯¾ç­–ï¼šæœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
function unlockAudioOnce(){

  if(audioUnlocked) return;
  audioUnlocked = true;

  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    audioCtx.resume();
  }catch(e){}

  // â­â­â­ iPhoneéŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
  try{
    const unlock = new Audio("se_jump.mp3"); // â†å¿…ãšå­˜åœ¨ã™ã‚‹éŸ³
    unlock.volume = 0;
    unlock.playsInline = true;
    unlock.setAttribute("playsinline","");
    unlock.setAttribute("webkit-playsinline","");

    const p = unlock.play();
    if(p && p.catch) p.catch(()=>{});

    setTimeout(()=>{
      unlock.pause();
    },60);

  }catch(e){}
}







// SEã¯å¤šé‡å†ç”Ÿã§ãã‚‹ã‚ˆã†ã«cloneã—ã¦é³´ã‚‰ã™
function inFeverNow(){
  return performance.now() < feverUntil;
}

const sePool = {};

function playSE(key){
  if(!soundOn) return;

  const src = SE_SRC[key];
  if(!src) return;

  // åˆå›ã ã‘ç”Ÿæˆï¼ˆè¶…é‡è¦ï¼‰
  if(!sePool[key]){
    sePool[key] = new Audio(src);
  }

  // cloneNode ã¯è¶…è»½ã„
  const a = sePool[key].cloneNode();

a.playsInline = true;   // â† â­è¿½åŠ ï¼ˆè¶…é‡è¦ï¼‰
a.volume = 0.85;


  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ãƒ”ãƒƒãƒUP
  if(inFeverNow()){
    a.playbackRate = 1.25;
  }

  const p = a.play();
  if(p && p.catch) p.catch(()=>{});
}


/* =========================================================
  7) å…¥åŠ›ï¼ˆUIã‚¯ãƒªãƒƒã‚¯åº§æ¨™ / ã‚²ãƒ¼ãƒ æ“ä½œï¼‰
========================================================= */

function getPointerXY(e){

  const rect = canvas.getBoundingClientRect();

  // â­ iOSå®Œå…¨å¯¾å¿œ
  const scaleX = canvas.width  / rect.width;
  const scaleY = canvas.height / rect.height;

  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;

  const x = (clientX - rect.left) * scaleX;
  const y = (clientY - rect.top)  * scaleY;

  return {x,y};
}



function hitBtn(btn, x, y){
  const nx = x / canvas.width;
  const ny = y / canvas.height;

  return (
    nx > btn.x1 &&
    nx < btn.x2 &&
    ny > btn.y1 &&
    ny < btn.y2
  );
}


canvas.addEventListener("pointerdown",(e)=>{

  unlockAudioOnce();

  const { x, y } = getPointerXY(e); // â† å¿…ãšå¿…è¦


  // ==========================
// ğŸ”Š éŸ³ã‚ã‚Š / éŸ³ãªã—é¸æŠ
// ==========================
if (state === STATE.SOUND) {

  if (isMobile()) {

    if (hitBtn(BTN.sound_on_sp, x, y)) {
      soundOn = true;
      playBgm("bgm_common_intro.mp3");
      state = STATE.COURSE;
      return;
    }

    if (hitBtn(BTN.sound_off_sp, x, y)) {
      soundOn = false;
      stopBgm();
      state = STATE.COURSE;
      return;
    }

  } else {

    if (hitBtn(BTN.sound_on_pc, x, y)) {
      soundOn = true;
      playBgm("bgm_common_intro.mp3");
      state = STATE.COURSE;
      return;
    }

    if (hitBtn(BTN.sound_off_pc, x, y)) {
      soundOn = false;
      stopBgm();
      state = STATE.COURSE;
      return;
    }

  }

  return;
}



  // â‘¡ ã‚³ãƒ¼ã‚¹é¸æŠï¼ˆå·¦=ãƒŸãƒ©ã¾ã‚‹ã€å³=ãƒãƒ£ãƒ¼ã™ã‘ï¼‰
if(state===STATE.COURSE){

  if(isMobile()){

    // â­ å¢ƒç•Œã‚’ä¸‹ã«ãšã‚‰ã™ï¼ˆ0.55 = ç”»é¢ä¸­å¤®ã‚ˆã‚Šå°‘ã—ä¸‹ï¼‰
    const splitY = canvas.height * 0.55;

    if(y < splitY){
      mode = "mm";   // ä¸Šï¼šãƒŸãƒ©ã¾ã‚‹
    }else{
      mode = "ch";   // ä¸‹ï¼šãƒãƒ£ãƒ¼ã™ã‘
    }

  }else{
    // PCã¯ä»Šã¾ã§é€šã‚Šå·¦å³
    if(x < canvas.width / 2){
      mode = "mm";
    }else{
      mode = "ch";
    }
  }

  state = STATE.START;
  return;
}


  // â‘¢ ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆç”»åƒUIï¼šä¸­å¤®ã®ãƒœã‚¿ãƒ³ç¯„å›²ï¼‰
  if(state===STATE.START){

  startBtnPressUntil = performance.now() + 120;

  setTimeout(()=>{
    startGame();
  },120);

  return;
}


  // â‘£ ã‚²ãƒ¼ãƒ ä¸­ï¼šã‚¸ãƒ£ãƒ³ãƒ—
  if(state===STATE.GAME){

  // â­ JUMPãƒœã‚¿ãƒ³æŠ¼ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
  if(jumpBtnRect){
  if(
    x > jumpBtnRect.x &&
    x < jumpBtnRect.x + jumpBtnRect.w &&
    y > jumpBtnRect.y &&
    y < jumpBtnRect.y + jumpBtnRect.h
  ){
    jumpBtnPressUntil = performance.now() + 120; // â†0.12ç§’ã¸ã“ã‚€
    jump();
    return;
  }
}


  // PCã¯ç”»é¢ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚ã‚¸ãƒ£ãƒ³ãƒ—
  if(!isMobile()){
    jump();
  }

  return;
}



  // â‘¤ çµ‚äº†ç”»é¢ï¼šã‚‚ã†ä¸€åº¦ / ã‚„ã‚ã‚‹
if(state===STATE.END){

// â­ ã‚·ã‚§ã‚¢ã‚¯ãƒªãƒƒã‚¯
if(hitBtn(BTN.shareX, x, y)){
  shareToX();
  return;
}

if(hitBtn(BTN.shareLINE, x, y)){
  shareToLINE();
  return;
}


  // â­ ã‚·ã‚§ã‚¢ã‚¯ãƒªãƒƒã‚¯
  if(
  x > BTN.shareX.x &&
  x < BTN.shareX.x + BTN.shareX.w &&
  y > BTN.shareX.y &&
  y < BTN.shareX.y + BTN.shareX.h
){
  shareToX();
  return;
}

if(
  x > BTN.shareLINE.x &&
  x < BTN.shareLINE.x + BTN.shareLINE.w &&
  y > BTN.shareLINE.y &&
  y < BTN.shareLINE.y + BTN.shareLINE.h
){
  shareToLINE();
  return;
}


  if(isMobile()){

    if(hitBtn(BTN.end_retry_sp,x,y)){
      startGame();
      return;
    }

    if(hitBtn(BTN.end_exit_sp,x,y)){
      state = STATE.COURSE;
      stopBgm();
      return;
    }

  }else{

    if(hitBtn(BTN.end_retry_pc,x,y)){
      startGame();
      return;
    }

    if(hitBtn(BTN.end_exit_pc,x,y)){
      state = STATE.COURSE;
      stopBgm();
      return;
    }

  }
}


});

document.addEventListener("keydown",(e)=>{
  if(e.code==="Space"){
    e.preventDefault();
    unlockAudioOnce();
    if(state===STATE.GAME) jump();
    if(state===STATE.START) startGame();
    if(state===STATE.END) startGame();
  }
});

/* =========================================================
  8) ã‚²ãƒ¼ãƒ æœ¬ä½“ï¼ˆã‚ãªãŸã®æ—¢å­˜ä»•æ§˜ã‚’ç¶­æŒï¼‰
========================================================= */
const GAME_MS = 60_000;


const gravity = isMobile() ? 1.2 : 1.0;

function getJumpPower(){
  return isMobile() ? -24 : -21;
}



const BASE_SPEED = 4.5;
const PLAYER_GROUND_OFFSET = isMobile() ? 30 : 20;

let running = false;
let startAt = 0;
let lastCleared = false;

let playCount = 0;        // ãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼šlocalStorage
let gameEvent = null;     // ã“ã®ã‚²ãƒ¼ãƒ ã®ãƒ¬ã‚¢æ 
let used = null;

let player = {};
let score = 0;
let displayScore = 0; // è¡¨ç¤ºç”¨ã‚¹ã‚³ã‚¢ï¼ˆã‚¢ãƒ‹ãƒ¡ç”¨ï¼‰
let combo = 0;
let comboText = "";
let comboTextUntil = 0;
let comboTimeout = 0;
let hp = 3;

let lightnings = [];
let items = [];
let enemies = [];
let bgScrollX = 0;


let lastSpawn = 0;
let spawnCount = 0;

let feverCount = 0;
let feverUntil = 0;

let speedUntil = 0;
let slowUntil  = 0;
let enemyRateDownUntil = 0;
let mapRevealUntil = 0;

let shakeUntil = 0;
let sinkUntil  = 0;
let starsUntil = 0;
let starsAngle = 0;

let popups = [];
let comment = { text:"", until:0 };
let jumpBtnRect = null; 
let jumpBtnPressed = false;
let jumpBtnPressUntil = 0;
let startBtnPressUntil = 0;



let shieldUntilHit = false; // mmå°‚ç”¨ğŸ˜

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

/* å½“ãŸã‚Šåˆ¤å®šï¼ˆå®‰å®šç‰ˆï¼‰ */
function hit(a, b){
  const marginA = 14;
  const marginB = 10;
  return (
    a.x + marginA < b.x + b.w - marginB &&
    a.x + a.w - marginA > b.x + marginB &&
    a.y + marginA < b.y + b.h - marginB &&
    a.y + a.h - marginA > b.y + marginB
  );
}

function updateHUD(remainMs){}


function flashDamage(){
  damageFlash.classList.add("show");
  setTimeout(()=>damageFlash.classList.remove("show"), 120);
}

/* ã‚²ãƒ¼ãƒ å›æ•°ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰ */
function storageKeyForCount(){
  return mode === "ch" ? "evrun_playCount_ch" : "evrun_playCount_mm";
}
function loadPlayCount(){
  const raw = localStorage.getItem(storageKeyForCount());
  const n = raw ? parseInt(raw,10) : 0;
  return Number.isFinite(n) ? n : 0;
}
function savePlayCount(n){
  localStorage.setItem(storageKeyForCount(), String(n));
}
function decideGameEvent(){
  const fever = (playCount % 15 === 0);              // 15ã‚²ãƒ¼ãƒ ã«1å›
  const bigLightning = (!fever && playCount % 10 === 0); // 10ã‚²ãƒ¼ãƒ ã«1å›
  const rare5 = (!fever && playCount % 5 === 0);     // 5ã‚²ãƒ¼ãƒ ã«1å›ï¼ˆãƒ¢ãƒ¼ãƒ‰ã®ãƒ¬ã‚¢æ ï¼‰
  return { fever, bigLightning, rare5 };
}

/* ãƒ•ã‚£ãƒ¼ãƒãƒ¼ */
function startFever(){

  const t = performance.now();

  feverUntil = t + 5200;
  feverLayer.classList.add("show");

  // â­ã“ã“ã§ stopBgm ã—ãªã„
  // ï¼ˆplayBgm ãŒå®Œå…¨åœæ­¢ç®¡ç†ã™ã‚‹ã‹ã‚‰ï¼‰

  if(soundOn){

  // â­é€šå¸¸BGMã‚’ä¸€æ™‚åœæ­¢ï¼ˆæ­¢ã‚ãªã„ï¼‰
  if(bgm){
    try{ bgm.pause(); }catch(e){}
  }

  feverBgm = new Audio("bgm_fever.mp3");
  feverBgm.loop = true;
  feverBgm.volume = 0.7;

  feverBgm.playsInline = true;
  feverBgm.setAttribute("playsinline","");
  feverBgm.setAttribute("webkit-playsinline","");

  feverBgm.play().catch(()=>{});
}

  say("ğŸŒˆ ãƒ•ã‚£ãƒ¼ãƒãƒ¼çªå…¥ï¼",1100);
}




function endFeverIfNeeded(){

  if(!feverBgm) return;

  const t = performance.now();

  if(t >= feverUntil){

    feverLayer.classList.remove("show");

    if(feverBgm){
      feverBgm.pause();
      feverBgm.currentTime = 0;
      feverBgm = null;
    }

    // â­é€šå¸¸BGMã‚’å†é–‹
if(bgm){
  try{ bgm.play(); }catch(e){}
}
  }
}



/* ã‚¹ãƒãƒ¼ãƒ³ */
function makeLightning(){

  // â­ PCã ã‘æœ€é«˜é«˜ã•ã‚’åˆ¶é™
  const maxHeight = isMobile() ? 120 : 80;

  // â­ 30%ã§åœ°é¢
  if(Math.random() < 0.3){
    return {
      kind:"lightning",
      x: canvas.width,
      y: groundY + 20,
      w:50,
      h:50
    };
  }

  // â­ ãã‚Œä»¥å¤–ã¯ç©ºä¸­
  return {
    kind:"lightning",
    x: canvas.width,
    y: groundY - 60 - Math.random()*maxHeight,
    w:50,
    h:50
  };
}


function makeItem(key){

  // â­ PC/SPã§ä½ç½®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’åˆ†é›¢
let Y_BASE = isMobile() ? 120 : 60;

// PCã ã‘æœ€é«˜ä½ç½®ã‚’ä¸‹ã’ã‚‹ï¼ˆã“ã“ãŒé‡è¦ï¼‰
let Y_RAND = isMobile() ? 180 : 60;


  let y = groundY - Y_BASE - Math.random()*Y_RAND;

  // ===== å€‹åˆ¥èª¿æ•´ =====
  if(key === "ch_station") y = groundY + (isMobile()?30:10);
  if(key === "lightningBig") y = groundY - (isMobile()?160:110);
  if(key === "ch_repair" || key === "mm_onigiri") y = groundY - (isMobile()?80:40);

    // â­ ã‚¹ãƒãƒ›ã ã‘å°‘ã—å¤§ãã
const itemSize = isMobile() ? 66 : 56;
const bigSize  = isMobile() ? 74 : 64;

return {
  type:"item",
  key:key,
  x: canvas.width,
  y: y,
  w:(key==="lightningBig") ? bigSize : itemSize,
  h:(key==="lightningBig") ? bigSize : itemSize
};

}


function makeEnemyByRule(){

  let kind;
  if(spawnCount % 5 === 0) kind = "trouble";
  else if(spawnCount % 2 === 0 && Math.random() < 0.45) kind = "traffic";
  else kind = (Math.random() < 0.52) ? "pitfall" : "construction";

  const h = 70;

  const device = isMobile() ? "sp" : "pc";
  const yOffset = ENEMY_Y_OFFSET[kind]?.[device] ?? 50;

  return {
    type: "enemy",
    kind,
    x: canvas.width,
    y: groundY - h + yOffset, // â­ åœ°é¢ã‚ˆã‚Šä¸‹ã«æ²ˆã‚ã‚‹
    w: 70,
    h: h,
    rot: 0
  };
}





/* ã“ã®ã‚²ãƒ¼ãƒ ã®ãƒ¬ã‚¢æ ã‚’ã€Œ1å›ãšã¤ã€æ¶ˆåŒ– */
function trySpawnPlannedEvent(){
  if(spawnCount < 6) return false;

  const t = performance.now();

  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆã“ã®ã‚²ãƒ¼ãƒ 1å›ï¼‰
  if(gameEvent.fever && !used.fever){
    items.push({
      type:"item",
      key:"event_fever",
      x: canvas.width,
      y: groundY - 120,
      w: 64,
      h: 64
    });
    used.fever = true;
    say("ğŸŒˆ ä½•ã‹ç‰¹åˆ¥ãªã‚‚ã®ãŒâ€¦ï¼Ÿ",1000);
    return true;
  }

  if(t < feverUntil) return false;

  // å¤§âš¡ï¼ˆ10å›ã«1å›ï¼šã“ã®ã‚²ãƒ¼ãƒ ã§1å›ï¼‰
  if(gameEvent.bigLightning && !used.bigLightning){
    items.push(makeItem("lightningBig"));
    used.bigLightning = true;
    say("ãŸã¾ã«å¤§âš¡ããŸï¼ğŸ‰", 1000);
    return true;
  }

  // 5å›ã«1å›æ ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
  if(gameEvent.rare5 && !used.rare5){
    const rareKeys = MODE[mode].itemRare5;
    const pick = rareKeys[(playCount/5|0) % rareKeys.length];
    items.push(makeItem(pick));
    used.rare5 = true;

    if(mode==="ch"){
      if(pick==="ch_curry") say("ä»Šå›ã¯ğŸ›æ¥ãŸï¼", 1000);
      else if(pick==="ch_station") say("ä»Šå›ã¯â›½æ¥ãŸï¼", 1000);
      else say("ä»Šæ—¥ã¯ãƒ¬ã‚¢ï¼", 900);
    }else{
      if(pick==="mm_senbei") say("ä»Šå›ã¯ğŸ˜æ¥ãŸï¼", 1000);
      else if(pick==="mm_tea") say("ä»Šå›ã¯ğŸµæ¥ãŸï¼", 1000);
      else say("ä»Šæ—¥ã¯ãƒ¬ã‚¢ï¼", 900);
    }
    return true;
  }

  return false;
}

// â­ âš¡é…ç½®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚²ãƒ¼ãƒ ã£ã½ã„ï¼‰
function spawnLightningPattern(){

  const baseX = canvas.width;

  const r = Math.random();

  // ===== åœ°é¢ãƒ©ã‚¤ãƒ³ï¼ˆåˆå¿ƒè€…å‘ã‘ï¼‰
  if(r < 0.35){

    for(let i=0;i<3;i++){
      lightnings.push({
        kind:"lightning",
        x: baseX + i*80,
        y: groundY + 20,
        w:50,h:50
      });
    }
    return;
  }

  // ===== ç¸¦ãƒ©ã‚¤ãƒ³ï¼ˆã‚¸ãƒ£ãƒ³ãƒ—ç”¨ï¼‰
  if(r < 0.65){

    const maxHeight = isMobile() ? 120 : 80;
const y = groundY - 60 - Math.random()*maxHeight;


    for(let i=0;i<2;i++){
      lightnings.push({
        kind:"lightning",
        x: baseX,
        y: y - i * (isMobile() ? 80 : 40),
        w:50,h:50
      });
    }
    return;
  }

  // ===== ãªãªã‚ãƒ©ã‚¤ãƒ³ï¼ˆæ°—æŒã¡ã„ã„ï¼‰
  if(r < 0.9){

    const maxHeight = isMobile() ? 120 : 80;
const startY = groundY - 60 - Math.random()*maxHeight;


    for(let i=0;i<3;i++){
      lightnings.push({
        kind:"lightning",
        x: baseX + i*70,
        y: startY - i*40,
        w:50,h:50
      });
    }
    return;
  }

  // ===== å˜ç™ºï¼ˆæ™®é€šï¼‰
  lightnings.push(makeLightning());
}


function spawn(){
  const now = Date.now();
  const t = performance.now();
  const inFever = (t < feverUntil);

  let interval = inFever ? 350 : 800;


  if(now - lastSpawn < interval) return;
  lastSpawn = now;

  spawnCount++;

  // ã¾ãšã€Œã“ã®ã‚²ãƒ¼ãƒ ã®äºˆå®šã€ã‚’å‡ºã™
  if(trySpawnPlannedEvent()) return;

  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ï¼šæ•µãªã—ï¼†âš¡å¤§é‡
  if(inFever){
    lightnings.push(makeLightning());
    if(Math.random() < 0.35) lightnings.push(makeLightning());
    return;
  }

  // é€šå¸¸ï¼šæ•µ or ã‚¢ã‚¤ãƒ†ãƒ  or âš¡
  const enemyChanceBase = 0.35;
  const enemyChance = (t < enemyRateDownUntil) ? 0.30 : enemyChanceBase;

  if(Math.random() < enemyChance){
    enemies.push(makeEnemyByRule());
  }else{
    const r = Math.random();
    const every = MODE[mode].itemEvery;

    if(mode==="ch"){
  if(r < 0.16) items.push(makeItem(every[0]));
  else if(r < 0.28) items.push(makeItem(every[1]));
  else if(r < 0.40) items.push(makeItem(every[2]));
  else if(r < 0.92) spawnLightningPattern();
  else spawnLightningPattern();
}
else{
  if(r < 0.22) items.push(makeItem(every[0]));
  else if(r < 0.44) items.push(makeItem(every[1]));
  else if(r < 0.92) spawnLightningPattern();
  else spawnLightningPattern();
}
  }
}

/* æ“ä½œ */
function jump(){
  if(!running) return;

  const playerGroundY = groundY + PLAYER_GROUND_OFFSET;

  if(player.y === playerGroundY){
    player.vy = getJumpPower();
    playSE("jump");
  }
}


/* åˆæœŸåŒ– */
function resetGameCore(){
  running = false;
  startAt = 0;

  const size = isMobile() ? 100 : 90; // â­ã‚¹ãƒãƒ›ã ã‘å¤§ãã

player = {
  x: isMobile() ? 20 : 100, // â­ã“ã“å¤‰æ›´
  y: groundY + PLAYER_GROUND_OFFSET,
  w: size,
  h: size,
  vy: 0
};


  score = 0;
displayScore = 0; 
hp = 3;


  lightnings = [];
  items = [];
  enemies = [];

  lastSpawn = 0;
  spawnCount = 0;

  feverCount = 0;
  feverUntil = 0;

  speedUntil = 0;
  slowUntil  = 0;
  enemyRateDownUntil = 0;
  mapRevealUntil = 0;

  shakeUntil = 0;
  sinkUntil  = 0;
  starsUntil = 0;
  starsAngle = 0;

  popups = [];
  comment = { text:"", until:0 };

  shieldUntilHit = false;

  used = { fever:false, bigLightning:false, rare5:false };
  feverLayer.classList.remove("show");
  updateHUD(GAME_MS);
}

/* é–‹å§‹ */
function startGame(){
  if(!mode) mode = "ch";



  state = STATE.GAME;


  playCount = loadPlayCount() + 1;
  savePlayCount(playCount);

  gameEvent = decideGameEvent();
  resetGameCore();

  stopBgm();
  playBgm(MODE[mode].bgm);

  if(gameEvent.fever) say("ä»Šæ—¥ã¯â€¦ç‰¹åˆ¥ãªäºˆæ„Ÿï¼", 1000);
  else if(gameEvent.bigLightning) say("ãŸã¾ã«å¤§âš¡ãã‚‹ã‹ã‚‚ï¼", 1000);
  else if(gameEvent.rare5){
    if(mode==="ch") say("æ¬¡ã¯â›½ã‹ğŸ›ã‹ã‚‚ï¼Ÿ", 1000);
    else say("æ¬¡ã¯ğŸ˜ã‹ğŸµã‹ã‚‚ï¼Ÿ", 1000);
  }else{
    say("ã„ãã‚ˆãƒ¼ï¼", 900);
  }

  running = true;
  startAt = Date.now();
}

/* çµ‚äº† */
function finish(cleared){

  if(!running) return;

  running = false;

  normalBgmSrc = null;

  lastCleared = !!cleared;

  stopBgm();
  state = STATE.END;

  if(soundOn){
    const bgmSrc = cleared
      ? RESULT_BGM[mode].clear
      : RESULT_BGM[mode].over;

    playBgm(bgmSrc, false); // â­ã“ã“é‡è¦
  }
}  
// â­ ã‚·ã‚§ã‚¢å‡¦ç†
function shareToX(){

  const text = `âš¡${score}GETã—ãŸï¼
ãƒŸãƒ©ã¾ã‚‹ï¼†ãƒãƒ£ãƒ¼ã™ã‘ã®EVã‚¨ãƒŠã‚¸ãƒ¼ãƒ©ãƒ³âš¡
â–¶ https://ev-plus.jp/lp/energy-run/
#ãƒŸãƒ©ã¾ã‚‹ #ãƒãƒ£ãƒ¼ã™ã‘ #EVã‚¨ãƒŠã‚¸ãƒ¼ãƒ©ãƒ³`;

  window.open(
    "https://twitter.com/intent/tweet?text=" + encodeURIComponent(text)
  );
}

function shareToLINE(){

  const text = `âš¡${score}GETã—ãŸï¼
ãƒŸãƒ©ã¾ã‚‹ï¼†ãƒãƒ£ãƒ¼ã™ã‘ã®EVã‚¨ãƒŠã‚¸ãƒ¼ãƒ©ãƒ³âš¡
â–¶ https://ev-plus.jp/lp/energy-run/
#ãƒŸãƒ©ã¾ã‚‹ #ãƒãƒ£ãƒ¼ã™ã‘ #EVã‚¨ãƒŠã‚¸ãƒ¼ãƒ©ãƒ³`;

  window.open(
    "https://social-plugins.line.me/lineit/share?text=" + encodeURIComponent(text)
  );
}


/* æ›´æ–° */
function update(delta){
  const t = performance.now();
  const nowMs = Date.now();

  bgScrollX -= 2 * delta;
  if(bgScrollX <= -canvas.width){
    bgScrollX = 0;
  }

// ç‰©ç†
player.vy += gravity * delta;

if(isMobile()){

  // â­ ä¸Šæ˜‡ä¸­ã ã‘ã»ã‚“ã®å°‘ã—ä¼¸ã°ã™ï¼ˆâ†ã“ã“ãŒé‡è¦ï¼‰
  if(player.vy < 0){
    player.vy += gravity * -0.22 * delta;
 
  }
  // â­ è½ä¸‹ã¯ä»Šã®é€Ÿã•ã‚’ç¶­æŒ
  else{
    player.vy += gravity * 0.75 * delta;
  }
}

player.y += player.vy * delta;








  // åœ°é¢ã«å¸ç€
  const playerGroundY = groundY + PLAYER_GROUND_OFFSET;

if(player.y > playerGroundY){
  player.y = playerGroundY;
  player.vy = 0;
}


  // ã‚¹ãƒãƒ¼ãƒ³
  spawn();

  // é€Ÿåº¦
let curSpeed = BASE_SPEED;

// â­ã‚¹ãƒãƒ›è£œæ­£
if(isMobile()){
  curSpeed *= 0.95;
}

if(t < speedUntil) curSpeed *= 1.25;
if(t < slowUntil)  curSpeed *= 0.72;


// ç§»å‹•ï¼ˆå·¦ã¸æµã™ï¼‰
lightnings.forEach(l => { l.x -= curSpeed * delta; });

items.forEach(it => { it.x -= curSpeed * delta; });

enemies.forEach(en => {
  en.x -= curSpeed * delta;

  if(en.kind === "construction"){
    en.rot += 0.06 * delta;
  }
});



  // +1ãƒãƒƒãƒ—
  popups.forEach(p => { p.y -= 0.6; p.life--; });
  popups = popups.filter(p => p.life > 0);

  // â­âš¡å–å¾—ï¼ˆã‚³ãƒ³ãƒœå¯¾å¿œï¼‰
lightnings = lightnings.filter(l => {

  if(hit(player, l)){

    combo++;
    comboTimeout = performance.now() + 2000; // 2ç§’ä»¥å†…ãªã‚‰ç¶™ç¶š

    // â­ 3ã‚³ãƒ³ãƒœä»¥ä¸Šã§è¡¨ç¤º
if(combo >= 3){
  comboText = combo + " COMBO!";
  comboTextUntil = performance.now() + 800;
}


    const addScore = 10 * combo;
    score += addScore;

    playSE("lightning");

    // â­ ã‚­ãƒ£ãƒ©ä¸Šã«ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º
    popups.push({
      x: player.x + player.w/2 - 10,
      y: player.y - 10,
      text: "+" + addScore,
      life: 40
    });

    if(Math.random() < 0.10) talk("lightning");

    return false;
  }

  return l.x > -60;
});




function say(text, duration=1200){
  comment.text = text;
  comment.until = performance.now() + duration;
}

  // ã‚¢ã‚¤ãƒ†ãƒ å–å¾—ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
  items = items.filter(it=>{
  if(hit(player, it)){

    // å…±é€š
    if(it.key === "lightningBig"){
      score += 50;
      playSE("lightning");
      talk("lightning");
      return false;
    }

    if(it.key === "event_fever"){
      playSE("itemRare");
      startFever();
      talk("fever");
      return false;
    }

    // ===== ch =====
    if(mode==="ch"){

      if(it.key === "ch_repair" || it.key === "ch_station"){
        playSE("itemCommon");
        const before = hp;
        hp = clamp(hp + 1, 0, 3);

        if(hp !== before){
          popHP();
          popups.push({
            x: player.x + player.w/2 + 10,
            y: player.y - 10,
            text: "+1",
            life: 40
          });
        }

        talk("heal");
        return false;
      }

      if(it.key === "ch_curry"){
        speedUntil = t + 4200;
        playSE("itemRare");
        talk("speed");
        return false;
      }

      if(it.key === "ch_compass"){
        enemyRateDownUntil = t + 5200;
        playSE("itemCommon");
        talk("enemyDown");
        return false;
      }

      if(it.key === "ch_map"){
        mapRevealUntil = t + 4800;
        playSE("itemCommon");
        talk("map");
        return false;
      }
    }

    // ===== mm =====
    if(mode==="mm"){

      if(it.key === "mm_onigiri"){
        playSE("itemCommon");

        const before = hp;
        hp = clamp(hp + 1, 0, 3);

        if(hp !== before){
          popHP();
          popups.push({
            x: player.x + player.w/2 + 10,
            y: player.y - 10,
            text: "+1",
            life: 40
          });
        }

        talk("heal");
        return false;
      }

      if(it.key === "mm_dango"){
        speedUntil = t + 4200;
        playSE("itemCommon");
        talk("speed");
        return false;
      }

      if(it.key === "mm_tea"){
        enemyRateDownUntil = t + 5200;
        playSE("itemRare");
        talk("enemyDown");
        return false;
      }

      if(it.key === "mm_senbei"){
        shieldUntilHit = true;
        playSE("itemCommon");
        talk("guard");
        return false;
      }
    }

    return false;
  }

  return it.x > -90;
});


  // æ•µè¡çª
  enemies = enemies.filter(en=>{
    if(hit(player, en)){
      // ãƒ•ã‚£ãƒ¼ãƒãƒ¼ä¸­ã¯æ•µãŒå‡ºãªã„è¨­è¨ˆã ãŒå¿µã®ãŸã‚
      if(t < feverUntil) return false;

      // mmã®ğŸ˜ã‚¬ãƒ¼ãƒ‰
      if(mode==="mm" && shieldUntilHit){
        shieldUntilHit = false;
        playSE("itemCommon"); // ã‚¬ãƒ¼ãƒ‰éŸ³ï¼ˆå¥½ã¿ã§å·®ã—æ›¿ãˆOKï¼‰
        talk("guard");
        return false;
      }

      flashDamage();
      shakeUntil = t + 220;
      popHP();

      if(en.kind === "traffic"){
        slowUntil = t + 3000;
        playSE("hitTraffic");
        talk("damage");
        return false;
      }

      // ãƒ€ãƒ¡ãƒ¼ã‚¸
      hp = clamp(hp - 1, 0, 3);
      talk("damage");

      if(en.kind === "pitfall"){
        playSE("hitPitfall");
        sinkUntil = t + 650;
      }else if(en.kind === "construction"){
        playSE("hitConstruction");
        starsUntil = t + 900;
        starsAngle = 0;
      }else if(en.kind === "trouble"){
        playSE("hitTrouble");
        shakeUntil = t + 320;
      }else{
        // å¿µã®ãŸã‚
        playSE("hitTrouble");
      }
      return false;
    }
    return en.x > -120;
  });

  // ãƒ•ã‚£ãƒ¼ãƒãƒ¼çµ‚ã‚ã‚Š
  endFeverIfNeeded();

// â­ ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
if(performance.now() > comboTimeout){
  combo = 0;
  comboText = "";
}



if(lightnings.length > 25) lightnings.splice(0,5);
if(items.length > 20) items.splice(0,5);
if(enemies.length > 20) enemies.splice(0,5);

  const remain = GAME_MS - (Date.now() - startAt);

if(hp <= 0) finish(false);
else if(remain <= 0) finish(true);

}


// ================================
// â­ ä¸Šéƒ¨ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤º
// ================================
function say(text, duration=1200){
  comment.text = text;
  comment.until = performance.now() + duration;
}


// ================================
// â­ ã‚­ãƒ£ãƒ©å£èª¿ãƒˆãƒ¼ã‚¯ï¼ˆé…åˆ—å¯¾å¿œç‰ˆï¼‰
// ================================
function talk(type){

  const MM = {
    lightning: [
      "ã„ã„æ„Ÿã˜ã‹ã‚‚â€¦",
      "ã¾ã ã„ã‘ã‚‹ã­",
      "é †èª¿ãã†â€¦"
    ],

    fever: [
      "ãªã‚“ã ã‹ã™ã”ãã†â€¦",
      "ã‚­ãƒ©ã‚­ãƒ©ã—ã¦ã‚‹â€¦"
    ],

    heal: [
      "ã¡ã‚‡ã£ã¨å…ƒæ°—ã«ãªã£ãŸã­",
      "å›å¾©ã§ããŸã¿ãŸã„"
    ],

    speed: [
      "å°‘ã—æ€¥ã”ã†ã‹",
      "ã„ã„ãƒšãƒ¼ã‚¹ã ã­"
    ],

    map: [
      "ãªã‚“ã¨ãªãåˆ†ã‹ã‚‹ã‹ã‚‚â€¦",
      "æ•µãŒè¦‹ã‚„ã™ããªã£ãŸã¿ãŸã„"
    ],

    enemyDown: [
      "å±ãªããªã•ãã†â€¦",
      "è½ã¡ç€ã„ã¦ã„ã“ã†"
    ],

    guard: [
      "å®ˆã‚‰ã‚Œã¦ã‚‹ã­",
      "å®‰å¿ƒã§ãã‚‹ã‹ã‚‚"
    ],

    damage: [
      "ã ã„ã˜ã‚‡ã†ã¶â€¦ï¼Ÿ",
      "ã„ãŸã„ã£â€¦",
      "æ°—ã‚’ã¤ã‘ã¦â€¦",
      "ã†ã‚ã£â€¦"
    ],
  };

  const CH = {
    lightning: [
      "ã„ã„ã­ï¼",
      "ãƒŠã‚¤ã‚¹ï¼",
      "ãã®èª¿å­ï¼"
    ],

    fever: [
      "ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã ï¼",
      "ã„ã£ãããƒ¼ï¼"
    ],

    heal: [
      "å›å¾©ã—ãŸã‚ˆï¼",
      "ã¾ã ã¾ã ã„ã‘ã‚‹ï¼"
    ],

    speed: [
      "ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—ï¼",
      "åŠ é€Ÿã ãƒ¼ï¼"
    ],

    map: [
      "æ•µãŒè¦‹ã‚„ã™ããªã£ãŸã‚ˆï¼",
      "æ•µã«æ°—ã‚’ã¤ã‘ã¦ï¼"
    ],

    enemyDown: [
      "æ•µãŒæ¸›ã£ãŸï¼",
      "ä»ŠãŒãƒãƒ£ãƒ³ã‚¹ï¼"
    ],

    guard: [
      "ã‚¬ãƒ¼ãƒ‰ï¼",
      "å®ˆã‚‰ã‚Œã¦ã‚‹ï¼"
    ],

    damage: [
      "ã‚ã£ï¼",
      "ã¶ã¤ã‹ã£ãŸï¼",
      "ã„ã¦ã£ï¼",
      "å¤§ä¸ˆå¤«ï¼ï¼Ÿ",
      "ã†ã‚ã£ï¼"
    ],
  };

  const dict = (mode==="mm") ? MM : CH;
  const list = dict[type];

  if(!list) return;

  // â­ é…åˆ—ãªã‚‰ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º
  if(Array.isArray(list)){
    const txt = list[Math.floor(Math.random()*list.length)];
    say(txt,900);
  }else{
    say(list,900);
  }
}


/* =========================================================
  9) æç”»ï¼ˆçŠ¶æ…‹åˆ¥ï¼‰
========================================================= */
function drawUI(){

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,canvas.width,canvas.height);


  if(state===STATE.SOUND){

    const img = isMobile()?UI.sound_sp:UI.sound;

    if(img?.ok){
  ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
}else{
  drawFallbackText("ui_sound_select.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
}


    return;
  }

  if(state===STATE.COURSE){

    const img = isMobile()?UI.course_sp:UI.course;

    if(img?.ok){
      ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
    }else{
      drawFallbackText("ui_course_select.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
    }
    return;
  }

  if(state===STATE.START){

  const img = isMobile()?UI.start_sp:UI.start;

  if(img?.ok){

    // â­æŠ¼ã—ãŸç¬é–“ãƒã‚§ãƒƒã‚¯
    const pressed = performance.now() < startBtnPressUntil;

    // â­æŠ¼ã—ãŸæ™‚ã ã‘å°‘ã—ç¸®ã‚€
    if(pressed){
      ctx.save();
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.scale(0.96, 0.96);
      ctx.translate(-canvas.width/2, -canvas.height/2);
    }

    ctx.drawImage(img.img,0,0,canvas.width,canvas.height);

    if(pressed) ctx.restore();

  }else{
    drawFallbackText("ui_start.png ãŒè¦‹ã¤ã‹ã‚‰ãªã„");
  }

  return;
}


if(state===STATE.END){

  // â­ ã‚¹ã‚³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ï¼ˆã“ã“ã«å…¥ã‚Œã‚‹ï¼‰
  if(displayScore < score){
    displayScore += Math.ceil((score - displayScore) * 0.08);

    if(score - displayScore < 1){
      displayScore = score;
    }
  }

  const img = lastCleared
    ? (isMobile()?UI.clear_sp:UI.clear)
    : (isMobile()?UI.over_sp:UI.over);

  if(img?.ok){
    ctx.drawImage(img.img,0,0,canvas.width,canvas.height);
  }

  // â­ SCOREè¡¨ç¤º
  ctx.save();
  ctx.font = isMobile() ? "bold 36px sans-serif" : "bold 48px sans-serif";
  ctx.textAlign = "center";

  const text = "SCORE " + displayScore.toString().padStart(4,"0");

  ctx.strokeText(text, canvas.width/2, canvas.height*0.42);
  ctx.fillText(text, canvas.width/2, canvas.height*0.42);

  ctx.restore();


// =========================
// â­ ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³
// =========================

let shareY = canvas.height * 0.55;

ctx.fillStyle = "rgba(0,0,0,0.4)";
roundRect(ctx, canvas.width/2 - 220, shareY - 30, 440, 80, 20);
ctx.fill();

ctx.fillStyle = "#fff";
ctx.font = "bold 20px sans-serif";
ctx.textAlign = "center";

const barWidth = 440;
const barX = canvas.width/2 - barWidth/2;

const btnSize = 60;
const gap = 20;

BTN.shareX = {
  x: barX + barWidth/2 - btnSize - gap/2,
  y: shareY - 20,
  w: btnSize,
  h: btnSize
};

BTN.shareLINE = {
  x: barX + barWidth/2 + gap/2,
  y: shareY - 20,
  w: btnSize,
  h: btnSize
};


drawShareBtn(BTN.shareX.x, BTN.shareX.y, "#333", "X");
drawShareBtn(BTN.shareLINE.x, BTN.shareLINE.y, "#00c300", "LINE");


return;
}
  }

function drawGame(){
  // èƒŒæ™¯
const bg = (isMobile() && I.bg_sp?.ok) ? I.bg_sp : I.bg;



if(bg && bg.ok){

  ctx.drawImage(bg.img, bgScrollX, 0, canvas.width, canvas.height);
  ctx.drawImage(bg.img, bgScrollX + canvas.width, 0, canvas.width, canvas.height);

} else {

  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

}


  const t = performance.now();

  // å…ˆèª­ã¿ï¼ˆchã®ã¿ï¼‰
if(mode==="ch" && t < mapRevealUntil){
  ctx.save();

  enemies.forEach(en=>{

    // â­ æ•µã®ä¸‹ã«å½±ï¼ˆå…ˆèª­ã¿ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼‰
    ctx.globalAlpha = 0.35;
    ctx.fillStyle = "#000";

    ctx.beginPath();
    ctx.ellipse(
      en.x + en.w/2,     // ä¸­å¤®
      en.y + en.h - 6,   // è¶³å…ƒ
      en.w/2.2,          // æ¨ªå¹…
      8,                 // ç¸¦å¹…
      0, 0, Math.PI*2
    );
    ctx.fill();

  });

  ctx.restore();
}


  // âš¡
  lightnings.forEach(l=>{
    if(I.lightning?.ok) ctx.drawImage(I.lightning.img, l.x, l.y, l.w, l.h);
    else { ctx.fillStyle="#ff0"; ctx.fillRect(l.x,l.y,l.w,l.h); }
  });

  // ã‚¢ã‚¤ãƒ†ãƒ 
items.forEach(it=>{
  const imgObj = I[it.key];
  if(imgObj?.ok){
    ctx.drawImage(imgObj.img, it.x, it.y, it.w, it.h);
  }
});


  // æ•µ
  enemies.forEach(en=>{
    ctx.save();
    const imgObj = I[en.kind];
    if(en.kind === "construction" && imgObj?.ok){
      ctx.translate(en.x + en.w/2, en.y + en.h/2);
      ctx.rotate(en.rot);
      ctx.drawImage(imgObj.img, -en.w/2, -en.h/2, en.w, en.h);
    }else{
      if(imgObj?.ok) ctx.drawImage(imgObj.img, en.x, en.y, en.w, en.h);
      else { ctx.fillStyle="#f00"; ctx.fillRect(en.x,en.y,en.w,en.h); }
    }
    ctx.restore();
  });

  // ã‚­ãƒ£ãƒ©ï¼ˆæºã‚Œ/æ²ˆã‚€ï¼‰
ã€€ã€€let px = player.x;
ã€€ã€€let py = player.y;

// æºã‚Œ
ã€€if(t < shakeUntil) px += (Math.random()*8 - 4);

// æ²ˆã‚€
ã€€if(t < sinkUntil){
  ã€€const p = 1 - (sinkUntil - t) / 650;
  ã€€py += p * 220;
}

ã€€ã€€const playerKey = MODE[mode].playerKey;

// è„ˆå‹•ï¼ˆâ€»ã‚„ã‚‹ãªã‚‰ã“ã®1å›ã ã‘ï¼‰
ã€€ã€€const scale = 1 + Math.sin(t * 0.015) * 0.05;
ã€€ã€€const cx = px + player.w/2;
ã€€ã€€const cy = py + player.h/2;

ã€€ã€€ctx.save();
ã€€ã€€ctx.translate(cx, cy);
ã€€ã€€ctx.scale(scale, scale);
ã€€ã€€ctx.translate(-cx, -cy);

ã€€if(I[playerKey]?.ok){
  ã€€ctx.drawImage(I[playerKey].img, px, py, player.w, player.h);
}

ã€€ã€€ctx.restore();





  // ğŸ˜ã‚¬ãƒ¼ãƒ‰ãƒªãƒ³ã‚°
  if(mode==="mm" && shieldUntilHit){
    ctx.save();
    ctx.globalAlpha = 0.8;
    ctx.strokeStyle = "rgba(255,165,0,.95)";
    ctx.lineWidth = 6;
    ctx.beginPath();
    ctx.arc(px + player.w/2, py + player.h/2, 44, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();
  }

  // ğŸš§æ˜Ÿãã‚‹ãã‚‹
  if(t < starsUntil){
    const centerX = px + player.w/2;
    const centerY = py + player.h/2;
    starsAngle += 0.22;
    const r = 44;
    for(let k=0; k<5; k++){
      const a = starsAngle + k*(Math.PI*2/5);
      const sx = centerX + Math.cos(a)*r;
      const sy = centerY + Math.sin(a)*r;
      ctx.save();
      ctx.translate(sx, sy);
      ctx.rotate(a);
      ctx.globalAlpha = 0.9;
      drawStar(ctx, 0, 0, 5, 10, 5);
      ctx.restore();
    }
  }

  // +1ãƒãƒƒãƒ—
popups.forEach(p=>{

  ctx.save();

  const alpha = p.life / 40;
  const scale = 1 + (1 - alpha) * 0.4; // å°‘ã—å¤§ãããªã‚‹æ¼”å‡º

  ctx.globalAlpha = alpha;

  ctx.translate(p.x, p.y);
  ctx.scale(scale, scale);

  // â­ æ–‡å­—å¤§ãã
  ctx.font = "bold 28px sans-serif";
  ctx.textAlign = "center";

  // â­ é»’ãµã¡ï¼ˆè¶…é‡è¦ï¼‰
  ctx.lineWidth = 5;
  ctx.strokeStyle = "#000";
  ctx.strokeText(p.text, 0, 0);

  // â­ ç™½æ–‡å­—
  ctx.fillStyle = "#fff";
  ctx.fillText(p.text, 0, 0);

  ctx.restore();
});


// â­ ãƒ†ãƒ­ãƒƒãƒ—è¡¨ç¤ºï¼ˆPC=ä¸Š / ã‚¹ãƒãƒ›=ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ä¸Šï¼‰
if(t < comment.until && comment.text){

  ctx.save();

  let boxY;
  let textY;

  // â­ ã‚¹ãƒãƒ› â†’ ã‚¸ãƒ£ãƒ³ãƒ—ãƒœã‚¿ãƒ³ã®ä¸Šã«è¡¨ç¤º
  if(isMobile() && jumpBtnRect){

    boxY = jumpBtnRect.y - 40; // â† ãƒœã‚¿ãƒ³ã¨ã®è·é›¢ï¼ˆèª¿æ•´OKï¼‰
    textY = boxY + 25;

  }else{
    // â­ PC â†’ ä»Šã¾ã§ã¨åŒã˜ä½ç½®
    boxY = 120;
    textY = 145;
  }

  // èƒŒæ™¯ãƒãƒ¼
  ctx.globalAlpha = 0.85;
  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fillRect(0, boxY, canvas.width, 40);

  // ãƒ†ã‚­ã‚¹ãƒˆ
  ctx.fillStyle = "#fff";
  ctx.font = "bold 16px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText(comment.text, canvas.width/2, textY);

  ctx.restore();
}


  // â­â­â­ JUMPãƒœã‚¿ãƒ³ï¼ˆPCï¼‹ã‚¹ãƒãƒ›ï¼‰
if(I.ui_jump && I.ui_jump.ok){


// â­ ã‚­ãƒ£ãƒ©åŸºæº–ã®åœ°é¢
const playerGroundY = groundY + PLAYER_GROUND_OFFSET;

// â­ åœ°é¢ä¸‹ã‚¹ãƒšãƒ¼ã‚¹
const groundSpace = canvas.height - playerGroundY;

// â­ ã‚µã‚¤ã‚ºå…ˆã«ä½œã‚‹ï¼ˆâ†è¶…é‡è¦ï¼‰
const btnH = groundSpace * 0.55;
const btnW = canvas.width * (isMobile() ? 0.75 : 0.35);
const btnX = (canvas.width - btnW) / 2;

// â­ ä¸‹ã«ãšã‚‰ã™é‡
const offsetY = isMobile() ? 60 : 40;

// â­ Yåº§æ¨™ï¼ˆæœ€å¾Œã«è¨ˆç®—ï¼‰
const btnY = playerGroundY + (groundSpace - btnH) / 2 + offsetY;

ctx.globalAlpha = 0.95;
const pressing = performance.now() < jumpBtnPressUntil;
const scale = pressing ? 0.92 : 1; // â†æŠ¼ã—ãŸã‚‰å°ã•ã

ctx.save();

ctx.translate(btnX + btnW/2, btnY + btnH/2);
ctx.scale(scale, scale);
ctx.translate(-btnW/2, -btnH/2);

ctx.drawImage(I.ui_jump.img, 0, 0, btnW, btnH);

ctx.restore();

ctx.globalAlpha = 1;

jumpBtnRect = { x: btnX, y: btnY, w: btnW, h: btnH };


// =======================
// â­ å³ä¸ŠUIï¼ˆã‚¿ã‚¤ãƒ ï¼‹ã‚¹ã‚³ã‚¢ï¼‰
// =======================
ctx.save();

ctx.textAlign = "right";
ctx.textBaseline = "top";

ctx.font = "bold 42px system-ui";
ctx.fillStyle = "#fff";
ctx.strokeStyle = "rgba(0,0,0,0.4)";
ctx.lineWidth = 6;

const remainMs = GAME_MS - (Date.now() - startAt);
const sec = Math.max(0, remainMs / 1000).toFixed(1);

ctx.strokeText(`TIME ${sec}`, canvas.width - 20, 20);
ctx.fillText(`TIME ${sec}`, canvas.width - 20, 20);

ctx.font = "bold 28px system-ui";
ctx.strokeText(`SCORE ${score}`, canvas.width - 20, 70);
ctx.fillText(`SCORE ${score}`, canvas.width - 20, 70);

ctx.restore();


}
}


function drawFallbackText(msg){
  ctx.save();
  ctx.fillStyle="#111";
  ctx.font="bold 18px sans-serif";
  ctx.fillText(msg, 40, 80);
  ctx.font="14px sans-serif";
  ctx.fillText("ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å†ç¢ºèªã—ã¦ã€index.htmlã¨åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ã„ã¦ã­", 40, 110);
  ctx.restore();
}

function drawStar(ctx, x, y, spikes, outerRadius, innerRadius){
  let rot = Math.PI / 2 * 3;
  let step = Math.PI / spikes;
  ctx.beginPath();
  ctx.moveTo(x, y - outerRadius);
  for(let i=0; i<spikes; i++){
    ctx.lineTo(x + Math.cos(rot) * outerRadius, y + Math.sin(rot) * outerRadius);
    rot += step;
    ctx.lineTo(x + Math.cos(rot) * innerRadius, y + Math.sin(rot) * innerRadius);
    rot += step;
  }
  ctx.lineTo(x, y - outerRadius);
  ctx.closePath();
  ctx.fillStyle = "rgba(255, 200, 0, .95)";
  ctx.strokeStyle = "rgba(255, 140, 0, .95)";
  ctx.lineWidth = 2;
  ctx.fill(); ctx.stroke();
}

function roundRect(ctx, x, y, w, h, r){
  r = Math.min(r, w/2, h/2);
  if(ctx.roundRect){
    ctx.beginPath();
    ctx.roundRect(x, y, w, h, r);
    return;
  }
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
}


let lastTime = 0;

/* =========================================================
  10) æç”»ãƒ«ãƒ¼ãƒ—ï¼ˆå¸¸æ™‚ï¼‰
========================================================= */
function drawFrame(time){
  // â­ FPSå·®ã‚’ãªãã™ï¼ˆè¶…é‡è¦ï¼‰
if(!lastTime) lastTime = time;
const delta = (time - lastTime) / 16.67;
lastTime = time;

  if(state===STATE.SOUND || state===STATE.COURSE || state===STATE.START || state===STATE.END){
    drawUI();
    requestAnimationFrame(drawFrame);
    return;
  }

  if(state===STATE.GAME){
    if(running) update(delta);
    drawGame();
    requestAnimationFrame(drawFrame);
    return;
  }

  requestAnimationFrame(drawFrame);
}

/* =========================================================
  11) èµ·å‹•ï¼šç”»åƒãƒ­ãƒ¼ãƒ‰
========================================================= */
async function boot(){
  const uiKeys = Object.keys(UI_SRC);
  const uiLoaded = await Promise.all(uiKeys.map(k=>loadOneImage(UI_SRC[k])));
  uiKeys.forEach((k,idx)=>UI[k]=uiLoaded[idx]);

  const keys = Object.keys(ASSET);
  const loaded = await Promise.all(keys.map(k => loadOneImage(ASSET[k])));
  keys.forEach((k, idx)=>{ I[k] = loaded[idx]; });

  loadingEl.style.display = "none";
requestAnimationFrame(drawFrame);
}

// =========================
// â­ ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³æç”»ï¼ˆã“ã“è¿½åŠ ï¼‰
// =========================
function drawShareBtn(x,y,color,label){

  const w = 64;
  const h = 64;

  // ãƒœã‚¿ãƒ³èƒŒæ™¯
  ctx.fillStyle = color;
  roundRect(ctx, x, y, w, h, 20);
  ctx.fill();

  // ã‚¢ã‚¤ã‚³ãƒ³å–å¾—
  const icon =
    label === "X" ? I.share_x :
    label === "LINE" ? I.share_line : null;

  // ä¸­å¤®é…ç½®
if(icon && icon.ok){

  const iconSize = label === "LINE" ? 50 : 36;

  const ix = x + (w - iconSize) / 2;
  const iy = y + (h - iconSize) / 2;

  ctx.drawImage(icon.img, ix, iy, iconSize, iconSize);
}

}

boot();


function popHP(){} 

</script>
</body>
</html>
